{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 10, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from \"@supabase/ssr\"\r\nimport { cookies } from \"next/headers\"\r\n\r\nexport async function createClient() {\r\n  const cookieStore = await cookies()\r\n\r\n  return createServerClient(\r\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n    {\r\n      cookies: {\r\n        getAll() {\r\n          return cookieStore.getAll()\r\n        },\r\n        setAll(cookiesToSet) {\r\n          try {\r\n            cookiesToSet.forEach(({ name, value, options }) => cookieStore.set(name, value, options))\r\n          } catch {\r\n            // The \"setAll\" method was called from a Server Component.\r\n            // This can be ignored if you have middleware refreshing user sessions.\r\n          }\r\n        },\r\n      },\r\n    },\r\n  )\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;AAAA;;;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,sLAAO;IAEjC,OAAO,IAAA,uMAAkB,sUAGvB;QACE,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAAK,YAAY,GAAG,CAAC,MAAM,OAAO;gBAClF,EAAE,OAAM;gBACN,0DAA0D;gBAC1D,uEAAuE;gBACzE;YACF;QACF;IACF;AAEJ"}},
    {"offset": {"line": 42, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/app/actions/rewardActions.ts"],"sourcesContent":["\"use server\";\r\n\r\nimport { createClient } from \"@/lib/supabase/server\";\r\nimport { revalidatePath } from \"next/cache\";\r\n\r\ntype ActionType = 'login' | 'video_watch' | 'lesson_completion' | 'quiz_completion' | 'module_completion' | 'referral' | 'bonus' | 'mission_complete';\r\n\r\nconst REWARD_RULES = {\r\n    login: { coins: 5, limit: 1 },\r\n    video_watch: { coins: 10, limit: 10 },\r\n    lesson_completion: { coins: 10, limit: 20 }, // Generic lesson completion\r\n    quiz_completion: { coins: 15, limit: 10 },\r\n    quiz_bonus: { coins: 10, limit: 10 },\r\n    module_completion: { coins: 50, limit: 5 },\r\n    referral: { coins: 100, limit: 10 },\r\n    streak_3: { coins: 10, limit: 1 },\r\n    streak_7: { coins: 30, limit: 1 },\r\n    streak_30: { coins: 100, limit: 1 },\r\n    mission_complete: { coins: 20, limit: 3 }\r\n};\r\n\r\nconst DAILY_COIN_CAP = 100;\r\n\r\nexport async function getRewardStatus(userId: string) {\r\n    const supabase = await createClient();\r\n    let { data } = await supabase\r\n        .from(\"user_rewards\")\r\n        .select(\"*\")\r\n        .eq(\"user_id\", userId)\r\n        .single();\r\n\r\n    if (!data) {\r\n        // Initialize if not exists\r\n        const { data: newData, error } = await supabase\r\n            .from(\"user_rewards\")\r\n            .insert({ user_id: userId })\r\n            .select()\r\n            .single();\r\n\r\n        if (error) {\r\n            if (error.code === '23505') {\r\n                const { data: retryData } = await supabase\r\n                    .from(\"user_rewards\")\r\n                    .select(\"*\")\r\n                    .eq(\"user_id\", userId)\r\n                    .single();\r\n                data = retryData;\r\n            } else {\r\n                console.error(\"Error creating user_rewards in getRewardStatus:\", error);\r\n                return null;\r\n            }\r\n        } else {\r\n            data = newData;\r\n        }\r\n    }\r\n\r\n    return data;\r\n}\r\n\r\nexport async function checkStreak(userId: string) {\r\n    const supabase = await createClient();\r\n\r\n    // Just fetch the current status to display to the user\r\n    // The actual update happens when 'login' reward is awarded below\r\n    const { data: rewardStatus } = await supabase\r\n        .from(\"user_rewards\")\r\n        .select(\"current_streak, longest_streak, last_activity_date\")\r\n        .eq(\"user_id\", userId)\r\n        .single();\r\n\r\n    if (!rewardStatus) return { streak: 0, message: null };\r\n\r\n    // We can infer if they are on a streak or if it's broken based on the date,\r\n    // but primarily we just want to show the current value.\r\n    // The DB trigger updates this immediately upon the 'login' transaction insertion.\r\n\r\n    return {\r\n        streak: rewardStatus.current_streak,\r\n        message: null\r\n    };\r\n}\r\n\r\nexport async function awardCoins(\r\n    userId: string,\r\n    action: ActionType,\r\n    entityId?: string,\r\n    description?: string\r\n) {\r\n    const supabase = await createClient();\r\n    const today = new Date().toISOString().split('T')[0];\r\n\r\n    // 1. Check strict duplicate rules (Client-Side Protection)\r\n    // We don't want to spam the DB trigger with 'login' events every refresh\r\n    if (action === 'login') {\r\n        entityId = today; // Force entityId to be date for login\r\n    }\r\n\r\n    if (entityId) {\r\n        const { data: existing } = await supabase\r\n            .from(\"reward_transactions\")\r\n            .select(\"id\")\r\n            .eq(\"user_id\", userId)\r\n            .eq(\"action_type\", action)\r\n            .eq(\"entity_id\", entityId)\r\n            .gte(\"created_at\", `${today}T00:00:00`)\r\n            .single();\r\n\r\n        if (existing) {\r\n            return { success: false, message: \"Already rewarded for this today!\" };\r\n        }\r\n    }\r\n\r\n    // 2. Define Amount (We still define it here to pass to DB, or DB could handle default)\r\n    let coins = 0;\r\n    switch (action) {\r\n        case 'login': coins = REWARD_RULES.login.coins; break;\r\n        case 'video_watch': coins = REWARD_RULES.video_watch.coins; break;\r\n        case 'lesson_completion': coins = REWARD_RULES.lesson_completion.coins; break;\r\n        case 'quiz_completion': coins = REWARD_RULES.quiz_completion.coins; break;\r\n        case 'module_completion': coins = REWARD_RULES.module_completion.coins; break;\r\n        case 'referral': coins = REWARD_RULES.referral.coins; break;\r\n        case 'mission_complete': coins = REWARD_RULES.mission_complete.coins; break;\r\n        case 'bonus': coins = 10; break;\r\n        default: coins = 0;\r\n    }\r\n\r\n    // 3. Insert Transaction (The DB Trigger takes it from here!)\r\n    // It will: Update Coins, XP, Level, and Streak (if login)\r\n    const { error } = await supabase.from(\"reward_transactions\").insert({\r\n        user_id: userId,\r\n        amount: coins,\r\n        action_type: action,\r\n        entity_id: entityId,\r\n        description: description || `Reward for ${action}`\r\n    });\r\n\r\n    if (error) {\r\n        console.error(\"Reward Insert Error:\", error);\r\n        return { success: false, message: \"Failed to process reward.\" };\r\n    }\r\n\r\n    // 4. Post-Process (Optional Notifications or Revalidation)\r\n    revalidatePath(\"/student\");\r\n\r\n    if (action === 'login') {\r\n        // Special message for login\r\n        return { success: true, coins, message: \"Daily Reward Claimed!\" };\r\n    }\r\n\r\n    return { success: true, coins, message: `â­ +${coins} coins!` };\r\n}\r\n\r\nexport async function getLeaderboard(type: 'weekly' | 'all_time' = 'all_time', limit: number = 10) {\r\n    const supabase = await createClient();\r\n\r\n    const sortColumn = type === 'weekly' ? 'weekly_xp' : 'total_coins'; // or xp\r\n\r\n    const { data } = await supabase\r\n        .from(\"user_rewards\")\r\n        .select(`\r\n            total_coins,\r\n            xp,\r\n            weekly_xp,\r\n            level,\r\n            current_streak,\r\n            user_id,\r\n            profiles:user_id (\r\n                full_name,\r\n                avatar_url\r\n            )\r\n        `)\r\n        .order(sortColumn, { ascending: false })\r\n        .limit(limit);\r\n\r\n    return data?.map((entry: any) => ({\r\n        ...entry,\r\n        profiles: Array.isArray(entry.profiles) ? entry.profiles[0] : entry.profiles\r\n    })) || [];\r\n}\r\n\r\nexport async function checkModuleCompletion(userId: string, moduleId: string) {\r\n    const supabase = await createClient();\r\n    const { data: lessons } = await supabase.from(\"lessons\").select(\"id\").eq(\"module_id\", moduleId);\r\n    if (!lessons || lessons.length === 0) return;\r\n\r\n    const { data: completed } = await supabase\r\n        .from(\"lesson_progress\")\r\n        .select(\"lesson_id\")\r\n        .eq(\"user_id\", userId)\r\n        .eq(\"completed\", true)\r\n        .in(\"lesson_id\", lessons.map(l => l.id));\r\n\r\n    const completedCount = completed?.length || 0;\r\n    if (completedCount === lessons.length) {\r\n        return await awardCoins(userId, 'module_completion', moduleId, 'Completed a module!');\r\n    }\r\n    return null;\r\n}\r\n\r\nexport async function checkFirstLessonReward(userId: string) {\r\n    const supabase = await createClient();\r\n    const { count } = await supabase\r\n        .from(\"lesson_progress\")\r\n        .select(\"*\", { count: 'exact', head: true })\r\n        .eq(\"user_id\", userId)\r\n        .eq(\"completed\", true);\r\n\r\n    if (count !== 1) return;\r\n\r\n    const { data: profile } = await supabase\r\n        .from(\"profiles\")\r\n        .select(\"referred_by\")\r\n        .eq(\"id\", userId)\r\n        .single();\r\n\r\n    if (!profile?.referred_by) return;\r\n\r\n    const referrerId = profile.referred_by;\r\n    const { data: existing } = await supabase\r\n        .from(\"reward_transactions\")\r\n        .select(\"*\")\r\n        .eq(\"user_id\", referrerId)\r\n        .eq(\"action_type\", 'referral')\r\n        .eq(\"entity_id\", userId)\r\n        .single();\r\n\r\n    if (existing) return;\r\n\r\n    // Award referrer\r\n    await awardCoins(referrerId, 'referral', userId, `Referral bonus for user ${userId}`);\r\n\r\n    // Check Badge for Referrer\r\n    await checkBadgeUnlock(referrerId, 'social_butterfly');\r\n}\r\n\r\n// --- NEW GAMIFICATION FUNCTIONS ---\r\n\r\nexport async function getDailyMissions(userId: string) {\r\n    const supabase = await createClient();\r\n\r\n    // Use RPC function to get or create missions\r\n    const { data, error } = await supabase.rpc('get_or_create_daily_missions', {\r\n        p_user_id: userId\r\n    });\r\n\r\n    if (error) {\r\n        console.error(\"Error fetching daily missions:\", error);\r\n        return [];\r\n    }\r\n\r\n    return data || [];\r\n}\r\n\r\n\r\nexport async function updateMissionProgress(userId: string, type: 'login' | 'quiz' | 'video') {\r\n    const supabase = await createClient();\r\n\r\n    // Use RPC function to update mission progress\r\n    const { data, error } = await supabase.rpc('update_mission_progress', {\r\n        p_user_id: userId,\r\n        p_mission_type: type\r\n    });\r\n\r\n    if (error) {\r\n        console.error(\"Error updating mission progress:\", error);\r\n        return;\r\n    }\r\n\r\n    // Check if any mission was completed\r\n    const missions = data || [];\r\n    const completedMission = missions.find((m: any) =>\r\n        m.id === type && m.completed && m.progress === m.goal\r\n    );\r\n\r\n    if (completedMission) {\r\n        // Award mission bonus\r\n        const today = new Date().toISOString().split('T')[0];\r\n        await awardCoins(userId, 'mission_complete', `${today}-${type}`, `Mission Complete: ${completedMission.title}`);\r\n    }\r\n\r\n    revalidatePath(\"/student\");\r\n}\r\n\r\n\r\nexport async function checkBadgeUnlock(userId: string, badgeId: string) {\r\n    const supabase = await createClient();\r\n\r\n    // Check if already has badge\r\n    const { data: existing } = await supabase\r\n        .from(\"user_badges\")\r\n        .select(\"*\")\r\n        .eq(\"user_id\", userId)\r\n        .eq(\"badge_id\", badgeId)\r\n        .single();\r\n\r\n    if (existing) return;\r\n\r\n    // Logic to verify if they actually earned it could go here, \r\n    // but usually we call this function when we KNOW they met the condition.\r\n\r\n    await supabase.from(\"user_badges\").insert({\r\n        user_id: userId,\r\n        badge_id: badgeId\r\n    });\r\n\r\n    // Could return a notification object\r\n}\r\n\r\nexport async function getUserBadges(userId: string) {\r\n    const supabase = await createClient();\r\n    const { data } = await supabase\r\n        .from(\"user_badges\")\r\n        .select(\"badge_id, earned_at\")\r\n        .eq(\"user_id\", userId);\r\n    return data || [];\r\n}\r\n\r\nexport async function getStreakHistory(userId: string) {\r\n    const supabase = await createClient();\r\n\r\n    // Fetch dates from reward_transactions\r\n    const { data } = await supabase\r\n        .from(\"reward_transactions\")\r\n        .select(\"created_at\")\r\n        .eq(\"user_id\", userId)\r\n        .order(\"created_at\", { ascending: false });\r\n\r\n    if (!data) return [];\r\n\r\n    // Extract unique dates (YYYY-MM-DD)\r\n    const uniqueDates = new Set(\r\n        data.map(item => item.created_at.split('T')[0])\r\n    );\r\n\r\n    return Array.from(uniqueDates);\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 380, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/actions/checkEnrollmentStatus.ts"],"sourcesContent":["// ============================================================================\r\n// ENROLLMENT STATUS & EXPIRY CHECK\r\n// Server actions to check enrollment status and expiry\r\n// ============================================================================\r\n\r\n'use server';\r\n\r\nimport { createClient } from '@/lib/supabase/server';\r\n\r\nexport interface EnrollmentStatus {\r\n    hasAccess: boolean;\r\n    status: 'active' | 'expired' | 'none';\r\n    expiresAt: string | null;\r\n    daysRemaining: number | null;\r\n    isExpiringSoon: boolean;\r\n    isExpired: boolean;\r\n}\r\n\r\n/**\r\n * Check if student has active course access\r\n */\r\nexport async function checkCourseAccess(courseId: string): Promise<EnrollmentStatus> {\r\n    const supabase = await createClient();\r\n\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n\r\n    if (!user) {\r\n        return {\r\n            hasAccess: false,\r\n            status: 'none',\r\n            expiresAt: null,\r\n            daysRemaining: null,\r\n            isExpiringSoon: false,\r\n            isExpired: false\r\n        };\r\n    }\r\n\r\n    try {\r\n        // Get enrollment with expiry info\r\n        const { data: enrollment } = await supabase\r\n            .from('enrollments')\r\n            .select('status, expires_at')\r\n            .eq('user_id', user.id)\r\n            .eq('course_id', courseId)\r\n            .single();\r\n\r\n        if (!enrollment) {\r\n            return {\r\n                hasAccess: false,\r\n                status: 'none',\r\n                expiresAt: null,\r\n                daysRemaining: null,\r\n                isExpiringSoon: false,\r\n                isExpired: false\r\n            };\r\n        }\r\n\r\n        const now = new Date();\r\n        const expiryDate = enrollment.expires_at ? new Date(enrollment.expires_at) : null;\r\n\r\n        let daysRemaining = null;\r\n        let isExpired = false;\r\n        let isExpiringSoon = false;\r\n        let hasAccess = false;\r\n\r\n        if (expiryDate) {\r\n            const diffTime = expiryDate.getTime() - now.getTime();\r\n            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));\r\n\r\n            daysRemaining = diffDays;\r\n            isExpired = diffDays < 0;\r\n            isExpiringSoon = diffDays > 0 && diffDays <= 7;\r\n            hasAccess = enrollment.status === 'active' && !isExpired;\r\n        } else {\r\n            // Lifetime access\r\n            hasAccess = enrollment.status === 'active';\r\n        }\r\n\r\n        return {\r\n            hasAccess,\r\n            status: isExpired ? 'expired' : enrollment.status as any,\r\n            expiresAt: enrollment.expires_at,\r\n            daysRemaining,\r\n            isExpiringSoon,\r\n            isExpired\r\n        };\r\n    } catch (error) {\r\n        console.error('Error checking course access:', error);\r\n        return {\r\n            hasAccess: false,\r\n            status: 'none',\r\n            expiresAt: null,\r\n            daysRemaining: null,\r\n            isExpiringSoon: false,\r\n            isExpired: false\r\n        };\r\n    }\r\n}\r\n\r\n/**\r\n * Get all user's enrollments with expiry status\r\n */\r\nexport async function getUserEnrollmentsWithExpiry() {\r\n    const supabase = await createClient();\r\n\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) return { enrollments: [] };\r\n\r\n    try {\r\n        const { data: enrollments } = await supabase\r\n            .from('enrollments')\r\n            .select(`\r\n        *,\r\n        courses (\r\n          id,\r\n          title,\r\n          thumbnail_url,\r\n          price\r\n        )\r\n      `)\r\n            .eq('user_id', user.id);\r\n\r\n        // Process each enrollment to check expiry status\r\n        const processedEnrollments = enrollments?.map(enrollment => {\r\n            const now = new Date();\r\n            const expiryDate = enrollment.expires_at ? new Date(enrollment.expires_at) : null;\r\n\r\n            let daysRemaining = null;\r\n            let isExpired = false;\r\n            let isExpiringSoon = false;\r\n            let urgencyLevel: 'CRITICAL' | 'HIGH' | 'MEDIUM' | 'LOW' | null = null;\r\n\r\n            if (expiryDate) {\r\n                const diffTime = expiryDate.getTime() - now.getTime();\r\n                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));\r\n\r\n                daysRemaining = diffDays;\r\n                isExpired = diffDays < 0;\r\n                isExpiringSoon = diffDays > 0 && diffDays <= 15; // Show badge for 15 days or less\r\n\r\n                if (diffDays <= 1 && diffDays > 0) urgencyLevel = 'CRITICAL';\r\n                else if (diffDays <= 3 && diffDays > 0) urgencyLevel = 'HIGH';\r\n                else if (diffDays <= 7 && diffDays > 0) urgencyLevel = 'MEDIUM';\r\n                else if (diffDays > 7 && diffDays <= 15) urgencyLevel = 'LOW'; // Show up to 15 days\r\n            }\r\n\r\n            return {\r\n                ...enrollment,\r\n                daysRemaining,\r\n                isExpired,\r\n                isExpiringSoon,\r\n                urgencyLevel,\r\n                hasAccess: enrollment.status === 'active' && !isExpired\r\n            };\r\n        }) || [];\r\n\r\n        return { enrollments: processedEnrollments };\r\n    } catch (error) {\r\n        console.error('Error fetching enrollments:', error);\r\n        return { enrollments: [] };\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 524, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/.next-internal/server/app/student/rewards/page/actions.js (server actions loader)"],"sourcesContent":["export {awardCoins as '780d64f65fac54c55def49046d2a33becf7ac8e4bd'} from 'ACTIONS_MODULE0'\nexport {updateMissionProgress as '6062a646126ab86278ff8a9f9d5dd9c2cf55fa2b68'} from 'ACTIONS_MODULE0'\nexport {getRewardStatus as '40d59f95dc89fd4dc26cbfaa1a6ee2c66ddc89d104'} from 'ACTIONS_MODULE0'\nexport {getDailyMissions as '409b6c9e7f7aeea92b23738c3b0bc90cec78ddfab0'} from 'ACTIONS_MODULE0'\nexport {getUserBadges as '401af75fb501836c067ff5309414f33ff8ec6d523c'} from 'ACTIONS_MODULE0'\nexport {getLeaderboard as '606f53d15fe31c1858c290384edc7b7c0fb1e457e8'} from 'ACTIONS_MODULE0'\nexport {checkStreak as '406ef9d617799bcd1e0cc901a06585cccfd9ea3b5e'} from 'ACTIONS_MODULE0'\nexport {getStreakHistory as '40b0b14b03ca8c026611963a00d913cf1f9512bae9'} from 'ACTIONS_MODULE0'\nexport {getUserEnrollmentsWithExpiry as '00f84ea184b6b74ed81e5f0c8bfe6fc5466e4716b1'} from 'ACTIONS_MODULE1'\n"],"names":[],"mappings":";AAAA;AAQA"}}]
}