{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 10, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from \"@supabase/ssr\"\r\nimport { cookies } from \"next/headers\"\r\n\r\nexport async function createClient() {\r\n  const cookieStore = await cookies()\r\n\r\n  return createServerClient(\r\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n    {\r\n      cookies: {\r\n        getAll() {\r\n          return cookieStore.getAll()\r\n        },\r\n        setAll(cookiesToSet) {\r\n          try {\r\n            cookiesToSet.forEach(({ name, value, options }) => cookieStore.set(name, value, options))\r\n          } catch {\r\n            // The \"setAll\" method was called from a Server Component.\r\n            // This can be ignored if you have middleware refreshing user sessions.\r\n          }\r\n        },\r\n      },\r\n    },\r\n  )\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;AAAA;;;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,sLAAO;IAEjC,OAAO,IAAA,uMAAkB,sUAGvB;QACE,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAAK,YAAY,GAAG,CAAC,MAAM,OAAO;gBAClF,EAAE,OAAM;gBACN,0DAA0D;gBAC1D,uEAAuE;gBACzE;YACF;QACF;IACF;AAEJ"}},
    {"offset": {"line": 42, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/app/actions/rewardActions.ts"],"sourcesContent":["\"use server\";\r\n\r\nimport { createClient } from \"@/lib/supabase/server\";\r\nimport { revalidatePath } from \"next/cache\";\r\n\r\ntype ActionType = 'login' | 'video_watch' | 'lesson_completion' | 'quiz_completion' | 'module_completion' | 'referral' | 'bonus' | 'mission_complete';\r\n\r\nconst REWARD_RULES = {\r\n    login: { coins: 5, limit: 1 },\r\n    video_watch: { coins: 10, limit: 10 },\r\n    lesson_completion: { coins: 10, limit: 20 }, // Generic lesson completion\r\n    quiz_completion: { coins: 15, limit: 10 },\r\n    quiz_bonus: { coins: 10, limit: 10 },\r\n    module_completion: { coins: 50, limit: 5 },\r\n    referral: { coins: 100, limit: 10 },\r\n    streak_3: { coins: 10, limit: 1 },\r\n    streak_7: { coins: 30, limit: 1 },\r\n    streak_30: { coins: 100, limit: 1 },\r\n    mission_complete: { coins: 20, limit: 3 }\r\n};\r\n\r\nconst DAILY_COIN_CAP = 100;\r\n\r\nexport async function getRewardStatus(userId: string) {\r\n    const supabase = await createClient();\r\n    let { data } = await supabase\r\n        .from(\"user_rewards\")\r\n        .select(\"*\")\r\n        .eq(\"user_id\", userId)\r\n        .single();\r\n\r\n    if (!data) {\r\n        // Initialize if not exists\r\n        const { data: newData, error } = await supabase\r\n            .from(\"user_rewards\")\r\n            .insert({ user_id: userId })\r\n            .select()\r\n            .single();\r\n\r\n        if (error) {\r\n            if (error.code === '23505') {\r\n                const { data: retryData } = await supabase\r\n                    .from(\"user_rewards\")\r\n                    .select(\"*\")\r\n                    .eq(\"user_id\", userId)\r\n                    .single();\r\n                data = retryData;\r\n            } else {\r\n                console.error(\"Error creating user_rewards in getRewardStatus:\", error);\r\n                return null;\r\n            }\r\n        } else {\r\n            data = newData;\r\n        }\r\n    }\r\n\r\n    return data;\r\n}\r\n\r\nexport async function checkStreak(userId: string) {\r\n    const supabase = await createClient();\r\n\r\n    // Just fetch the current status to display to the user\r\n    // The actual update happens when 'login' reward is awarded below\r\n    const { data: rewardStatus } = await supabase\r\n        .from(\"user_rewards\")\r\n        .select(\"current_streak, longest_streak, last_activity_date\")\r\n        .eq(\"user_id\", userId)\r\n        .single();\r\n\r\n    if (!rewardStatus) return { streak: 0, message: null };\r\n\r\n    // We can infer if they are on a streak or if it's broken based on the date,\r\n    // but primarily we just want to show the current value.\r\n    // The DB trigger updates this immediately upon the 'login' transaction insertion.\r\n\r\n    return {\r\n        streak: rewardStatus.current_streak,\r\n        message: null\r\n    };\r\n}\r\n\r\nexport async function awardCoins(\r\n    userId: string,\r\n    action: ActionType,\r\n    entityId?: string,\r\n    description?: string\r\n) {\r\n    const supabase = await createClient();\r\n    const today = new Date().toISOString().split('T')[0];\r\n\r\n    // 1. Check strict duplicate rules (Client-Side Protection)\r\n    // We don't want to spam the DB trigger with 'login' events every refresh\r\n    if (action === 'login') {\r\n        entityId = today; // Force entityId to be date for login\r\n    }\r\n\r\n    if (entityId) {\r\n        const { data: existing } = await supabase\r\n            .from(\"reward_transactions\")\r\n            .select(\"id\")\r\n            .eq(\"user_id\", userId)\r\n            .eq(\"action_type\", action)\r\n            .eq(\"entity_id\", entityId)\r\n            .gte(\"created_at\", `${today}T00:00:00`)\r\n            .single();\r\n\r\n        if (existing) {\r\n            return { success: false, message: \"Already rewarded for this today!\" };\r\n        }\r\n    }\r\n\r\n    // 2. Define Amount (We still define it here to pass to DB, or DB could handle default)\r\n    let coins = 0;\r\n    switch (action) {\r\n        case 'login': coins = REWARD_RULES.login.coins; break;\r\n        case 'video_watch': coins = REWARD_RULES.video_watch.coins; break;\r\n        case 'lesson_completion': coins = REWARD_RULES.lesson_completion.coins; break;\r\n        case 'quiz_completion': coins = REWARD_RULES.quiz_completion.coins; break;\r\n        case 'module_completion': coins = REWARD_RULES.module_completion.coins; break;\r\n        case 'referral': coins = REWARD_RULES.referral.coins; break;\r\n        case 'mission_complete': coins = REWARD_RULES.mission_complete.coins; break;\r\n        case 'bonus': coins = 10; break;\r\n        default: coins = 0;\r\n    }\r\n\r\n    // 3. Insert Transaction (The DB Trigger takes it from here!)\r\n    // It will: Update Coins, XP, Level, and Streak (if login)\r\n    const { error } = await supabase.from(\"reward_transactions\").insert({\r\n        user_id: userId,\r\n        amount: coins,\r\n        action_type: action,\r\n        entity_id: entityId,\r\n        description: description || `Reward for ${action}`\r\n    });\r\n\r\n    if (error) {\r\n        console.error(\"Reward Insert Error:\", error);\r\n        return { success: false, message: \"Failed to process reward.\" };\r\n    }\r\n\r\n    // 4. Post-Process (Optional Notifications or Revalidation)\r\n    revalidatePath(\"/student\");\r\n\r\n    if (action === 'login') {\r\n        // Special message for login\r\n        return { success: true, coins, message: \"Daily Reward Claimed!\" };\r\n    }\r\n\r\n    return { success: true, coins, message: `⭐ +${coins} coins!` };\r\n}\r\n\r\nexport async function getLeaderboard(type: 'weekly' | 'all_time' = 'all_time', limit: number = 10) {\r\n    const supabase = await createClient();\r\n\r\n    const sortColumn = type === 'weekly' ? 'weekly_xp' : 'total_coins'; // or xp\r\n\r\n    const { data } = await supabase\r\n        .from(\"user_rewards\")\r\n        .select(`\r\n            total_coins,\r\n            xp,\r\n            weekly_xp,\r\n            level,\r\n            current_streak,\r\n            user_id,\r\n            profiles:user_id (\r\n                full_name,\r\n                avatar_url\r\n            )\r\n        `)\r\n        .order(sortColumn, { ascending: false })\r\n        .limit(limit);\r\n\r\n    return data?.map((entry: any) => ({\r\n        ...entry,\r\n        profiles: Array.isArray(entry.profiles) ? entry.profiles[0] : entry.profiles\r\n    })) || [];\r\n}\r\n\r\nexport async function checkModuleCompletion(userId: string, moduleId: string) {\r\n    const supabase = await createClient();\r\n    const { data: lessons } = await supabase.from(\"lessons\").select(\"id\").eq(\"module_id\", moduleId);\r\n    if (!lessons || lessons.length === 0) return;\r\n\r\n    const { data: completed } = await supabase\r\n        .from(\"lesson_progress\")\r\n        .select(\"lesson_id\")\r\n        .eq(\"user_id\", userId)\r\n        .eq(\"completed\", true)\r\n        .in(\"lesson_id\", lessons.map(l => l.id));\r\n\r\n    const completedCount = completed?.length || 0;\r\n    if (completedCount === lessons.length) {\r\n        return await awardCoins(userId, 'module_completion', moduleId, 'Completed a module!');\r\n    }\r\n    return null;\r\n}\r\n\r\nexport async function checkFirstLessonReward(userId: string) {\r\n    const supabase = await createClient();\r\n    const { count } = await supabase\r\n        .from(\"lesson_progress\")\r\n        .select(\"*\", { count: 'exact', head: true })\r\n        .eq(\"user_id\", userId)\r\n        .eq(\"completed\", true);\r\n\r\n    if (count !== 1) return;\r\n\r\n    const { data: profile } = await supabase\r\n        .from(\"profiles\")\r\n        .select(\"referred_by\")\r\n        .eq(\"id\", userId)\r\n        .single();\r\n\r\n    if (!profile?.referred_by) return;\r\n\r\n    const referrerId = profile.referred_by;\r\n    const { data: existing } = await supabase\r\n        .from(\"reward_transactions\")\r\n        .select(\"*\")\r\n        .eq(\"user_id\", referrerId)\r\n        .eq(\"action_type\", 'referral')\r\n        .eq(\"entity_id\", userId)\r\n        .single();\r\n\r\n    if (existing) return;\r\n\r\n    // Award referrer\r\n    await awardCoins(referrerId, 'referral', userId, `Referral bonus for user ${userId}`);\r\n\r\n    // Check Badge for Referrer\r\n    await checkBadgeUnlock(referrerId, 'social_butterfly');\r\n}\r\n\r\n// --- NEW GAMIFICATION FUNCTIONS ---\r\n\r\nexport async function getDailyMissions(userId: string) {\r\n    const supabase = await createClient();\r\n\r\n    // Use RPC function to get or create missions\r\n    const { data, error } = await supabase.rpc('get_or_create_daily_missions', {\r\n        p_user_id: userId\r\n    });\r\n\r\n    if (error) {\r\n        console.error(\"Error fetching daily missions:\", error);\r\n        return [];\r\n    }\r\n\r\n    return data || [];\r\n}\r\n\r\n\r\nexport async function updateMissionProgress(userId: string, type: 'login' | 'quiz' | 'video') {\r\n    const supabase = await createClient();\r\n\r\n    // Use RPC function to update mission progress\r\n    const { data, error } = await supabase.rpc('update_mission_progress', {\r\n        p_user_id: userId,\r\n        p_mission_type: type\r\n    });\r\n\r\n    if (error) {\r\n        console.error(\"Error updating mission progress:\", error);\r\n        return;\r\n    }\r\n\r\n    // Check if any mission was completed\r\n    const missions = data || [];\r\n    const completedMission = missions.find((m: any) =>\r\n        m.id === type && m.completed && m.progress === m.goal\r\n    );\r\n\r\n    if (completedMission) {\r\n        // Award mission bonus\r\n        const today = new Date().toISOString().split('T')[0];\r\n        await awardCoins(userId, 'mission_complete', `${today}-${type}`, `Mission Complete: ${completedMission.title}`);\r\n    }\r\n\r\n    revalidatePath(\"/student\");\r\n}\r\n\r\n\r\nexport async function checkBadgeUnlock(userId: string, badgeId: string) {\r\n    const supabase = await createClient();\r\n\r\n    // Check if already has badge\r\n    const { data: existing } = await supabase\r\n        .from(\"user_badges\")\r\n        .select(\"*\")\r\n        .eq(\"user_id\", userId)\r\n        .eq(\"badge_id\", badgeId)\r\n        .single();\r\n\r\n    if (existing) return;\r\n\r\n    // Logic to verify if they actually earned it could go here, \r\n    // but usually we call this function when we KNOW they met the condition.\r\n\r\n    await supabase.from(\"user_badges\").insert({\r\n        user_id: userId,\r\n        badge_id: badgeId\r\n    });\r\n\r\n    // Could return a notification object\r\n}\r\n\r\nexport async function getUserBadges(userId: string) {\r\n    const supabase = await createClient();\r\n    const { data } = await supabase\r\n        .from(\"user_badges\")\r\n        .select(\"badge_id, earned_at\")\r\n        .eq(\"user_id\", userId);\r\n    return data || [];\r\n}\r\n\r\nexport async function getStreakHistory(userId: string) {\r\n    const supabase = await createClient();\r\n\r\n    // Fetch dates from reward_transactions\r\n    const { data } = await supabase\r\n        .from(\"reward_transactions\")\r\n        .select(\"created_at\")\r\n        .eq(\"user_id\", userId)\r\n        .order(\"created_at\", { ascending: false });\r\n\r\n    if (!data) return [];\r\n\r\n    // Extract unique dates (YYYY-MM-DD)\r\n    const uniqueDates = new Set(\r\n        data.map(item => item.created_at.split('T')[0])\r\n    );\r\n\r\n    return Array.from(uniqueDates);\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 380, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/lib/supabase/admin.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js'\r\n\r\nexport const createAdminClient = () => {\r\n    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!\r\n    const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!\r\n\r\n    if (!supabaseServiceKey) {\r\n        throw new Error('SUPABASE_SERVICE_ROLE_KEY environment variable is not defined. Please check your .env.local file.')\r\n    }\r\n\r\n    return createClient(supabaseUrl, supabaseServiceKey, {\r\n        auth: {\r\n            autoRefreshToken: false,\r\n            persistSession: false\r\n        }\r\n    })\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAEO,MAAM,oBAAoB;IAC7B,MAAM;IACN,MAAM,qBAAqB,QAAQ,GAAG,CAAC,yBAAyB;IAEhE,IAAI,CAAC,oBAAoB;QACrB,MAAM,IAAI,MAAM;IACpB;IAEA,OAAO,IAAA,+LAAY,EAAC,aAAa,oBAAoB;QACjD,MAAM;YACF,kBAAkB;YAClB,gBAAgB;QACpB;IACJ;AACJ"}},
    {"offset": {"line": 403, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/actions/admin/students.ts"],"sourcesContent":["'use server';\r\n\r\nimport { createClient } from '@/lib/supabase/server';\r\nimport { createAdminClient } from '@/lib/supabase/admin';\r\nimport { revalidatePath } from 'next/cache';\r\n\r\n/**\r\n * Add a new student manually (admin only)\r\n * Returns student info if already exists, or creates an invitation\r\n */\r\nexport async function addStudent(data: {\r\n    email: string;\r\n    fullName: string;\r\n    sendInvite?: boolean;\r\n}) {\r\n    const supabase = await createClient();\r\n\r\n    // Check admin permission\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) return { error: 'Unauthorized' };\r\n\r\n    const { data: profile } = await supabase\r\n        .from('profiles')\r\n        .select('role')\r\n        .eq('id', user.id)\r\n        .single();\r\n\r\n    if (profile?.role !== 'admin') {\r\n        return { error: 'Admin access required' };\r\n    }\r\n\r\n    try {\r\n        // Check if student already exists in profiles\r\n        const { data: existing } = await supabase\r\n            .from('profiles')\r\n            .select('id, email, full_name')\r\n            .eq('email', data.email)\r\n            .single();\r\n\r\n        if (existing) {\r\n            return {\r\n                success: true,\r\n                data: existing,\r\n                message: 'Student already exists in the system'\r\n            };\r\n        }\r\n\r\n        // Send invitation email using Supabase Admin\r\n        if (data.sendInvite) {\r\n            const adminClient = createAdminClient();\r\n\r\n            // Invite user via Supabase Auth\r\n            const { data: inviteData, error: inviteError } = await adminClient.auth.admin.inviteUserByEmail(\r\n                data.email,\r\n                {\r\n                    data: {\r\n                        full_name: data.fullName,\r\n                        role: 'student'\r\n                    },\r\n                    redirectTo: `${process.env.NEXT_PUBLIC_SITE_URL || 'http://localhost:3000'}/auth/callback`\r\n                }\r\n            );\r\n\r\n            if (inviteError) {\r\n                console.error('Invitation error:', inviteError);\r\n                throw new Error(`Failed to send invitation: ${inviteError.message}`);\r\n            }\r\n\r\n            console.log(`✅ Invitation sent to ${data.email}`, inviteData);\r\n\r\n            // Create profile entry for the invited user\r\n            if (inviteData.user) {\r\n                const { error: profileError } = await adminClient\r\n                    .from('profiles')\r\n                    .insert({\r\n                        id: inviteData.user.id,\r\n                        email: data.email,\r\n                        full_name: data.fullName,\r\n                        role: 'student'\r\n                    });\r\n\r\n                if (profileError) {\r\n                    console.error('Profile creation error:', profileError);\r\n                    // Don't fail the whole operation if profile creation fails\r\n                    // The profile will be created on first login via callback\r\n                }\r\n            }\r\n\r\n            revalidatePath('/admin/students');\r\n            return {\r\n                success: true,\r\n                data: { email: data.email, full_name: data.fullName },\r\n                message: 'Invitation sent successfully! Student will receive an email to join.'\r\n            };\r\n        }\r\n\r\n        // If not sending invite, just return success\r\n        revalidatePath('/admin/students');\r\n        return {\r\n            success: true,\r\n            data: { email: data.email, full_name: data.fullName },\r\n            message: 'Student information saved. They can sign up normally.'\r\n        };\r\n    } catch (error: any) {\r\n        console.error('Add student error:', error);\r\n        return { error: error.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Search students by name or email\r\n */\r\nexport async function searchStudents(query: string) {\r\n    const supabase = await createClient();\r\n\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) return { error: 'Unauthorized' };\r\n\r\n    try {\r\n        const { data, error } = await supabase\r\n            .from('profiles')\r\n            .select('id, email, full_name, avatar_url, created_at')\r\n            .eq('role', 'student')\r\n            .or(`full_name.ilike.%${query}%,email.ilike.%${query}%`)\r\n            .order('full_name', { ascending: true })\r\n            .limit(20);\r\n\r\n        if (error) throw error;\r\n\r\n        return { success: true, data };\r\n    } catch (error: any) {\r\n        return { error: error.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Get all students with their enrollments and expiry info\r\n */\r\nexport async function getStudentsWithEnrollments(filters?: {\r\n    status?: 'all' | 'active' | 'expired';\r\n    expiringWithinDays?: number;\r\n}) {\r\n    const supabase = await createClient();\r\n\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) return { error: 'Unauthorized' };\r\n\r\n    try {\r\n        // Get all students\r\n        const { data: students, error: studentsError } = await supabase\r\n            .from('profiles')\r\n            .select(`\r\n        id,\r\n        email,\r\n        full_name,\r\n        avatar_url,\r\n        created_at\r\n      `)\r\n            .eq('role', 'student')\r\n            .order('created_at', { ascending: false });\r\n\r\n        if (studentsError) throw studentsError;\r\n\r\n        // Get enrollments for each student\r\n        const { data: enrollments, error: enrollmentsError } = await supabase\r\n            .from('enrollments')\r\n            .select(`\r\n        id,\r\n        user_id,\r\n        course_id,\r\n        status,\r\n        expires_at,\r\n        granted_by,\r\n        grant_type,\r\n        courses (\r\n          id,\r\n          title,\r\n          thumbnail_url\r\n        )\r\n      `);\r\n\r\n        if (enrollmentsError) throw enrollmentsError;\r\n\r\n\r\n\r\n        // Combine data\r\n        const studentsWithEnrollments = students?.map(student => {\r\n            const courseEnrollments = enrollments?.filter(e => e.user_id === student.id) || [];\r\n\r\n            // Check expiry status\r\n            const now = new Date();\r\n            const expiringSoon = courseEnrollments.filter(e => {\r\n                if (!e.expires_at) return false;\r\n                const expiryDate = new Date(e.expires_at);\r\n                const daysUntilExpiry = (expiryDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24);\r\n                return daysUntilExpiry > 0 && daysUntilExpiry <= (filters?.expiringWithinDays || 7);\r\n            });\r\n\r\n            return {\r\n                ...student,\r\n                enrollments: courseEnrollments,\r\n                totalEnrollments: courseEnrollments.length,\r\n                expiringSoonCount: expiringSoon.length\r\n            };\r\n        });\r\n\r\n        // Apply filters\r\n        let filtered = studentsWithEnrollments;\r\n        if (filters?.status === 'active') {\r\n            filtered = filtered?.filter(s => s.totalEnrollments > 0);\r\n        } else if (filters?.status === 'expired') {\r\n            filtered = filtered?.filter(s => {\r\n                const hasExpired = (s.enrollments || []).some(e => {\r\n                    if (!e.expires_at) return false;\r\n                    return new Date(e.expires_at) < new Date();\r\n                });\r\n                return hasExpired;\r\n            });\r\n        }\r\n\r\n        return { success: true, data: filtered };\r\n    } catch (error: any) {\r\n        return { error: error.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Get exam attempts for a specific student\r\n */\r\nexport async function getStudentAttempts(userId: string) {\r\n    const supabase = createAdminClient();\r\n\r\n    try {\r\n        const { data: rawData, error } = await supabase\r\n            .from('exam_attempts')\r\n            .select(`\r\n                *,\r\n                exams (\r\n                    id,\r\n                    title,\r\n                    total_marks\r\n                ),\r\n                results (*)\r\n            `)\r\n            .eq('student_id', userId)\r\n            .order('created_at', { ascending: false });\r\n\r\n        if (error) throw error;\r\n\r\n        // Flatten results\r\n        const data = rawData?.map(att => ({\r\n            ...att,\r\n            results: Array.isArray(att.results) ? att.results[0] : att.results\r\n        })) || [];\r\n\r\n        return { success: true, data };\r\n    } catch (error: any) {\r\n        return { error: error.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Get detailed info for a single student with stats\r\n */\r\nexport async function getStudentDetails(userId: string) {\r\n    try {\r\n        const supabase = createAdminClient();\r\n\r\n        // Get student profile\r\n        const { data: student, error: studentError } = await supabase\r\n            .from('profiles')\r\n            .select('*')\r\n            .eq('id', userId)\r\n            .single();\r\n\r\n        if (studentError) {\r\n            console.error('Student fetch error:', studentError);\r\n            throw new Error(`Failed to fetch student profile: ${studentError.message}`);\r\n        }\r\n\r\n        if (!student) {\r\n            return { error: 'Student not found' };\r\n        }\r\n\r\n        // Get active sessions count\r\n        // Note: Accessing auth schema may require special permissions\r\n        let activeSessions = 0;\r\n        try {\r\n            const { count, error: sessionsError } = await supabase\r\n                .schema('auth')\r\n                .from('sessions')\r\n                .select('*', { count: 'exact', head: true })\r\n                .eq('user_id', userId);\r\n\r\n            if (sessionsError) {\r\n                console.error('Session count error:', sessionsError);\r\n            } else {\r\n                activeSessions = count || 0;\r\n            }\r\n        } catch (err) {\r\n            console.error('Failed to fetch session count:', err);\r\n            // Fallback: activeSessions remains 0\r\n        }\r\n\r\n        // Get enrollments\r\n        const { data: enrollments, error: enrollmentsError } = await supabase\r\n            .from('enrollments')\r\n            .select(`\r\n                *,\r\n                courses (\r\n                    id,\r\n                    title,\r\n                    thumbnail_url,\r\n                    price,\r\n                    course_type\r\n                ),\r\n                granted_by_profile:profiles!enrollments_granted_by_fkey (\r\n                    id,\r\n                    full_name\r\n                )\r\n            `)\r\n            .eq('user_id', userId);\r\n\r\n        if (enrollmentsError) {\r\n            console.error('Enrollments fetch error:', enrollmentsError);\r\n            // Don't throw, just log and continue with empty array\r\n        }\r\n\r\n\r\n\r\n        const { data: rawAttempts, error: attemptsError } = await supabase\r\n            .from('exam_attempts')\r\n            .select(`\r\n                *,\r\n                exams (id, title, total_marks),\r\n                results (percentage, obtained_marks)\r\n            `)\r\n            .eq('student_id', userId)\r\n            .order('created_at', { ascending: false });\r\n\r\n        if (attemptsError) {\r\n            console.error('Exam attempts fetch error:', attemptsError);\r\n            // Don't throw, just log and continue with empty array\r\n        }\r\n\r\n        // Transform attempts to handle singular results object\r\n        const attempts = rawAttempts?.map(att => ({\r\n            ...att,\r\n            results: Array.isArray(att.results) ? att.results[0] : att.results\r\n        })) || [];\r\n\r\n        // Get enrollment logs\r\n        const enrollmentIds = enrollments?.map(e => e.id) || [];\r\n\r\n        let logs: any[] = [];\r\n        if (enrollmentIds.length > 0) {\r\n            const { data: logData, error: logsError } = await supabase\r\n                .from('enrollment_logs')\r\n                .select(`\r\n                    *,\r\n                    performed_by_profile:profiles!enrollment_logs_performed_by_fkey (\r\n                        id,\r\n                        full_name\r\n                    )\r\n                `)\r\n                .in('enrollment_id', enrollmentIds)\r\n                .order('created_at', { ascending: false })\r\n                .limit(50);\r\n\r\n            if (logsError) {\r\n                console.error('Enrollment logs fetch error:', logsError);\r\n                // Don't throw, just log and continue with empty array\r\n            } else {\r\n                logs = logData || [];\r\n            }\r\n        }\r\n\r\n        // Calculate Stats\r\n        const submittedAttempts = attempts.filter(a => a.status === 'submitted');\r\n        const avgPercentage = submittedAttempts.length > 0\r\n            ? submittedAttempts.reduce((acc, curr) => acc + (curr.results?.percentage || 0), 0) / submittedAttempts.length\r\n            : 0;\r\n\r\n        return {\r\n            success: true,\r\n            data: {\r\n                student,\r\n                enrollments: enrollments || [],\r\n                attempts: attempts || [],\r\n                logs,\r\n                activeSessions,\r\n                stats: {\r\n                    totalEnrollments: enrollments?.length || 0,\r\n                    totalAttempts: attempts?.length || 0,\r\n                    avgPercentage: Math.round(avgPercentage * 10) / 10\r\n                }\r\n            }\r\n        };\r\n    } catch (error: any) {\r\n        console.error('getStudentDetails error:', error);\r\n        return { error: error?.message || 'An unexpected error occurred while fetching student details' };\r\n    }\r\n}\r\n\r\n/**\r\n * Reset all active sessions for a student (admin only)\r\n */\r\nexport async function resetStudentSessions(userId: string) {\r\n    const supabase = createAdminClient();\r\n\r\n    try {\r\n        // Delete all sessions for this user\r\n        const { error: sessionError } = await supabase\r\n            .schema('auth')\r\n            .from('sessions')\r\n            .delete()\r\n            .eq('user_id', userId);\r\n\r\n        if (sessionError) throw sessionError;\r\n\r\n        // Also delete refresh tokens to ensure they can't get a new session\r\n        const { error: tokenError } = await supabase\r\n            .schema('auth')\r\n            .from('refresh_tokens')\r\n            .delete()\r\n            .eq('user_id', userId);\r\n\r\n        // Note: tokenError might happen if they have no tokens, we can be lenient or log it\r\n\r\n        revalidatePath(`/admin/students/${userId}`);\r\n        return { success: true, message: 'All active sessions have been reset' };\r\n    } catch (error: any) {\r\n        console.error('Reset sessions error:', error);\r\n        return { error: error.message };\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 784, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/actions/admin/grantAccess.ts"],"sourcesContent":["'use server';\r\n\r\nimport { createClient } from '@/lib/supabase/server';\r\nimport { revalidatePath } from 'next/cache';\r\n\r\n/**\r\n * Grant course access to a student with optional expiry\r\n */\r\nexport async function grantCourseAccess(data: {\r\n    userId: string;\r\n    courseId: string;\r\n    expiresAt?: Date | null;\r\n    notes?: string;\r\n}) {\r\n    const supabase = await createClient();\r\n\r\n    // Get admin user\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) return { error: 'Unauthorized' };\r\n\r\n    const { data: profile } = await supabase\r\n        .from('profiles')\r\n        .select('role')\r\n        .eq('id', user.id)\r\n        .single();\r\n\r\n    if (profile?.role !== 'admin') {\r\n        return { error: 'Admin access required' };\r\n    }\r\n\r\n    try {\r\n        // Check if enrollment already exists\r\n        const { data: existing } = await supabase\r\n            .from('enrollments')\r\n            .select('id, status, expires_at')\r\n            .eq('user_id', data.userId)\r\n            .eq('course_id', data.courseId)\r\n            .single();\r\n\r\n        let enrollment;\r\n\r\n        if (existing) {\r\n            // Update existing enrollment\r\n            const { data: updated, error } = await supabase\r\n                .from('enrollments')\r\n                .update({\r\n                    status: 'active',\r\n                    expires_at: data.expiresAt || null,\r\n                    granted_by: user.id,\r\n                    granted_at: new Date().toISOString(),\r\n                    grant_type: 'manual'\r\n                })\r\n                .eq('id', existing.id)\r\n                .select()\r\n                .single();\r\n\r\n            if (error) throw error;\r\n            enrollment = updated;\r\n\r\n            // Log the modification\r\n            await supabase.rpc('log_enrollment_action', {\r\n                p_action: 'modified',\r\n                p_performed_by: user.id,\r\n                p_enrollment_id: existing.id,\r\n                p_previous_expiry: existing.expires_at,\r\n                p_new_expiry: data.expiresAt || null,\r\n                p_notes: data.notes || 'Access modified by admin'\r\n            });\r\n        } else {\r\n            // Create new enrollment\r\n            const { data: newEnrollment, error } = await supabase\r\n                .from('enrollments')\r\n                .insert({\r\n                    user_id: data.userId,\r\n                    course_id: data.courseId,\r\n                    status: 'active',\r\n                    expires_at: data.expiresAt || null,\r\n                    granted_by: user.id,\r\n                    granted_at: new Date().toISOString(),\r\n                    grant_type: 'manual'\r\n                })\r\n                .select()\r\n                .single();\r\n\r\n            if (error) throw error;\r\n            enrollment = newEnrollment;\r\n\r\n            // Log the grant\r\n            await supabase.rpc('log_enrollment_action', {\r\n                p_action: 'granted',\r\n                p_performed_by: user.id,\r\n                p_enrollment_id: newEnrollment.id,\r\n                p_new_expiry: data.expiresAt || null,\r\n                p_notes: data.notes || 'Access granted by admin'\r\n            });\r\n        }\r\n\r\n        revalidatePath('/admin/students');\r\n        return { success: true, data: enrollment };\r\n    } catch (error: any) {\r\n        return { error: error.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Grant test series access to a student\r\n */\r\nexport async function grantTestSeriesAccess(data: {\r\n    userId: string;\r\n    testSeriesId: string;\r\n    expiresAt?: Date | null;\r\n    notes?: string;\r\n}) {\r\n    const supabase = await createClient();\r\n\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) return { error: 'Unauthorized' };\r\n\r\n    const { data: profile } = await supabase\r\n        .from('profiles')\r\n        .select('role')\r\n        .eq('id', user.id)\r\n        .single();\r\n\r\n    if (profile?.role !== 'admin') {\r\n        return { error: 'Admin access required' };\r\n    }\r\n\r\n    try {\r\n        // Check if enrollment already exists\r\n        const { data: existing } = await supabase\r\n            .from('enrollments')\r\n            .select('id, expires_at')\r\n            .eq('user_id', data.userId)\r\n            .eq('course_id', data.testSeriesId)\r\n            .single();\r\n\r\n        let enrollment;\r\n\r\n        if (existing) {\r\n            // Update existing\r\n            const { data: updated, error } = await supabase\r\n                .from('enrollments')\r\n                .update({\r\n                    expires_at: data.expiresAt || null,\r\n                    granted_by: user.id,\r\n                    granted_at: new Date().toISOString(),\r\n                    grant_type: 'manual'\r\n                })\r\n                .eq('id', existing.id)\r\n                .select()\r\n                .single();\r\n\r\n            if (error) throw error;\r\n            enrollment = updated;\r\n\r\n            // Log\r\n            await supabase.rpc('log_enrollment_action', {\r\n                p_action: 'modified',\r\n                p_performed_by: user.id,\r\n                p_enrollment_id: existing.id,\r\n                p_previous_expiry: existing.expires_at,\r\n                p_new_expiry: data.expiresAt || null,\r\n                p_notes: data.notes || 'Test series access modified'\r\n            });\r\n        } else {\r\n            // Create new\r\n            const { data: newEnrollment, error } = await supabase\r\n                .from('enrollments')\r\n                .insert({\r\n                    user_id: data.userId,\r\n                    course_id: data.testSeriesId,\r\n                    expires_at: data.expiresAt || null,\r\n                    granted_by: user.id,\r\n                    granted_at: new Date().toISOString(),\r\n                    grant_type: 'manual',\r\n                    status: 'active'\r\n                })\r\n                .select()\r\n                .single();\r\n\r\n            if (error) throw error;\r\n            enrollment = newEnrollment;\r\n\r\n            // Log\r\n            await supabase.rpc('log_enrollment_action', {\r\n                p_action: 'granted',\r\n                p_performed_by: user.id,\r\n                p_enrollment_id: newEnrollment.id,\r\n                p_new_expiry: data.expiresAt || null,\r\n                p_notes: data.notes || 'Test series access granted'\r\n            });\r\n        }\r\n\r\n        revalidatePath('/admin/students');\r\n        return { success: true, data: enrollment };\r\n    } catch (error: any) {\r\n        return { error: error.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Revoke course or test series access\r\n */\r\nexport async function revokeAccess(data: {\r\n    enrollmentId: string;\r\n    type: 'course';\r\n    reason: string;\r\n}) {\r\n    const supabase = await createClient();\r\n\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) return { error: 'Unauthorized' };\r\n\r\n    try {\r\n        if (data.type === 'course') {\r\n            const { error } = await supabase\r\n                .from('enrollments')\r\n                .update({ status: 'refunded' }) // Using 'refunded' to indicate revoked\r\n                .eq('id', data.enrollmentId);\r\n\r\n            if (error) throw error;\r\n\r\n            // Log\r\n            await supabase.rpc('log_enrollment_action', {\r\n                p_action: 'revoked',\r\n                p_performed_by: user.id,\r\n                p_enrollment_id: data.enrollmentId,\r\n                p_notes: data.reason\r\n            });\r\n        } else {\r\n            const { error } = await supabase\r\n                .from('enrollments')\r\n                .update({ status: 'refunded' })\r\n                .eq('id', data.enrollmentId);\r\n\r\n            if (error) throw error;\r\n\r\n            // Log\r\n            await supabase.rpc('log_enrollment_action', {\r\n                p_action: 'revoked',\r\n                p_performed_by: user.id,\r\n                p_enrollment_id: data.enrollmentId,\r\n                p_notes: data.reason\r\n            });\r\n        }\r\n\r\n        revalidatePath('/admin/students');\r\n        return { success: true };\r\n    } catch (error: any) {\r\n        return { error: error.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Extend access expiry date\r\n */\r\nexport async function extendAccess(data: {\r\n    enrollmentId: string;\r\n    type: 'course';\r\n    newExpiryDate: Date;\r\n    notes?: string;\r\n}) {\r\n    const supabase = await createClient();\r\n\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) return { error: 'Unauthorized' };\r\n\r\n    console.log('[extendAccess] Starting update:', {\r\n        enrollmentId: data.enrollmentId,\r\n        type: data.type,\r\n        newExpiryDate: data.newExpiryDate,\r\n        isoDate: data.newExpiryDate.toISOString()\r\n    });\r\n\r\n    try {\r\n        let previousExpiry;\r\n        let updateError;\r\n\r\n        if (data.type === 'course') {\r\n            // Get current enrollment\r\n            const { data: existing, error: fetchError } = await supabase\r\n                .from('enrollments')\r\n                .select('expires_at, user_id')\r\n                .eq('id', data.enrollmentId)\r\n                .single();\r\n\r\n            if (fetchError) {\r\n                console.error('[extendAccess] Error fetching enrollment:', fetchError);\r\n                throw new Error(`Failed to find enrollment: ${fetchError.message}`);\r\n            }\r\n\r\n            console.log('[extendAccess] Current enrollment:', existing);\r\n            previousExpiry = existing?.expires_at;\r\n\r\n            // Update the expiry date\r\n            const { data: updated, error } = await supabase\r\n                .from('enrollments')\r\n                .update({\r\n                    expires_at: data.newExpiryDate.toISOString(),\r\n                    updated_at: new Date().toISOString()\r\n                })\r\n                .eq('id', data.enrollmentId)\r\n                .select();\r\n\r\n            updateError = error;\r\n            console.log('[extendAccess] Update result:', { updated, error });\r\n\r\n            if (error) throw error;\r\n\r\n            if (!updated || updated.length === 0) {\r\n                throw new Error('No rows were updated. Enrollment may not exist.');\r\n            }\r\n\r\n            // Verify the update\r\n            const { data: verified } = await supabase\r\n                .from('enrollments')\r\n                .select('expires_at')\r\n                .eq('id', data.enrollmentId)\r\n                .single();\r\n\r\n            console.log('[extendAccess] Verified expiry after update:', verified);\r\n\r\n            if (!verified?.expires_at) {\r\n                throw new Error('Update succeeded but expires_at is still null');\r\n            }\r\n\r\n            // Log the action\r\n            await supabase.rpc('log_enrollment_action', {\r\n                p_action: 'extended',\r\n                p_performed_by: user.id,\r\n                p_enrollment_id: data.enrollmentId,\r\n                p_previous_expiry: previousExpiry,\r\n                p_new_expiry: data.newExpiryDate.toISOString(),\r\n                p_notes: data.notes || 'Access period extended'\r\n            });\r\n        } else {\r\n            // Test series enrollment\r\n            const { data: existing, error: fetchError } = await supabase\r\n                .from('enrollments')\r\n                .select('expires_at, user_id')\r\n                .eq('id', data.enrollmentId)\r\n                .single();\r\n\r\n            if (fetchError) {\r\n                console.error('[extendAccess] Error fetching test series enrollment:', fetchError);\r\n                throw new Error(`Failed to find test series enrollment: ${fetchError.message}`);\r\n            }\r\n\r\n            console.log('[extendAccess] Current test series enrollment:', existing);\r\n            previousExpiry = existing?.expires_at;\r\n\r\n            const { data: updated, error } = await supabase\r\n                .from('enrollments')\r\n                .update({\r\n                    expires_at: data.newExpiryDate.toISOString(),\r\n                    updated_at: new Date().toISOString()\r\n                })\r\n                .eq('id', data.enrollmentId)\r\n                .select();\r\n\r\n            updateError = error;\r\n            console.log('[extendAccess] Test series update result:', { updated, error });\r\n\r\n            if (error) throw error;\r\n\r\n            if (!updated || updated.length === 0) {\r\n                throw new Error('No rows were updated. Test series enrollment may not exist.');\r\n            }\r\n\r\n            // Verify the update\r\n            const { data: verified } = await supabase\r\n                .from('enrollments')\r\n                .select('expires_at')\r\n                .eq('id', data.enrollmentId)\r\n                .single();\r\n\r\n            console.log('[extendAccess] Verified test series expiry after update:', verified);\r\n\r\n            if (!verified?.expires_at) {\r\n                throw new Error('Update succeeded but expires_at is still null');\r\n            }\r\n\r\n            // Log the action\r\n            await supabase.rpc('log_enrollment_action', {\r\n                p_action: 'extended',\r\n                p_performed_by: user.id,\r\n                p_enrollment_id: data.enrollmentId,\r\n                p_previous_expiry: previousExpiry,\r\n                p_new_expiry: data.newExpiryDate.toISOString(),\r\n                p_notes: data.notes || 'Access period extended'\r\n            });\r\n        }\r\n\r\n        console.log('[extendAccess] Update completed successfully');\r\n        revalidatePath('/admin/students');\r\n        return { success: true };\r\n    } catch (error: any) {\r\n        console.error('[extendAccess] Error:', error);\r\n        return { error: error.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Get expiring subscriptions (within specified days)\r\n */\r\nexport async function getExpiringSubscriptions(daysAhead: number = 7) {\r\n    const supabase = await createClient();\r\n\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) return { error: 'Unauthorized' };\r\n\r\n    try {\r\n        const { data, error } = await supabase\r\n            .from('expiring_enrollments_view')\r\n            .select('*')\r\n            .lte('days_until_expiry', daysAhead)\r\n            .order('days_until_expiry', { ascending: true });\r\n\r\n        if (error) throw error;\r\n\r\n        return { success: true, data };\r\n    } catch (error: any) {\r\n        return { error: error.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Get recent enrollment logs\r\n */\r\nexport async function getRecentAccessLogs(limit: number = 50) {\r\n    const supabase = await createClient();\r\n\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) return { error: 'Unauthorized' };\r\n\r\n    try {\r\n        const { data, error } = await supabase\r\n            .from('enrollment_logs')\r\n            .select(`\r\n        *,\r\n        performed_by_profile:profiles!enrollment_logs_performed_by_fkey (\r\n          id,\r\n          full_name,\r\n          email\r\n        )\r\n      `)\r\n            .order('created_at', { ascending: false })\r\n            .limit(limit);\r\n\r\n        if (error) throw error;\r\n\r\n        return { success: true, data };\r\n    } catch (error: any) {\r\n        return { error: error.message };\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;AAEA;AACA;;;;;AAKO,eAAe,kBAAkB,IAKvC;IACG,MAAM,WAAW,MAAM,IAAA,iJAAY;IAEnC,iBAAiB;IACjB,MAAM,EAAE,MAAM,EAAE,IAAI,EAAE,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;IACtD,IAAI,CAAC,MAAM,OAAO;QAAE,OAAO;IAAe;IAE1C,MAAM,EAAE,MAAM,OAAO,EAAE,GAAG,MAAM,SAC3B,IAAI,CAAC,YACL,MAAM,CAAC,QACP,EAAE,CAAC,MAAM,KAAK,EAAE,EAChB,MAAM;IAEX,IAAI,SAAS,SAAS,SAAS;QAC3B,OAAO;YAAE,OAAO;QAAwB;IAC5C;IAEA,IAAI;QACA,qCAAqC;QACrC,MAAM,EAAE,MAAM,QAAQ,EAAE,GAAG,MAAM,SAC5B,IAAI,CAAC,eACL,MAAM,CAAC,0BACP,EAAE,CAAC,WAAW,KAAK,MAAM,EACzB,EAAE,CAAC,aAAa,KAAK,QAAQ,EAC7B,MAAM;QAEX,IAAI;QAEJ,IAAI,UAAU;YACV,6BAA6B;YAC7B,MAAM,EAAE,MAAM,OAAO,EAAE,KAAK,EAAE,GAAG,MAAM,SAClC,IAAI,CAAC,eACL,MAAM,CAAC;gBACJ,QAAQ;gBACR,YAAY,KAAK,SAAS,IAAI;gBAC9B,YAAY,KAAK,EAAE;gBACnB,YAAY,IAAI,OAAO,WAAW;gBAClC,YAAY;YAChB,GACC,EAAE,CAAC,MAAM,SAAS,EAAE,EACpB,MAAM,GACN,MAAM;YAEX,IAAI,OAAO,MAAM;YACjB,aAAa;YAEb,uBAAuB;YACvB,MAAM,SAAS,GAAG,CAAC,yBAAyB;gBACxC,UAAU;gBACV,gBAAgB,KAAK,EAAE;gBACvB,iBAAiB,SAAS,EAAE;gBAC5B,mBAAmB,SAAS,UAAU;gBACtC,cAAc,KAAK,SAAS,IAAI;gBAChC,SAAS,KAAK,KAAK,IAAI;YAC3B;QACJ,OAAO;YACH,wBAAwB;YACxB,MAAM,EAAE,MAAM,aAAa,EAAE,KAAK,EAAE,GAAG,MAAM,SACxC,IAAI,CAAC,eACL,MAAM,CAAC;gBACJ,SAAS,KAAK,MAAM;gBACpB,WAAW,KAAK,QAAQ;gBACxB,QAAQ;gBACR,YAAY,KAAK,SAAS,IAAI;gBAC9B,YAAY,KAAK,EAAE;gBACnB,YAAY,IAAI,OAAO,WAAW;gBAClC,YAAY;YAChB,GACC,MAAM,GACN,MAAM;YAEX,IAAI,OAAO,MAAM;YACjB,aAAa;YAEb,gBAAgB;YAChB,MAAM,SAAS,GAAG,CAAC,yBAAyB;gBACxC,UAAU;gBACV,gBAAgB,KAAK,EAAE;gBACvB,iBAAiB,cAAc,EAAE;gBACjC,cAAc,KAAK,SAAS,IAAI;gBAChC,SAAS,KAAK,KAAK,IAAI;YAC3B;QACJ;QAEA,IAAA,uJAAc,EAAC;QACf,OAAO;YAAE,SAAS;YAAM,MAAM;QAAW;IAC7C,EAAE,OAAO,OAAY;QACjB,OAAO;YAAE,OAAO,MAAM,OAAO;QAAC;IAClC;AACJ;AAKO,eAAe,sBAAsB,IAK3C;IACG,MAAM,WAAW,MAAM,IAAA,iJAAY;IAEnC,MAAM,EAAE,MAAM,EAAE,IAAI,EAAE,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;IACtD,IAAI,CAAC,MAAM,OAAO;QAAE,OAAO;IAAe;IAE1C,MAAM,EAAE,MAAM,OAAO,EAAE,GAAG,MAAM,SAC3B,IAAI,CAAC,YACL,MAAM,CAAC,QACP,EAAE,CAAC,MAAM,KAAK,EAAE,EAChB,MAAM;IAEX,IAAI,SAAS,SAAS,SAAS;QAC3B,OAAO;YAAE,OAAO;QAAwB;IAC5C;IAEA,IAAI;QACA,qCAAqC;QACrC,MAAM,EAAE,MAAM,QAAQ,EAAE,GAAG,MAAM,SAC5B,IAAI,CAAC,eACL,MAAM,CAAC,kBACP,EAAE,CAAC,WAAW,KAAK,MAAM,EACzB,EAAE,CAAC,aAAa,KAAK,YAAY,EACjC,MAAM;QAEX,IAAI;QAEJ,IAAI,UAAU;YACV,kBAAkB;YAClB,MAAM,EAAE,MAAM,OAAO,EAAE,KAAK,EAAE,GAAG,MAAM,SAClC,IAAI,CAAC,eACL,MAAM,CAAC;gBACJ,YAAY,KAAK,SAAS,IAAI;gBAC9B,YAAY,KAAK,EAAE;gBACnB,YAAY,IAAI,OAAO,WAAW;gBAClC,YAAY;YAChB,GACC,EAAE,CAAC,MAAM,SAAS,EAAE,EACpB,MAAM,GACN,MAAM;YAEX,IAAI,OAAO,MAAM;YACjB,aAAa;YAEb,MAAM;YACN,MAAM,SAAS,GAAG,CAAC,yBAAyB;gBACxC,UAAU;gBACV,gBAAgB,KAAK,EAAE;gBACvB,iBAAiB,SAAS,EAAE;gBAC5B,mBAAmB,SAAS,UAAU;gBACtC,cAAc,KAAK,SAAS,IAAI;gBAChC,SAAS,KAAK,KAAK,IAAI;YAC3B;QACJ,OAAO;YACH,aAAa;YACb,MAAM,EAAE,MAAM,aAAa,EAAE,KAAK,EAAE,GAAG,MAAM,SACxC,IAAI,CAAC,eACL,MAAM,CAAC;gBACJ,SAAS,KAAK,MAAM;gBACpB,WAAW,KAAK,YAAY;gBAC5B,YAAY,KAAK,SAAS,IAAI;gBAC9B,YAAY,KAAK,EAAE;gBACnB,YAAY,IAAI,OAAO,WAAW;gBAClC,YAAY;gBACZ,QAAQ;YACZ,GACC,MAAM,GACN,MAAM;YAEX,IAAI,OAAO,MAAM;YACjB,aAAa;YAEb,MAAM;YACN,MAAM,SAAS,GAAG,CAAC,yBAAyB;gBACxC,UAAU;gBACV,gBAAgB,KAAK,EAAE;gBACvB,iBAAiB,cAAc,EAAE;gBACjC,cAAc,KAAK,SAAS,IAAI;gBAChC,SAAS,KAAK,KAAK,IAAI;YAC3B;QACJ;QAEA,IAAA,uJAAc,EAAC;QACf,OAAO;YAAE,SAAS;YAAM,MAAM;QAAW;IAC7C,EAAE,OAAO,OAAY;QACjB,OAAO;YAAE,OAAO,MAAM,OAAO;QAAC;IAClC;AACJ;AAKO,eAAe,aAAa,IAIlC;IACG,MAAM,WAAW,MAAM,IAAA,iJAAY;IAEnC,MAAM,EAAE,MAAM,EAAE,IAAI,EAAE,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;IACtD,IAAI,CAAC,MAAM,OAAO;QAAE,OAAO;IAAe;IAE1C,IAAI;QACA,IAAI,KAAK,IAAI,KAAK,UAAU;YACxB,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,SACnB,IAAI,CAAC,eACL,MAAM,CAAC;gBAAE,QAAQ;YAAW,GAAG,uCAAuC;aACtE,EAAE,CAAC,MAAM,KAAK,YAAY;YAE/B,IAAI,OAAO,MAAM;YAEjB,MAAM;YACN,MAAM,SAAS,GAAG,CAAC,yBAAyB;gBACxC,UAAU;gBACV,gBAAgB,KAAK,EAAE;gBACvB,iBAAiB,KAAK,YAAY;gBAClC,SAAS,KAAK,MAAM;YACxB;QACJ,OAAO;YACH,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,SACnB,IAAI,CAAC,eACL,MAAM,CAAC;gBAAE,QAAQ;YAAW,GAC5B,EAAE,CAAC,MAAM,KAAK,YAAY;YAE/B,IAAI,OAAO,MAAM;YAEjB,MAAM;YACN,MAAM,SAAS,GAAG,CAAC,yBAAyB;gBACxC,UAAU;gBACV,gBAAgB,KAAK,EAAE;gBACvB,iBAAiB,KAAK,YAAY;gBAClC,SAAS,KAAK,MAAM;YACxB;QACJ;QAEA,IAAA,uJAAc,EAAC;QACf,OAAO;YAAE,SAAS;QAAK;IAC3B,EAAE,OAAO,OAAY;QACjB,OAAO;YAAE,OAAO,MAAM,OAAO;QAAC;IAClC;AACJ;AAKO,eAAe,aAAa,IAKlC;IACG,MAAM,WAAW,MAAM,IAAA,iJAAY;IAEnC,MAAM,EAAE,MAAM,EAAE,IAAI,EAAE,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;IACtD,IAAI,CAAC,MAAM,OAAO;QAAE,OAAO;IAAe;IAE1C,QAAQ,GAAG,CAAC,mCAAmC;QAC3C,cAAc,KAAK,YAAY;QAC/B,MAAM,KAAK,IAAI;QACf,eAAe,KAAK,aAAa;QACjC,SAAS,KAAK,aAAa,CAAC,WAAW;IAC3C;IAEA,IAAI;QACA,IAAI;QACJ,IAAI;QAEJ,IAAI,KAAK,IAAI,KAAK,UAAU;YACxB,yBAAyB;YACzB,MAAM,EAAE,MAAM,QAAQ,EAAE,OAAO,UAAU,EAAE,GAAG,MAAM,SAC/C,IAAI,CAAC,eACL,MAAM,CAAC,uBACP,EAAE,CAAC,MAAM,KAAK,YAAY,EAC1B,MAAM;YAEX,IAAI,YAAY;gBACZ,QAAQ,KAAK,CAAC,6CAA6C;gBAC3D,MAAM,IAAI,MAAM,CAAC,2BAA2B,EAAE,WAAW,OAAO,EAAE;YACtE;YAEA,QAAQ,GAAG,CAAC,sCAAsC;YAClD,iBAAiB,UAAU;YAE3B,yBAAyB;YACzB,MAAM,EAAE,MAAM,OAAO,EAAE,KAAK,EAAE,GAAG,MAAM,SAClC,IAAI,CAAC,eACL,MAAM,CAAC;gBACJ,YAAY,KAAK,aAAa,CAAC,WAAW;gBAC1C,YAAY,IAAI,OAAO,WAAW;YACtC,GACC,EAAE,CAAC,MAAM,KAAK,YAAY,EAC1B,MAAM;YAEX,cAAc;YACd,QAAQ,GAAG,CAAC,iCAAiC;gBAAE;gBAAS;YAAM;YAE9D,IAAI,OAAO,MAAM;YAEjB,IAAI,CAAC,WAAW,QAAQ,MAAM,KAAK,GAAG;gBAClC,MAAM,IAAI,MAAM;YACpB;YAEA,oBAAoB;YACpB,MAAM,EAAE,MAAM,QAAQ,EAAE,GAAG,MAAM,SAC5B,IAAI,CAAC,eACL,MAAM,CAAC,cACP,EAAE,CAAC,MAAM,KAAK,YAAY,EAC1B,MAAM;YAEX,QAAQ,GAAG,CAAC,gDAAgD;YAE5D,IAAI,CAAC,UAAU,YAAY;gBACvB,MAAM,IAAI,MAAM;YACpB;YAEA,iBAAiB;YACjB,MAAM,SAAS,GAAG,CAAC,yBAAyB;gBACxC,UAAU;gBACV,gBAAgB,KAAK,EAAE;gBACvB,iBAAiB,KAAK,YAAY;gBAClC,mBAAmB;gBACnB,cAAc,KAAK,aAAa,CAAC,WAAW;gBAC5C,SAAS,KAAK,KAAK,IAAI;YAC3B;QACJ,OAAO;YACH,yBAAyB;YACzB,MAAM,EAAE,MAAM,QAAQ,EAAE,OAAO,UAAU,EAAE,GAAG,MAAM,SAC/C,IAAI,CAAC,eACL,MAAM,CAAC,uBACP,EAAE,CAAC,MAAM,KAAK,YAAY,EAC1B,MAAM;YAEX,IAAI,YAAY;gBACZ,QAAQ,KAAK,CAAC,yDAAyD;gBACvE,MAAM,IAAI,MAAM,CAAC,uCAAuC,EAAE,WAAW,OAAO,EAAE;YAClF;YAEA,QAAQ,GAAG,CAAC,kDAAkD;YAC9D,iBAAiB,UAAU;YAE3B,MAAM,EAAE,MAAM,OAAO,EAAE,KAAK,EAAE,GAAG,MAAM,SAClC,IAAI,CAAC,eACL,MAAM,CAAC;gBACJ,YAAY,KAAK,aAAa,CAAC,WAAW;gBAC1C,YAAY,IAAI,OAAO,WAAW;YACtC,GACC,EAAE,CAAC,MAAM,KAAK,YAAY,EAC1B,MAAM;YAEX,cAAc;YACd,QAAQ,GAAG,CAAC,6CAA6C;gBAAE;gBAAS;YAAM;YAE1E,IAAI,OAAO,MAAM;YAEjB,IAAI,CAAC,WAAW,QAAQ,MAAM,KAAK,GAAG;gBAClC,MAAM,IAAI,MAAM;YACpB;YAEA,oBAAoB;YACpB,MAAM,EAAE,MAAM,QAAQ,EAAE,GAAG,MAAM,SAC5B,IAAI,CAAC,eACL,MAAM,CAAC,cACP,EAAE,CAAC,MAAM,KAAK,YAAY,EAC1B,MAAM;YAEX,QAAQ,GAAG,CAAC,4DAA4D;YAExE,IAAI,CAAC,UAAU,YAAY;gBACvB,MAAM,IAAI,MAAM;YACpB;YAEA,iBAAiB;YACjB,MAAM,SAAS,GAAG,CAAC,yBAAyB;gBACxC,UAAU;gBACV,gBAAgB,KAAK,EAAE;gBACvB,iBAAiB,KAAK,YAAY;gBAClC,mBAAmB;gBACnB,cAAc,KAAK,aAAa,CAAC,WAAW;gBAC5C,SAAS,KAAK,KAAK,IAAI;YAC3B;QACJ;QAEA,QAAQ,GAAG,CAAC;QACZ,IAAA,uJAAc,EAAC;QACf,OAAO;YAAE,SAAS;QAAK;IAC3B,EAAE,OAAO,OAAY;QACjB,QAAQ,KAAK,CAAC,yBAAyB;QACvC,OAAO;YAAE,OAAO,MAAM,OAAO;QAAC;IAClC;AACJ;AAKO,eAAe,yBAAyB,YAAoB,CAAC;IAChE,MAAM,WAAW,MAAM,IAAA,iJAAY;IAEnC,MAAM,EAAE,MAAM,EAAE,IAAI,EAAE,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;IACtD,IAAI,CAAC,MAAM,OAAO;QAAE,OAAO;IAAe;IAE1C,IAAI;QACA,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SACzB,IAAI,CAAC,6BACL,MAAM,CAAC,KACP,GAAG,CAAC,qBAAqB,WACzB,KAAK,CAAC,qBAAqB;YAAE,WAAW;QAAK;QAElD,IAAI,OAAO,MAAM;QAEjB,OAAO;YAAE,SAAS;YAAM;QAAK;IACjC,EAAE,OAAO,OAAY;QACjB,OAAO;YAAE,OAAO,MAAM,OAAO;QAAC;IAClC;AACJ;AAKO,eAAe,oBAAoB,QAAgB,EAAE;IACxD,MAAM,WAAW,MAAM,IAAA,iJAAY;IAEnC,MAAM,EAAE,MAAM,EAAE,IAAI,EAAE,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;IACtD,IAAI,CAAC,MAAM,OAAO;QAAE,OAAO;IAAe;IAE1C,IAAI;QACA,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SACzB,IAAI,CAAC,mBACL,MAAM,CAAC,CAAC;;;;;;;MAOf,CAAC,EACM,KAAK,CAAC,cAAc;YAAE,WAAW;QAAM,GACvC,KAAK,CAAC;QAEX,IAAI,OAAO,MAAM;QAEjB,OAAO;YAAE,SAAS;YAAM;QAAK;IACjC,EAAE,OAAO,OAAY;QACjB,OAAO;YAAE,OAAO,MAAM,OAAO;QAAC;IAClC;AACJ;;;IAhcsB;IAmGA;IAiGA;IAqDA;IAqJA;IAwBA;;AAtaA,0OAAA;AAmGA,0OAAA;AAiGA,0OAAA;AAqDA,0OAAA;AAqJA,0OAAA;AAwBA,0OAAA"}},
    {"offset": {"line": 1158, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/.next-internal/server/app/admin/exams/page/actions.js (server actions loader)"],"sourcesContent":["export {awardCoins as '780d64f65fac54c55def49046d2a33becf7ac8e4bd'} from 'ACTIONS_MODULE0'\nexport {updateMissionProgress as '6062a646126ab86278ff8a9f9d5dd9c2cf55fa2b68'} from 'ACTIONS_MODULE0'\nexport {getRewardStatus as '40d59f95dc89fd4dc26cbfaa1a6ee2c66ddc89d104'} from 'ACTIONS_MODULE0'\nexport {getDailyMissions as '409b6c9e7f7aeea92b23738c3b0bc90cec78ddfab0'} from 'ACTIONS_MODULE0'\nexport {getUserBadges as '401af75fb501836c067ff5309414f33ff8ec6d523c'} from 'ACTIONS_MODULE0'\nexport {getLeaderboard as '606f53d15fe31c1858c290384edc7b7c0fb1e457e8'} from 'ACTIONS_MODULE0'\nexport {checkStreak as '406ef9d617799bcd1e0cc901a06585cccfd9ea3b5e'} from 'ACTIONS_MODULE0'\nexport {getStreakHistory as '40b0b14b03ca8c026611963a00d913cf1f9512bae9'} from 'ACTIONS_MODULE0'\nexport {getStudentsWithEnrollments as '401e9ce0458d2afa0207c6302a62aaef1c7059712b'} from 'ACTIONS_MODULE1'\nexport {addStudent as '408f03e7e3f4c3de50e6913fb3e48cc02f9ed7f96d'} from 'ACTIONS_MODULE1'\nexport {resetStudentSessions as '4097ab6e569d8f3c5430e8f17aee35b3244ae881ef'} from 'ACTIONS_MODULE1'\nexport {searchStudents as '406484b2444f52c52521e60e9acd3ed3a3a2775b75'} from 'ACTIONS_MODULE1'\nexport {grantCourseAccess as '40da591ecf5ed2510043a6b8d18ac4a7b6b4d5c561'} from 'ACTIONS_MODULE2'\nexport {grantTestSeriesAccess as '40893765dd14aa6d3c814ee90aece2f3f3abd24aa8'} from 'ACTIONS_MODULE2'\nexport {extendAccess as '400c8a091c4a2f19ca7a10c1269a2d5a7c5248207c'} from 'ACTIONS_MODULE2'\n"],"names":[],"mappings":";AAAA;AAQA;AAIA"}}]
}