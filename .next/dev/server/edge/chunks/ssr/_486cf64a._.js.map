{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/actions/admin/students.ts"],"sourcesContent":["'use server';\r\n\r\nimport { createClient } from '@/lib/supabase/server';\r\nimport { createAdminClient } from '@/lib/supabase/admin';\r\nimport { revalidatePath } from 'next/cache';\r\n\r\n/**\r\n * Add a new student manually (admin only)\r\n * Returns student info if already exists, or creates an invitation\r\n */\r\nexport async function addStudent(data: {\r\n    email: string;\r\n    fullName: string;\r\n    sendInvite?: boolean;\r\n}) {\r\n    const supabase = await createClient();\r\n\r\n    // Check admin permission\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) return { error: 'Unauthorized' };\r\n\r\n    const { data: profile } = await supabase\r\n        .from('profiles')\r\n        .select('role')\r\n        .eq('id', user.id)\r\n        .single();\r\n\r\n    if (profile?.role !== 'admin') {\r\n        return { error: 'Admin access required' };\r\n    }\r\n\r\n    try {\r\n        // Check if student already exists in profiles\r\n        const { data: existing } = await supabase\r\n            .from('profiles')\r\n            .select('id, email, full_name')\r\n            .eq('email', data.email)\r\n            .single();\r\n\r\n        if (existing) {\r\n            return {\r\n                success: true,\r\n                data: existing,\r\n                message: 'Student already exists in the system'\r\n            };\r\n        }\r\n\r\n        // Send invitation email using Supabase Admin\r\n        if (data.sendInvite) {\r\n            const adminClient = createAdminClient();\r\n\r\n            // Invite user via Supabase Auth\r\n            const { data: inviteData, error: inviteError } = await adminClient.auth.admin.inviteUserByEmail(\r\n                data.email,\r\n                {\r\n                    data: {\r\n                        full_name: data.fullName,\r\n                        role: 'student'\r\n                    },\r\n                    redirectTo: `${process.env.NEXT_PUBLIC_SITE_URL || 'http://localhost:3000'}/auth/callback`\r\n                }\r\n            );\r\n\r\n            if (inviteError) {\r\n                console.error('Invitation error:', inviteError);\r\n                throw new Error(`Failed to send invitation: ${inviteError.message}`);\r\n            }\r\n\r\n            console.log(`✅ Invitation sent to ${data.email}`, inviteData);\r\n\r\n            // Create profile entry for the invited user\r\n            if (inviteData.user) {\r\n                const { error: profileError } = await adminClient\r\n                    .from('profiles')\r\n                    .insert({\r\n                        id: inviteData.user.id,\r\n                        email: data.email,\r\n                        full_name: data.fullName,\r\n                        role: 'student'\r\n                    });\r\n\r\n                if (profileError) {\r\n                    console.error('Profile creation error:', profileError);\r\n                    // Don't fail the whole operation if profile creation fails\r\n                    // The profile will be created on first login via callback\r\n                }\r\n            }\r\n\r\n            revalidatePath('/admin/students');\r\n            return {\r\n                success: true,\r\n                data: { email: data.email, full_name: data.fullName },\r\n                message: 'Invitation sent successfully! Student will receive an email to join.'\r\n            };\r\n        }\r\n\r\n        // If not sending invite, just return success\r\n        revalidatePath('/admin/students');\r\n        return {\r\n            success: true,\r\n            data: { email: data.email, full_name: data.fullName },\r\n            message: 'Student information saved. They can sign up normally.'\r\n        };\r\n    } catch (error: any) {\r\n        console.error('Add student error:', error);\r\n        return { error: error.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Search students by name or email\r\n */\r\nexport async function searchStudents(query: string) {\r\n    const supabase = await createClient();\r\n\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) return { error: 'Unauthorized' };\r\n\r\n    try {\r\n        const { data, error } = await supabase\r\n            .from('profiles')\r\n            .select('id, email, full_name, avatar_url, created_at')\r\n            .eq('role', 'student')\r\n            .or(`full_name.ilike.%${query}%,email.ilike.%${query}%`)\r\n            .order('full_name', { ascending: true })\r\n            .limit(20);\r\n\r\n        if (error) throw error;\r\n\r\n        return { success: true, data };\r\n    } catch (error: any) {\r\n        return { error: error.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Get all students with their enrollments and expiry info\r\n */\r\nexport async function getStudentsWithEnrollments(filters?: {\r\n    status?: 'all' | 'active' | 'expired';\r\n    expiringWithinDays?: number;\r\n}) {\r\n    const supabase = await createClient();\r\n\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) return { error: 'Unauthorized' };\r\n\r\n    try {\r\n        // Get all students\r\n        const { data: students, error: studentsError } = await supabase\r\n            .from('profiles')\r\n            .select(`\r\n        id,\r\n        email,\r\n        full_name,\r\n        avatar_url,\r\n        created_at\r\n      `)\r\n            .eq('role', 'student')\r\n            .order('created_at', { ascending: false });\r\n\r\n        if (studentsError) throw studentsError;\r\n\r\n        // Get enrollments for each student\r\n        const { data: enrollments, error: enrollmentsError } = await supabase\r\n            .from('enrollments')\r\n            .select(`\r\n        id,\r\n        user_id,\r\n        course_id,\r\n        status,\r\n        expires_at,\r\n        granted_by,\r\n        grant_type,\r\n        courses (\r\n          id,\r\n          title,\r\n          thumbnail_url\r\n        )\r\n      `);\r\n\r\n        if (enrollmentsError) throw enrollmentsError;\r\n\r\n\r\n\r\n        // Combine data\r\n        const studentsWithEnrollments = students?.map(student => {\r\n            const courseEnrollments = enrollments?.filter(e => e.user_id === student.id) || [];\r\n\r\n            // Check expiry status\r\n            const now = new Date();\r\n            const expiringSoon = courseEnrollments.filter(e => {\r\n                if (!e.expires_at) return false;\r\n                const expiryDate = new Date(e.expires_at);\r\n                const daysUntilExpiry = (expiryDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24);\r\n                return daysUntilExpiry > 0 && daysUntilExpiry <= (filters?.expiringWithinDays || 7);\r\n            });\r\n\r\n            return {\r\n                ...student,\r\n                enrollments: courseEnrollments,\r\n                totalEnrollments: courseEnrollments.length,\r\n                expiringSoonCount: expiringSoon.length\r\n            };\r\n        });\r\n\r\n        // Apply filters\r\n        let filtered = studentsWithEnrollments;\r\n        if (filters?.status === 'active') {\r\n            filtered = filtered?.filter(s => s.totalEnrollments > 0);\r\n        } else if (filters?.status === 'expired') {\r\n            filtered = filtered?.filter(s => {\r\n                const hasExpired = (s.enrollments || []).some(e => {\r\n                    if (!e.expires_at) return false;\r\n                    return new Date(e.expires_at) < new Date();\r\n                });\r\n                return hasExpired;\r\n            });\r\n        }\r\n\r\n        return { success: true, data: filtered };\r\n    } catch (error: any) {\r\n        return { error: error.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Get exam attempts for a specific student\r\n */\r\nexport async function getStudentAttempts(userId: string) {\r\n    const supabase = createAdminClient();\r\n\r\n    try {\r\n        const { data: rawData, error } = await supabase\r\n            .from('exam_attempts')\r\n            .select(`\r\n                *,\r\n                exams (\r\n                    id,\r\n                    title,\r\n                    total_marks\r\n                ),\r\n                results (*)\r\n            `)\r\n            .eq('student_id', userId)\r\n            .order('created_at', { ascending: false });\r\n\r\n        if (error) throw error;\r\n\r\n        // Flatten results\r\n        const data = rawData?.map(att => ({\r\n            ...att,\r\n            results: Array.isArray(att.results) ? att.results[0] : att.results\r\n        })) || [];\r\n\r\n        return { success: true, data };\r\n    } catch (error: any) {\r\n        return { error: error.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Get detailed info for a single student with stats\r\n */\r\nexport async function getStudentDetails(userId: string) {\r\n    try {\r\n        const supabase = createAdminClient();\r\n\r\n        // Get student profile\r\n        const { data: student, error: studentError } = await supabase\r\n            .from('profiles')\r\n            .select('*')\r\n            .eq('id', userId)\r\n            .single();\r\n\r\n        if (studentError) {\r\n            console.error('Student fetch error:', studentError);\r\n            throw new Error(`Failed to fetch student profile: ${studentError.message}`);\r\n        }\r\n\r\n        if (!student) {\r\n            return { error: 'Student not found' };\r\n        }\r\n\r\n        // Get active sessions count\r\n        // Note: Accessing auth schema may require special permissions\r\n        let activeSessions = 0;\r\n        try {\r\n            const { count, error: sessionsError } = await supabase\r\n                .schema('auth')\r\n                .from('sessions')\r\n                .select('*', { count: 'exact', head: true })\r\n                .eq('user_id', userId);\r\n\r\n            if (sessionsError) {\r\n                console.error('Session count error:', sessionsError);\r\n            } else {\r\n                activeSessions = count || 0;\r\n            }\r\n        } catch (err) {\r\n            console.error('Failed to fetch session count:', err);\r\n            // Fallback: activeSessions remains 0\r\n        }\r\n\r\n        // Get enrollments\r\n        const { data: enrollments, error: enrollmentsError } = await supabase\r\n            .from('enrollments')\r\n            .select(`\r\n                *,\r\n                courses (\r\n                    id,\r\n                    title,\r\n                    thumbnail_url,\r\n                    price,\r\n                    course_type\r\n                ),\r\n                granted_by_profile:profiles!enrollments_granted_by_fkey (\r\n                    id,\r\n                    full_name\r\n                )\r\n            `)\r\n            .eq('user_id', userId);\r\n\r\n        if (enrollmentsError) {\r\n            console.error('Enrollments fetch error:', enrollmentsError);\r\n            // Don't throw, just log and continue with empty array\r\n        }\r\n\r\n\r\n\r\n        const { data: rawAttempts, error: attemptsError } = await supabase\r\n            .from('exam_attempts')\r\n            .select(`\r\n                *,\r\n                exams (id, title, total_marks),\r\n                results (percentage, obtained_marks)\r\n            `)\r\n            .eq('student_id', userId)\r\n            .order('created_at', { ascending: false });\r\n\r\n        if (attemptsError) {\r\n            console.error('Exam attempts fetch error:', attemptsError);\r\n            // Don't throw, just log and continue with empty array\r\n        }\r\n\r\n        // Transform attempts to handle singular results object\r\n        const attempts = rawAttempts?.map(att => ({\r\n            ...att,\r\n            results: Array.isArray(att.results) ? att.results[0] : att.results\r\n        })) || [];\r\n\r\n        // Get enrollment logs\r\n        const enrollmentIds = enrollments?.map(e => e.id) || [];\r\n\r\n        let logs: any[] = [];\r\n        if (enrollmentIds.length > 0) {\r\n            const { data: logData, error: logsError } = await supabase\r\n                .from('enrollment_logs')\r\n                .select(`\r\n                    *,\r\n                    performed_by_profile:profiles!enrollment_logs_performed_by_fkey (\r\n                        id,\r\n                        full_name\r\n                    )\r\n                `)\r\n                .in('enrollment_id', enrollmentIds)\r\n                .order('created_at', { ascending: false })\r\n                .limit(50);\r\n\r\n            if (logsError) {\r\n                console.error('Enrollment logs fetch error:', logsError);\r\n                // Don't throw, just log and continue with empty array\r\n            } else {\r\n                logs = logData || [];\r\n            }\r\n        }\r\n\r\n        // Calculate Stats\r\n        const submittedAttempts = attempts.filter(a => a.status === 'submitted');\r\n        const avgPercentage = submittedAttempts.length > 0\r\n            ? submittedAttempts.reduce((acc, curr) => acc + (curr.results?.percentage || 0), 0) / submittedAttempts.length\r\n            : 0;\r\n\r\n        return {\r\n            success: true,\r\n            data: {\r\n                student,\r\n                enrollments: enrollments || [],\r\n                attempts: attempts || [],\r\n                logs,\r\n                activeSessions,\r\n                stats: {\r\n                    totalEnrollments: enrollments?.length || 0,\r\n                    totalAttempts: attempts?.length || 0,\r\n                    avgPercentage: Math.round(avgPercentage * 10) / 10\r\n                }\r\n            }\r\n        };\r\n    } catch (error: any) {\r\n        console.error('getStudentDetails error:', error);\r\n        return { error: error?.message || 'An unexpected error occurred while fetching student details' };\r\n    }\r\n}\r\n\r\n/**\r\n * Reset all active sessions for a student (admin only)\r\n */\r\nexport async function resetStudentSessions(userId: string) {\r\n    const supabase = createAdminClient();\r\n\r\n    try {\r\n        // Delete all sessions for this user\r\n        const { error: sessionError } = await supabase\r\n            .schema('auth')\r\n            .from('sessions')\r\n            .delete()\r\n            .eq('user_id', userId);\r\n\r\n        if (sessionError) throw sessionError;\r\n\r\n        // Also delete refresh tokens to ensure they can't get a new session\r\n        const { error: tokenError } = await supabase\r\n            .schema('auth')\r\n            .from('refresh_tokens')\r\n            .delete()\r\n            .eq('user_id', userId);\r\n\r\n        // Note: tokenError might happen if they have no tokens, we can be lenient or log it\r\n\r\n        revalidatePath(`/admin/students/${userId}`);\r\n        return { success: true, message: 'All active sessions have been reset' };\r\n    } catch (error: any) {\r\n        console.error('Reset sessions error:', error);\r\n        return { error: error.message };\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;IA0IsB,6BAAA,WAAA,GAAA,IAAA,kOAAA,EAAA,8CAAA,4LAAA,EAAA,KAAA,GAAA,gNAAA,EAAA"}},
    {"offset": {"line": 19, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/actions/admin/students.ts"],"sourcesContent":["'use server';\r\n\r\nimport { createClient } from '@/lib/supabase/server';\r\nimport { createAdminClient } from '@/lib/supabase/admin';\r\nimport { revalidatePath } from 'next/cache';\r\n\r\n/**\r\n * Add a new student manually (admin only)\r\n * Returns student info if already exists, or creates an invitation\r\n */\r\nexport async function addStudent(data: {\r\n    email: string;\r\n    fullName: string;\r\n    sendInvite?: boolean;\r\n}) {\r\n    const supabase = await createClient();\r\n\r\n    // Check admin permission\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) return { error: 'Unauthorized' };\r\n\r\n    const { data: profile } = await supabase\r\n        .from('profiles')\r\n        .select('role')\r\n        .eq('id', user.id)\r\n        .single();\r\n\r\n    if (profile?.role !== 'admin') {\r\n        return { error: 'Admin access required' };\r\n    }\r\n\r\n    try {\r\n        // Check if student already exists in profiles\r\n        const { data: existing } = await supabase\r\n            .from('profiles')\r\n            .select('id, email, full_name')\r\n            .eq('email', data.email)\r\n            .single();\r\n\r\n        if (existing) {\r\n            return {\r\n                success: true,\r\n                data: existing,\r\n                message: 'Student already exists in the system'\r\n            };\r\n        }\r\n\r\n        // Send invitation email using Supabase Admin\r\n        if (data.sendInvite) {\r\n            const adminClient = createAdminClient();\r\n\r\n            // Invite user via Supabase Auth\r\n            const { data: inviteData, error: inviteError } = await adminClient.auth.admin.inviteUserByEmail(\r\n                data.email,\r\n                {\r\n                    data: {\r\n                        full_name: data.fullName,\r\n                        role: 'student'\r\n                    },\r\n                    redirectTo: `${process.env.NEXT_PUBLIC_SITE_URL || 'http://localhost:3000'}/auth/callback`\r\n                }\r\n            );\r\n\r\n            if (inviteError) {\r\n                console.error('Invitation error:', inviteError);\r\n                throw new Error(`Failed to send invitation: ${inviteError.message}`);\r\n            }\r\n\r\n            console.log(`✅ Invitation sent to ${data.email}`, inviteData);\r\n\r\n            // Create profile entry for the invited user\r\n            if (inviteData.user) {\r\n                const { error: profileError } = await adminClient\r\n                    .from('profiles')\r\n                    .insert({\r\n                        id: inviteData.user.id,\r\n                        email: data.email,\r\n                        full_name: data.fullName,\r\n                        role: 'student'\r\n                    });\r\n\r\n                if (profileError) {\r\n                    console.error('Profile creation error:', profileError);\r\n                    // Don't fail the whole operation if profile creation fails\r\n                    // The profile will be created on first login via callback\r\n                }\r\n            }\r\n\r\n            revalidatePath('/admin/students');\r\n            return {\r\n                success: true,\r\n                data: { email: data.email, full_name: data.fullName },\r\n                message: 'Invitation sent successfully! Student will receive an email to join.'\r\n            };\r\n        }\r\n\r\n        // If not sending invite, just return success\r\n        revalidatePath('/admin/students');\r\n        return {\r\n            success: true,\r\n            data: { email: data.email, full_name: data.fullName },\r\n            message: 'Student information saved. They can sign up normally.'\r\n        };\r\n    } catch (error: any) {\r\n        console.error('Add student error:', error);\r\n        return { error: error.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Search students by name or email\r\n */\r\nexport async function searchStudents(query: string) {\r\n    const supabase = await createClient();\r\n\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) return { error: 'Unauthorized' };\r\n\r\n    try {\r\n        const { data, error } = await supabase\r\n            .from('profiles')\r\n            .select('id, email, full_name, avatar_url, created_at')\r\n            .eq('role', 'student')\r\n            .or(`full_name.ilike.%${query}%,email.ilike.%${query}%`)\r\n            .order('full_name', { ascending: true })\r\n            .limit(20);\r\n\r\n        if (error) throw error;\r\n\r\n        return { success: true, data };\r\n    } catch (error: any) {\r\n        return { error: error.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Get all students with their enrollments and expiry info\r\n */\r\nexport async function getStudentsWithEnrollments(filters?: {\r\n    status?: 'all' | 'active' | 'expired';\r\n    expiringWithinDays?: number;\r\n}) {\r\n    const supabase = await createClient();\r\n\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) return { error: 'Unauthorized' };\r\n\r\n    try {\r\n        // Get all students\r\n        const { data: students, error: studentsError } = await supabase\r\n            .from('profiles')\r\n            .select(`\r\n        id,\r\n        email,\r\n        full_name,\r\n        avatar_url,\r\n        created_at\r\n      `)\r\n            .eq('role', 'student')\r\n            .order('created_at', { ascending: false });\r\n\r\n        if (studentsError) throw studentsError;\r\n\r\n        // Get enrollments for each student\r\n        const { data: enrollments, error: enrollmentsError } = await supabase\r\n            .from('enrollments')\r\n            .select(`\r\n        id,\r\n        user_id,\r\n        course_id,\r\n        status,\r\n        expires_at,\r\n        granted_by,\r\n        grant_type,\r\n        courses (\r\n          id,\r\n          title,\r\n          thumbnail_url\r\n        )\r\n      `);\r\n\r\n        if (enrollmentsError) throw enrollmentsError;\r\n\r\n\r\n\r\n        // Combine data\r\n        const studentsWithEnrollments = students?.map(student => {\r\n            const courseEnrollments = enrollments?.filter(e => e.user_id === student.id) || [];\r\n\r\n            // Check expiry status\r\n            const now = new Date();\r\n            const expiringSoon = courseEnrollments.filter(e => {\r\n                if (!e.expires_at) return false;\r\n                const expiryDate = new Date(e.expires_at);\r\n                const daysUntilExpiry = (expiryDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24);\r\n                return daysUntilExpiry > 0 && daysUntilExpiry <= (filters?.expiringWithinDays || 7);\r\n            });\r\n\r\n            return {\r\n                ...student,\r\n                enrollments: courseEnrollments,\r\n                totalEnrollments: courseEnrollments.length,\r\n                expiringSoonCount: expiringSoon.length\r\n            };\r\n        });\r\n\r\n        // Apply filters\r\n        let filtered = studentsWithEnrollments;\r\n        if (filters?.status === 'active') {\r\n            filtered = filtered?.filter(s => s.totalEnrollments > 0);\r\n        } else if (filters?.status === 'expired') {\r\n            filtered = filtered?.filter(s => {\r\n                const hasExpired = (s.enrollments || []).some(e => {\r\n                    if (!e.expires_at) return false;\r\n                    return new Date(e.expires_at) < new Date();\r\n                });\r\n                return hasExpired;\r\n            });\r\n        }\r\n\r\n        return { success: true, data: filtered };\r\n    } catch (error: any) {\r\n        return { error: error.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Get exam attempts for a specific student\r\n */\r\nexport async function getStudentAttempts(userId: string) {\r\n    const supabase = createAdminClient();\r\n\r\n    try {\r\n        const { data: rawData, error } = await supabase\r\n            .from('exam_attempts')\r\n            .select(`\r\n                *,\r\n                exams (\r\n                    id,\r\n                    title,\r\n                    total_marks\r\n                ),\r\n                results (*)\r\n            `)\r\n            .eq('student_id', userId)\r\n            .order('created_at', { ascending: false });\r\n\r\n        if (error) throw error;\r\n\r\n        // Flatten results\r\n        const data = rawData?.map(att => ({\r\n            ...att,\r\n            results: Array.isArray(att.results) ? att.results[0] : att.results\r\n        })) || [];\r\n\r\n        return { success: true, data };\r\n    } catch (error: any) {\r\n        return { error: error.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Get detailed info for a single student with stats\r\n */\r\nexport async function getStudentDetails(userId: string) {\r\n    try {\r\n        const supabase = createAdminClient();\r\n\r\n        // Get student profile\r\n        const { data: student, error: studentError } = await supabase\r\n            .from('profiles')\r\n            .select('*')\r\n            .eq('id', userId)\r\n            .single();\r\n\r\n        if (studentError) {\r\n            console.error('Student fetch error:', studentError);\r\n            throw new Error(`Failed to fetch student profile: ${studentError.message}`);\r\n        }\r\n\r\n        if (!student) {\r\n            return { error: 'Student not found' };\r\n        }\r\n\r\n        // Get active sessions count\r\n        // Note: Accessing auth schema may require special permissions\r\n        let activeSessions = 0;\r\n        try {\r\n            const { count, error: sessionsError } = await supabase\r\n                .schema('auth')\r\n                .from('sessions')\r\n                .select('*', { count: 'exact', head: true })\r\n                .eq('user_id', userId);\r\n\r\n            if (sessionsError) {\r\n                console.error('Session count error:', sessionsError);\r\n            } else {\r\n                activeSessions = count || 0;\r\n            }\r\n        } catch (err) {\r\n            console.error('Failed to fetch session count:', err);\r\n            // Fallback: activeSessions remains 0\r\n        }\r\n\r\n        // Get enrollments\r\n        const { data: enrollments, error: enrollmentsError } = await supabase\r\n            .from('enrollments')\r\n            .select(`\r\n                *,\r\n                courses (\r\n                    id,\r\n                    title,\r\n                    thumbnail_url,\r\n                    price,\r\n                    course_type\r\n                ),\r\n                granted_by_profile:profiles!enrollments_granted_by_fkey (\r\n                    id,\r\n                    full_name\r\n                )\r\n            `)\r\n            .eq('user_id', userId);\r\n\r\n        if (enrollmentsError) {\r\n            console.error('Enrollments fetch error:', enrollmentsError);\r\n            // Don't throw, just log and continue with empty array\r\n        }\r\n\r\n\r\n\r\n        const { data: rawAttempts, error: attemptsError } = await supabase\r\n            .from('exam_attempts')\r\n            .select(`\r\n                *,\r\n                exams (id, title, total_marks),\r\n                results (percentage, obtained_marks)\r\n            `)\r\n            .eq('student_id', userId)\r\n            .order('created_at', { ascending: false });\r\n\r\n        if (attemptsError) {\r\n            console.error('Exam attempts fetch error:', attemptsError);\r\n            // Don't throw, just log and continue with empty array\r\n        }\r\n\r\n        // Transform attempts to handle singular results object\r\n        const attempts = rawAttempts?.map(att => ({\r\n            ...att,\r\n            results: Array.isArray(att.results) ? att.results[0] : att.results\r\n        })) || [];\r\n\r\n        // Get enrollment logs\r\n        const enrollmentIds = enrollments?.map(e => e.id) || [];\r\n\r\n        let logs: any[] = [];\r\n        if (enrollmentIds.length > 0) {\r\n            const { data: logData, error: logsError } = await supabase\r\n                .from('enrollment_logs')\r\n                .select(`\r\n                    *,\r\n                    performed_by_profile:profiles!enrollment_logs_performed_by_fkey (\r\n                        id,\r\n                        full_name\r\n                    )\r\n                `)\r\n                .in('enrollment_id', enrollmentIds)\r\n                .order('created_at', { ascending: false })\r\n                .limit(50);\r\n\r\n            if (logsError) {\r\n                console.error('Enrollment logs fetch error:', logsError);\r\n                // Don't throw, just log and continue with empty array\r\n            } else {\r\n                logs = logData || [];\r\n            }\r\n        }\r\n\r\n        // Calculate Stats\r\n        const submittedAttempts = attempts.filter(a => a.status === 'submitted');\r\n        const avgPercentage = submittedAttempts.length > 0\r\n            ? submittedAttempts.reduce((acc, curr) => acc + (curr.results?.percentage || 0), 0) / submittedAttempts.length\r\n            : 0;\r\n\r\n        return {\r\n            success: true,\r\n            data: {\r\n                student,\r\n                enrollments: enrollments || [],\r\n                attempts: attempts || [],\r\n                logs,\r\n                activeSessions,\r\n                stats: {\r\n                    totalEnrollments: enrollments?.length || 0,\r\n                    totalAttempts: attempts?.length || 0,\r\n                    avgPercentage: Math.round(avgPercentage * 10) / 10\r\n                }\r\n            }\r\n        };\r\n    } catch (error: any) {\r\n        console.error('getStudentDetails error:', error);\r\n        return { error: error?.message || 'An unexpected error occurred while fetching student details' };\r\n    }\r\n}\r\n\r\n/**\r\n * Reset all active sessions for a student (admin only)\r\n */\r\nexport async function resetStudentSessions(userId: string) {\r\n    const supabase = createAdminClient();\r\n\r\n    try {\r\n        // Delete all sessions for this user\r\n        const { error: sessionError } = await supabase\r\n            .schema('auth')\r\n            .from('sessions')\r\n            .delete()\r\n            .eq('user_id', userId);\r\n\r\n        if (sessionError) throw sessionError;\r\n\r\n        // Also delete refresh tokens to ensure they can't get a new session\r\n        const { error: tokenError } = await supabase\r\n            .schema('auth')\r\n            .from('refresh_tokens')\r\n            .delete()\r\n            .eq('user_id', userId);\r\n\r\n        // Note: tokenError might happen if they have no tokens, we can be lenient or log it\r\n\r\n        revalidatePath(`/admin/students/${userId}`);\r\n        return { success: true, message: 'All active sessions have been reset' };\r\n    } catch (error: any) {\r\n        console.error('Reset sessions error:', error);\r\n        return { error: error.message };\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;IAUsB,aAAA,WAAA,GAAA,IAAA,kOAAA,EAAA,8CAAA,4LAAA,EAAA,KAAA,GAAA,gNAAA,EAAA"}},
    {"offset": {"line": 34, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/actions/admin/students.ts"],"sourcesContent":["'use server';\r\n\r\nimport { createClient } from '@/lib/supabase/server';\r\nimport { createAdminClient } from '@/lib/supabase/admin';\r\nimport { revalidatePath } from 'next/cache';\r\n\r\n/**\r\n * Add a new student manually (admin only)\r\n * Returns student info if already exists, or creates an invitation\r\n */\r\nexport async function addStudent(data: {\r\n    email: string;\r\n    fullName: string;\r\n    sendInvite?: boolean;\r\n}) {\r\n    const supabase = await createClient();\r\n\r\n    // Check admin permission\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) return { error: 'Unauthorized' };\r\n\r\n    const { data: profile } = await supabase\r\n        .from('profiles')\r\n        .select('role')\r\n        .eq('id', user.id)\r\n        .single();\r\n\r\n    if (profile?.role !== 'admin') {\r\n        return { error: 'Admin access required' };\r\n    }\r\n\r\n    try {\r\n        // Check if student already exists in profiles\r\n        const { data: existing } = await supabase\r\n            .from('profiles')\r\n            .select('id, email, full_name')\r\n            .eq('email', data.email)\r\n            .single();\r\n\r\n        if (existing) {\r\n            return {\r\n                success: true,\r\n                data: existing,\r\n                message: 'Student already exists in the system'\r\n            };\r\n        }\r\n\r\n        // Send invitation email using Supabase Admin\r\n        if (data.sendInvite) {\r\n            const adminClient = createAdminClient();\r\n\r\n            // Invite user via Supabase Auth\r\n            const { data: inviteData, error: inviteError } = await adminClient.auth.admin.inviteUserByEmail(\r\n                data.email,\r\n                {\r\n                    data: {\r\n                        full_name: data.fullName,\r\n                        role: 'student'\r\n                    },\r\n                    redirectTo: `${process.env.NEXT_PUBLIC_SITE_URL || 'http://localhost:3000'}/auth/callback`\r\n                }\r\n            );\r\n\r\n            if (inviteError) {\r\n                console.error('Invitation error:', inviteError);\r\n                throw new Error(`Failed to send invitation: ${inviteError.message}`);\r\n            }\r\n\r\n            console.log(`✅ Invitation sent to ${data.email}`, inviteData);\r\n\r\n            // Create profile entry for the invited user\r\n            if (inviteData.user) {\r\n                const { error: profileError } = await adminClient\r\n                    .from('profiles')\r\n                    .insert({\r\n                        id: inviteData.user.id,\r\n                        email: data.email,\r\n                        full_name: data.fullName,\r\n                        role: 'student'\r\n                    });\r\n\r\n                if (profileError) {\r\n                    console.error('Profile creation error:', profileError);\r\n                    // Don't fail the whole operation if profile creation fails\r\n                    // The profile will be created on first login via callback\r\n                }\r\n            }\r\n\r\n            revalidatePath('/admin/students');\r\n            return {\r\n                success: true,\r\n                data: { email: data.email, full_name: data.fullName },\r\n                message: 'Invitation sent successfully! Student will receive an email to join.'\r\n            };\r\n        }\r\n\r\n        // If not sending invite, just return success\r\n        revalidatePath('/admin/students');\r\n        return {\r\n            success: true,\r\n            data: { email: data.email, full_name: data.fullName },\r\n            message: 'Student information saved. They can sign up normally.'\r\n        };\r\n    } catch (error: any) {\r\n        console.error('Add student error:', error);\r\n        return { error: error.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Search students by name or email\r\n */\r\nexport async function searchStudents(query: string) {\r\n    const supabase = await createClient();\r\n\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) return { error: 'Unauthorized' };\r\n\r\n    try {\r\n        const { data, error } = await supabase\r\n            .from('profiles')\r\n            .select('id, email, full_name, avatar_url, created_at')\r\n            .eq('role', 'student')\r\n            .or(`full_name.ilike.%${query}%,email.ilike.%${query}%`)\r\n            .order('full_name', { ascending: true })\r\n            .limit(20);\r\n\r\n        if (error) throw error;\r\n\r\n        return { success: true, data };\r\n    } catch (error: any) {\r\n        return { error: error.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Get all students with their enrollments and expiry info\r\n */\r\nexport async function getStudentsWithEnrollments(filters?: {\r\n    status?: 'all' | 'active' | 'expired';\r\n    expiringWithinDays?: number;\r\n}) {\r\n    const supabase = await createClient();\r\n\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) return { error: 'Unauthorized' };\r\n\r\n    try {\r\n        // Get all students\r\n        const { data: students, error: studentsError } = await supabase\r\n            .from('profiles')\r\n            .select(`\r\n        id,\r\n        email,\r\n        full_name,\r\n        avatar_url,\r\n        created_at\r\n      `)\r\n            .eq('role', 'student')\r\n            .order('created_at', { ascending: false });\r\n\r\n        if (studentsError) throw studentsError;\r\n\r\n        // Get enrollments for each student\r\n        const { data: enrollments, error: enrollmentsError } = await supabase\r\n            .from('enrollments')\r\n            .select(`\r\n        id,\r\n        user_id,\r\n        course_id,\r\n        status,\r\n        expires_at,\r\n        granted_by,\r\n        grant_type,\r\n        courses (\r\n          id,\r\n          title,\r\n          thumbnail_url\r\n        )\r\n      `);\r\n\r\n        if (enrollmentsError) throw enrollmentsError;\r\n\r\n\r\n\r\n        // Combine data\r\n        const studentsWithEnrollments = students?.map(student => {\r\n            const courseEnrollments = enrollments?.filter(e => e.user_id === student.id) || [];\r\n\r\n            // Check expiry status\r\n            const now = new Date();\r\n            const expiringSoon = courseEnrollments.filter(e => {\r\n                if (!e.expires_at) return false;\r\n                const expiryDate = new Date(e.expires_at);\r\n                const daysUntilExpiry = (expiryDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24);\r\n                return daysUntilExpiry > 0 && daysUntilExpiry <= (filters?.expiringWithinDays || 7);\r\n            });\r\n\r\n            return {\r\n                ...student,\r\n                enrollments: courseEnrollments,\r\n                totalEnrollments: courseEnrollments.length,\r\n                expiringSoonCount: expiringSoon.length\r\n            };\r\n        });\r\n\r\n        // Apply filters\r\n        let filtered = studentsWithEnrollments;\r\n        if (filters?.status === 'active') {\r\n            filtered = filtered?.filter(s => s.totalEnrollments > 0);\r\n        } else if (filters?.status === 'expired') {\r\n            filtered = filtered?.filter(s => {\r\n                const hasExpired = (s.enrollments || []).some(e => {\r\n                    if (!e.expires_at) return false;\r\n                    return new Date(e.expires_at) < new Date();\r\n                });\r\n                return hasExpired;\r\n            });\r\n        }\r\n\r\n        return { success: true, data: filtered };\r\n    } catch (error: any) {\r\n        return { error: error.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Get exam attempts for a specific student\r\n */\r\nexport async function getStudentAttempts(userId: string) {\r\n    const supabase = createAdminClient();\r\n\r\n    try {\r\n        const { data: rawData, error } = await supabase\r\n            .from('exam_attempts')\r\n            .select(`\r\n                *,\r\n                exams (\r\n                    id,\r\n                    title,\r\n                    total_marks\r\n                ),\r\n                results (*)\r\n            `)\r\n            .eq('student_id', userId)\r\n            .order('created_at', { ascending: false });\r\n\r\n        if (error) throw error;\r\n\r\n        // Flatten results\r\n        const data = rawData?.map(att => ({\r\n            ...att,\r\n            results: Array.isArray(att.results) ? att.results[0] : att.results\r\n        })) || [];\r\n\r\n        return { success: true, data };\r\n    } catch (error: any) {\r\n        return { error: error.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Get detailed info for a single student with stats\r\n */\r\nexport async function getStudentDetails(userId: string) {\r\n    try {\r\n        const supabase = createAdminClient();\r\n\r\n        // Get student profile\r\n        const { data: student, error: studentError } = await supabase\r\n            .from('profiles')\r\n            .select('*')\r\n            .eq('id', userId)\r\n            .single();\r\n\r\n        if (studentError) {\r\n            console.error('Student fetch error:', studentError);\r\n            throw new Error(`Failed to fetch student profile: ${studentError.message}`);\r\n        }\r\n\r\n        if (!student) {\r\n            return { error: 'Student not found' };\r\n        }\r\n\r\n        // Get active sessions count\r\n        // Note: Accessing auth schema may require special permissions\r\n        let activeSessions = 0;\r\n        try {\r\n            const { count, error: sessionsError } = await supabase\r\n                .schema('auth')\r\n                .from('sessions')\r\n                .select('*', { count: 'exact', head: true })\r\n                .eq('user_id', userId);\r\n\r\n            if (sessionsError) {\r\n                console.error('Session count error:', sessionsError);\r\n            } else {\r\n                activeSessions = count || 0;\r\n            }\r\n        } catch (err) {\r\n            console.error('Failed to fetch session count:', err);\r\n            // Fallback: activeSessions remains 0\r\n        }\r\n\r\n        // Get enrollments\r\n        const { data: enrollments, error: enrollmentsError } = await supabase\r\n            .from('enrollments')\r\n            .select(`\r\n                *,\r\n                courses (\r\n                    id,\r\n                    title,\r\n                    thumbnail_url,\r\n                    price,\r\n                    course_type\r\n                ),\r\n                granted_by_profile:profiles!enrollments_granted_by_fkey (\r\n                    id,\r\n                    full_name\r\n                )\r\n            `)\r\n            .eq('user_id', userId);\r\n\r\n        if (enrollmentsError) {\r\n            console.error('Enrollments fetch error:', enrollmentsError);\r\n            // Don't throw, just log and continue with empty array\r\n        }\r\n\r\n\r\n\r\n        const { data: rawAttempts, error: attemptsError } = await supabase\r\n            .from('exam_attempts')\r\n            .select(`\r\n                *,\r\n                exams (id, title, total_marks),\r\n                results (percentage, obtained_marks)\r\n            `)\r\n            .eq('student_id', userId)\r\n            .order('created_at', { ascending: false });\r\n\r\n        if (attemptsError) {\r\n            console.error('Exam attempts fetch error:', attemptsError);\r\n            // Don't throw, just log and continue with empty array\r\n        }\r\n\r\n        // Transform attempts to handle singular results object\r\n        const attempts = rawAttempts?.map(att => ({\r\n            ...att,\r\n            results: Array.isArray(att.results) ? att.results[0] : att.results\r\n        })) || [];\r\n\r\n        // Get enrollment logs\r\n        const enrollmentIds = enrollments?.map(e => e.id) || [];\r\n\r\n        let logs: any[] = [];\r\n        if (enrollmentIds.length > 0) {\r\n            const { data: logData, error: logsError } = await supabase\r\n                .from('enrollment_logs')\r\n                .select(`\r\n                    *,\r\n                    performed_by_profile:profiles!enrollment_logs_performed_by_fkey (\r\n                        id,\r\n                        full_name\r\n                    )\r\n                `)\r\n                .in('enrollment_id', enrollmentIds)\r\n                .order('created_at', { ascending: false })\r\n                .limit(50);\r\n\r\n            if (logsError) {\r\n                console.error('Enrollment logs fetch error:', logsError);\r\n                // Don't throw, just log and continue with empty array\r\n            } else {\r\n                logs = logData || [];\r\n            }\r\n        }\r\n\r\n        // Calculate Stats\r\n        const submittedAttempts = attempts.filter(a => a.status === 'submitted');\r\n        const avgPercentage = submittedAttempts.length > 0\r\n            ? submittedAttempts.reduce((acc, curr) => acc + (curr.results?.percentage || 0), 0) / submittedAttempts.length\r\n            : 0;\r\n\r\n        return {\r\n            success: true,\r\n            data: {\r\n                student,\r\n                enrollments: enrollments || [],\r\n                attempts: attempts || [],\r\n                logs,\r\n                activeSessions,\r\n                stats: {\r\n                    totalEnrollments: enrollments?.length || 0,\r\n                    totalAttempts: attempts?.length || 0,\r\n                    avgPercentage: Math.round(avgPercentage * 10) / 10\r\n                }\r\n            }\r\n        };\r\n    } catch (error: any) {\r\n        console.error('getStudentDetails error:', error);\r\n        return { error: error?.message || 'An unexpected error occurred while fetching student details' };\r\n    }\r\n}\r\n\r\n/**\r\n * Reset all active sessions for a student (admin only)\r\n */\r\nexport async function resetStudentSessions(userId: string) {\r\n    const supabase = createAdminClient();\r\n\r\n    try {\r\n        // Delete all sessions for this user\r\n        const { error: sessionError } = await supabase\r\n            .schema('auth')\r\n            .from('sessions')\r\n            .delete()\r\n            .eq('user_id', userId);\r\n\r\n        if (sessionError) throw sessionError;\r\n\r\n        // Also delete refresh tokens to ensure they can't get a new session\r\n        const { error: tokenError } = await supabase\r\n            .schema('auth')\r\n            .from('refresh_tokens')\r\n            .delete()\r\n            .eq('user_id', userId);\r\n\r\n        // Note: tokenError might happen if they have no tokens, we can be lenient or log it\r\n\r\n        revalidatePath(`/admin/students/${userId}`);\r\n        return { success: true, message: 'All active sessions have been reset' };\r\n    } catch (error: any) {\r\n        console.error('Reset sessions error:', error);\r\n        return { error: error.message };\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;IAuZsB,uBAAA,WAAA,GAAA,IAAA,kOAAA,EAAA,8CAAA,4LAAA,EAAA,KAAA,GAAA,gNAAA,EAAA"}},
    {"offset": {"line": 49, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/hooks/admin/useAdminStudents.ts"],"sourcesContent":["import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\r\nimport { getStudentsWithEnrollments, addStudent, resetStudentSessions } from '@/actions/admin/students';\r\nimport { createClient } from '@/lib/supabase/client';\r\nimport { toast } from 'sonner';\r\n\r\nexport function useAdminStudents(filters?: { status?: 'all' | 'active' | 'expired'; expiringWithinDays?: number }) {\r\n    return useQuery({\r\n        queryKey: ['admin-students', filters],\r\n        queryFn: async () => {\r\n            const res = await getStudentsWithEnrollments(filters);\r\n            if (res.error) throw new Error(res.error);\r\n            return res.data || [];\r\n        },\r\n        staleTime: 1000 * 60 * 10, // 10 minutes\r\n        gcTime: 1000 * 60 * 30,    // 30 minutes\r\n    });\r\n}\r\n\r\nexport function useStudentDetails(userId: string) {\r\n    return useQuery({\r\n        queryKey: ['admin-student-details', userId],\r\n        queryFn: async () => {\r\n            if (!userId) return null;\r\n\r\n            const supabase = createClient();\r\n\r\n            // Get student profile\r\n            const { data: student, error: studentError } = await supabase\r\n                .from('profiles')\r\n                .select('*')\r\n                .eq('id', userId)\r\n                .single();\r\n\r\n            if (studentError) throw new Error(`Failed to fetch student: ${studentError.message}`);\r\n            if (!student) throw new Error('Student not found');\r\n\r\n            // Get enrollments\r\n            const { data: enrollments } = await supabase\r\n                .from('enrollments')\r\n                .select(`\r\n                    *,\r\n                    courses (\r\n                        id,\r\n                        title,\r\n                        thumbnail_url,\r\n                        price,\r\n                        course_type\r\n                    ),\r\n                    granted_by_profile:profiles!enrollments_granted_by_fkey (\r\n                        id,\r\n                        full_name\r\n                    )\r\n                `)\r\n                .eq('user_id', userId);\r\n\r\n            // Get exam attempts\r\n            const { data: rawAttempts, error } = await supabase\r\n                .from('exam_attempts')\r\n                .select(`\r\n                    *,\r\n                    exams (id, title, total_marks),\r\n                    results (percentage, obtained_marks)\r\n                `)\r\n                .eq('student_id', userId)\r\n                .order('created_at', { ascending: false });\r\n            const attempts = rawAttempts?.map((attempt: any) => ({\r\n                ...attempt,\r\n                exam_title: attempt.exams?.title,\r\n                total_marks: attempt.exams?.total_marks,\r\n                percentage: attempt.results?.[0]?.percentage,\r\n                obtained_marks: attempt.results?.[0]?.obtained_marks\r\n            })) || [];\r\n\r\n\r\n            // Get activity logs\r\n            const { data: logs } = await supabase\r\n                .from('enrollment_logs')\r\n                .select('*')\r\n                .eq('user_id', userId)\r\n                .order('created_at', { ascending: false })\r\n                .limit(50);\r\n\r\n            // Calculate stats\r\n            const stats = {\r\n                totalEnrollments: enrollments?.length || 0,\r\n                activeEnrollments: enrollments?.filter((e: any) => e.status === 'active').length || 0,\r\n                totalAttempts: attempts.length,\r\n                averageScore: attempts.length > 0\r\n                    ? Math.round(attempts.reduce((sum: number, a: any) => sum + (a.percentage || 0), 0) / attempts.length)\r\n                    : 0,\r\n                avgPercentage: attempts.length > 0\r\n                    ? Math.round(attempts.reduce((sum: number, a: any) => sum + (a.percentage || 0), 0) / attempts.length)\r\n                    : 0,\r\n                activeSessions: 0 // Will be populated from device_sessions if needed\r\n            };\r\n\r\n            return {\r\n                student,\r\n                enrollments: enrollments || [],\r\n                attempts,\r\n                logs: logs || [],\r\n                stats\r\n            };\r\n        },\r\n        enabled: !!userId,\r\n        staleTime: 1000 * 60 * 5, // 5 minutes\r\n    });\r\n}\r\n\r\nexport function useAddStudent() {\r\n    const queryClient = useQueryClient();\r\n    return useMutation({\r\n        mutationFn: addStudent,\r\n        onSuccess: (res) => {\r\n            if (res.success) {\r\n                toast.success(res.message || 'Student added successfully');\r\n                queryClient.invalidateQueries({ queryKey: ['admin-students'] });\r\n            } else if (res.error) {\r\n                toast.error(res.error);\r\n            }\r\n        },\r\n        onError: (error: any) => {\r\n            toast.error(error.message || 'Failed to add student');\r\n        }\r\n    });\r\n}\r\n\r\nexport function useResetSessions() {\r\n    const queryClient = useQueryClient();\r\n    return useMutation({\r\n        mutationFn: resetStudentSessions,\r\n        onSuccess: (res, userId) => {\r\n            if (res.success) {\r\n                toast.success(res.message);\r\n                queryClient.invalidateQueries({ queryKey: ['admin-student-details', userId] });\r\n            } else if (res.error) {\r\n                toast.error(res.error);\r\n            }\r\n        },\r\n        onError: (error: any) => {\r\n            toast.error(error.message || 'Failed to reset sessions');\r\n        }\r\n    });\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 201, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/components/ui/checkbox.tsx"],"sourcesContent":["'use client'\r\n\r\nimport * as React from 'react'\r\nimport * as CheckboxPrimitive from '@radix-ui/react-checkbox'\r\nimport { CheckIcon } from 'lucide-react'\r\n\r\nimport { cn } from '@/lib/utils'\r\n\r\nfunction Checkbox({\r\n  className,\r\n  ...props\r\n}: React.ComponentProps<typeof CheckboxPrimitive.Root>) {\r\n  return (\r\n    <CheckboxPrimitive.Root\r\n      data-slot=\"checkbox\"\r\n      className={cn(\r\n        'peer border-input dark:bg-input/30 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground dark:data-[state=checked]:bg-primary data-[state=checked]:border-primary focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive size-4 shrink-0 rounded-[4px] border shadow-xs transition-shadow outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50',\r\n        className,\r\n      )}\r\n      {...props}\r\n    >\r\n      <CheckboxPrimitive.Indicator\r\n        data-slot=\"checkbox-indicator\"\r\n        className=\"flex items-center justify-center text-current transition-none\"\r\n      >\r\n        <CheckIcon className=\"size-3.5\" />\r\n      </CheckboxPrimitive.Indicator>\r\n    </CheckboxPrimitive.Root>\r\n  )\r\n}\r\n\r\nexport { Checkbox }\r\n"],"names":[],"mappings":";;;;;AAGA;AACA;AAEA;AANA;;;;;AAQA,SAAS,SAAS,EAChB,SAAS,EACT,GAAG,OACiD;IACpD,qBACE,kMAAC,oLAAsB;QACrB,aAAU;QACV,WAAW,IAAA,0HAAE,EACX,+eACA;QAED,GAAG,KAAK;kBAET,cAAA,kMAAC,yLAA2B;YAC1B,aAAU;YACV,WAAU;sBAEV,cAAA,kMAAC,6NAAS;gBAAC,WAAU;;;;;;;;;;;;;;;;AAI7B"}},
    {"offset": {"line": 245, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/components/admin/AddStudentDialog.tsx"],"sourcesContent":["'use client';\r\n\r\nimport { useState } from 'react';\r\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from '@/components/ui/dialog';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Label } from '@/components/ui/label';\r\nimport { Checkbox } from '@/components/ui/checkbox';\r\nimport { addStudent } from '@/actions/admin/students';\r\nimport { toast } from 'sonner';\r\nimport { Loader2, UserPlus, Mail, User, Sparkles } from 'lucide-react';\r\n\r\ninterface AddStudentDialogProps {\r\n    open: boolean;\r\n    onOpenChange: (open: boolean) => void;\r\n    onSuccess?: () => void;\r\n}\r\n\r\nexport function AddStudentDialog({ open, onOpenChange, onSuccess }: AddStudentDialogProps) {\r\n    const [loading, setLoading] = useState(false);\r\n    const [formData, setFormData] = useState({\r\n        email: '',\r\n        fullName: '',\r\n        sendInvite: true\r\n    });\r\n\r\n    const handleSubmit = async (e: React.FormEvent) => {\r\n        e.preventDefault();\r\n        setLoading(true);\r\n\r\n        try {\r\n            const result = await addStudent(formData);\r\n\r\n            if (result.error) {\r\n                toast.error(result.error);\r\n            } else {\r\n                toast.success(result.message || 'Student added successfully! 🎉');\r\n                onOpenChange(false);\r\n                setFormData({ email: '', fullName: '', sendInvite: true });\r\n                onSuccess?.();\r\n            }\r\n        } catch (error: any) {\r\n            toast.error(error.message || 'Failed to add student');\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <Dialog open={open} onOpenChange={onOpenChange}>\r\n            <DialogContent className=\"sm:max-w-[500px] bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-800\">\r\n                {/* Decorative gradient header */}\r\n                <div className=\"absolute top-0 left-0 right-0 h-1 bg-linear-to-r from-violet-500 via-purple-500 to-fuchsia-500\" />\r\n\r\n                <DialogHeader className=\"space-y-3 pt-2\">\r\n                    <div className=\"flex items-center gap-3\">\r\n                        <div className=\"p-2.5 rounded-xl bg-linear-to-br from-violet-500 to-purple-600 shadow-lg shadow-violet-200 dark:shadow-none\">\r\n                            <UserPlus className=\"w-5 h-5 text-white\" />\r\n                        </div>\r\n                        <div>\r\n                            <DialogTitle className=\"text-2xl font-bold tracking-tight text-slate-900 dark:text-white\">\r\n                                Add New Student\r\n                            </DialogTitle>\r\n                            <DialogDescription className=\"text-sm text-slate-500 dark:text-slate-400\">\r\n                                Manually create a student account and grant access\r\n                            </DialogDescription>\r\n                        </div>\r\n                    </div>\r\n                </DialogHeader>\r\n\r\n                <form onSubmit={handleSubmit} className=\"space-y-5 mt-4\">\r\n                    {/* Email Input */}\r\n                    <div className=\"space-y-2\">\r\n                        <Label htmlFor=\"email\" className=\"text-sm font-semibold text-slate-700 dark:text-slate-300 flex items-center gap-2\">\r\n                            <Mail className=\"w-4 h-4 text-violet-500\" />\r\n                            Email Address\r\n                        </Label>\r\n                        <Input\r\n                            id=\"email\"\r\n                            type=\"email\"\r\n                            placeholder=\"student@example.com\"\r\n                            value={formData.email}\r\n                            onChange={(e) => setFormData({ ...formData, email: e.target.value })}\r\n                            required\r\n                            className=\"h-11 bg-slate-50 dark:bg-slate-800/50 border-slate-200 dark:border-slate-700 focus:ring-2 focus:ring-violet-500 focus:border-transparent\"\r\n                        />\r\n                    </div>\r\n\r\n                    {/* Full Name Input */}\r\n                    <div className=\"space-y-2\">\r\n                        <Label htmlFor=\"fullName\" className=\"text-sm font-semibold text-slate-700 dark:text-slate-300 flex items-center gap-2\">\r\n                            <User className=\"w-4 h-4 text-purple-500\" />\r\n                            Full Name\r\n                        </Label>\r\n                        <Input\r\n                            id=\"fullName\"\r\n                            type=\"text\"\r\n                            placeholder=\"John Doe\"\r\n                            value={formData.fullName}\r\n                            onChange={(e) => setFormData({ ...formData, fullName: e.target.value })}\r\n                            required\r\n                            className=\"h-11 bg-slate-50 dark:bg-slate-800/50 border-slate-200 dark:border-slate-700 focus:ring-2 focus:ring-purple-500 focus:border-transparent\"\r\n                        />\r\n                    </div>\r\n\r\n                    {/* Send Invite Checkbox */}\r\n                    <div className=\"flex items-center space-x-3 p-4 rounded-xl bg-violet-50 dark:bg-violet-500/10 border border-violet-200 dark:border-violet-500/20\">\r\n                        <Checkbox\r\n                            id=\"sendInvite\"\r\n                            checked={formData.sendInvite}\r\n                            onCheckedChange={(checked) => setFormData({ ...formData, sendInvite: checked as boolean })}\r\n                            className=\"border-violet-300 dark:border-violet-600\"\r\n                        />\r\n                        <div className=\"grid gap-0.5 leading-none\">\r\n                            <label\r\n                                htmlFor=\"sendInvite\"\r\n                                className=\"text-sm font-medium text-violet-900 dark:text-violet-100 cursor-pointer flex items-center gap-1.5\"\r\n                            >\r\n                                <Sparkles className=\"w-3.5 h-3.5\" />\r\n                                Send welcome email\r\n                            </label>\r\n                            <p className=\"text-xs text-violet-600 dark:text-violet-400\">\r\n                                Student will receive an invite to join the platform\r\n                            </p>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Action Buttons */}\r\n                    <div className=\"flex gap-3 pt-2\">\r\n                        <Button\r\n                            type=\"button\"\r\n                            variant=\"outline\"\r\n                            onClick={() => onOpenChange(false)}\r\n                            className=\"flex-1 h-11 border-slate-200 dark:border-slate-700\"\r\n                            disabled={loading}\r\n                        >\r\n                            Cancel\r\n                        </Button>\r\n                        <Button\r\n                            type=\"submit\"\r\n                            disabled={loading}\r\n                            className=\"flex-1 h-11 bg-linear-to-r from-violet-600 to-purple-600 hover:from-violet-700 hover:to-purple-700 text-white shadow-lg shadow-violet-200 dark:shadow-none transition-all\"\r\n                        >\r\n                            {loading ? (\r\n                                <>\r\n                                    <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\r\n                                    Adding...\r\n                                </>\r\n                            ) : (\r\n                                <>\r\n                                    <UserPlus className=\"w-4 h-4 mr-2\" />\r\n                                    Add Student\r\n                                </>\r\n                            )}\r\n                        </Button>\r\n                    </div>\r\n                </form>\r\n            </DialogContent>\r\n        </Dialog>\r\n    );\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 593, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/actions/admin/students.ts"],"sourcesContent":["'use server';\r\n\r\nimport { createClient } from '@/lib/supabase/server';\r\nimport { createAdminClient } from '@/lib/supabase/admin';\r\nimport { revalidatePath } from 'next/cache';\r\n\r\n/**\r\n * Add a new student manually (admin only)\r\n * Returns student info if already exists, or creates an invitation\r\n */\r\nexport async function addStudent(data: {\r\n    email: string;\r\n    fullName: string;\r\n    sendInvite?: boolean;\r\n}) {\r\n    const supabase = await createClient();\r\n\r\n    // Check admin permission\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) return { error: 'Unauthorized' };\r\n\r\n    const { data: profile } = await supabase\r\n        .from('profiles')\r\n        .select('role')\r\n        .eq('id', user.id)\r\n        .single();\r\n\r\n    if (profile?.role !== 'admin') {\r\n        return { error: 'Admin access required' };\r\n    }\r\n\r\n    try {\r\n        // Check if student already exists in profiles\r\n        const { data: existing } = await supabase\r\n            .from('profiles')\r\n            .select('id, email, full_name')\r\n            .eq('email', data.email)\r\n            .single();\r\n\r\n        if (existing) {\r\n            return {\r\n                success: true,\r\n                data: existing,\r\n                message: 'Student already exists in the system'\r\n            };\r\n        }\r\n\r\n        // Send invitation email using Supabase Admin\r\n        if (data.sendInvite) {\r\n            const adminClient = createAdminClient();\r\n\r\n            // Invite user via Supabase Auth\r\n            const { data: inviteData, error: inviteError } = await adminClient.auth.admin.inviteUserByEmail(\r\n                data.email,\r\n                {\r\n                    data: {\r\n                        full_name: data.fullName,\r\n                        role: 'student'\r\n                    },\r\n                    redirectTo: `${process.env.NEXT_PUBLIC_SITE_URL || 'http://localhost:3000'}/auth/callback`\r\n                }\r\n            );\r\n\r\n            if (inviteError) {\r\n                console.error('Invitation error:', inviteError);\r\n                throw new Error(`Failed to send invitation: ${inviteError.message}`);\r\n            }\r\n\r\n            console.log(`✅ Invitation sent to ${data.email}`, inviteData);\r\n\r\n            // Create profile entry for the invited user\r\n            if (inviteData.user) {\r\n                const { error: profileError } = await adminClient\r\n                    .from('profiles')\r\n                    .insert({\r\n                        id: inviteData.user.id,\r\n                        email: data.email,\r\n                        full_name: data.fullName,\r\n                        role: 'student'\r\n                    });\r\n\r\n                if (profileError) {\r\n                    console.error('Profile creation error:', profileError);\r\n                    // Don't fail the whole operation if profile creation fails\r\n                    // The profile will be created on first login via callback\r\n                }\r\n            }\r\n\r\n            revalidatePath('/admin/students');\r\n            return {\r\n                success: true,\r\n                data: { email: data.email, full_name: data.fullName },\r\n                message: 'Invitation sent successfully! Student will receive an email to join.'\r\n            };\r\n        }\r\n\r\n        // If not sending invite, just return success\r\n        revalidatePath('/admin/students');\r\n        return {\r\n            success: true,\r\n            data: { email: data.email, full_name: data.fullName },\r\n            message: 'Student information saved. They can sign up normally.'\r\n        };\r\n    } catch (error: any) {\r\n        console.error('Add student error:', error);\r\n        return { error: error.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Search students by name or email\r\n */\r\nexport async function searchStudents(query: string) {\r\n    const supabase = await createClient();\r\n\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) return { error: 'Unauthorized' };\r\n\r\n    try {\r\n        const { data, error } = await supabase\r\n            .from('profiles')\r\n            .select('id, email, full_name, avatar_url, created_at')\r\n            .eq('role', 'student')\r\n            .or(`full_name.ilike.%${query}%,email.ilike.%${query}%`)\r\n            .order('full_name', { ascending: true })\r\n            .limit(20);\r\n\r\n        if (error) throw error;\r\n\r\n        return { success: true, data };\r\n    } catch (error: any) {\r\n        return { error: error.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Get all students with their enrollments and expiry info\r\n */\r\nexport async function getStudentsWithEnrollments(filters?: {\r\n    status?: 'all' | 'active' | 'expired';\r\n    expiringWithinDays?: number;\r\n}) {\r\n    const supabase = await createClient();\r\n\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) return { error: 'Unauthorized' };\r\n\r\n    try {\r\n        // Get all students\r\n        const { data: students, error: studentsError } = await supabase\r\n            .from('profiles')\r\n            .select(`\r\n        id,\r\n        email,\r\n        full_name,\r\n        avatar_url,\r\n        created_at\r\n      `)\r\n            .eq('role', 'student')\r\n            .order('created_at', { ascending: false });\r\n\r\n        if (studentsError) throw studentsError;\r\n\r\n        // Get enrollments for each student\r\n        const { data: enrollments, error: enrollmentsError } = await supabase\r\n            .from('enrollments')\r\n            .select(`\r\n        id,\r\n        user_id,\r\n        course_id,\r\n        status,\r\n        expires_at,\r\n        granted_by,\r\n        grant_type,\r\n        courses (\r\n          id,\r\n          title,\r\n          thumbnail_url\r\n        )\r\n      `);\r\n\r\n        if (enrollmentsError) throw enrollmentsError;\r\n\r\n\r\n\r\n        // Combine data\r\n        const studentsWithEnrollments = students?.map(student => {\r\n            const courseEnrollments = enrollments?.filter(e => e.user_id === student.id) || [];\r\n\r\n            // Check expiry status\r\n            const now = new Date();\r\n            const expiringSoon = courseEnrollments.filter(e => {\r\n                if (!e.expires_at) return false;\r\n                const expiryDate = new Date(e.expires_at);\r\n                const daysUntilExpiry = (expiryDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24);\r\n                return daysUntilExpiry > 0 && daysUntilExpiry <= (filters?.expiringWithinDays || 7);\r\n            });\r\n\r\n            return {\r\n                ...student,\r\n                enrollments: courseEnrollments,\r\n                totalEnrollments: courseEnrollments.length,\r\n                expiringSoonCount: expiringSoon.length\r\n            };\r\n        });\r\n\r\n        // Apply filters\r\n        let filtered = studentsWithEnrollments;\r\n        if (filters?.status === 'active') {\r\n            filtered = filtered?.filter(s => s.totalEnrollments > 0);\r\n        } else if (filters?.status === 'expired') {\r\n            filtered = filtered?.filter(s => {\r\n                const hasExpired = (s.enrollments || []).some(e => {\r\n                    if (!e.expires_at) return false;\r\n                    return new Date(e.expires_at) < new Date();\r\n                });\r\n                return hasExpired;\r\n            });\r\n        }\r\n\r\n        return { success: true, data: filtered };\r\n    } catch (error: any) {\r\n        return { error: error.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Get exam attempts for a specific student\r\n */\r\nexport async function getStudentAttempts(userId: string) {\r\n    const supabase = createAdminClient();\r\n\r\n    try {\r\n        const { data: rawData, error } = await supabase\r\n            .from('exam_attempts')\r\n            .select(`\r\n                *,\r\n                exams (\r\n                    id,\r\n                    title,\r\n                    total_marks\r\n                ),\r\n                results (*)\r\n            `)\r\n            .eq('student_id', userId)\r\n            .order('created_at', { ascending: false });\r\n\r\n        if (error) throw error;\r\n\r\n        // Flatten results\r\n        const data = rawData?.map(att => ({\r\n            ...att,\r\n            results: Array.isArray(att.results) ? att.results[0] : att.results\r\n        })) || [];\r\n\r\n        return { success: true, data };\r\n    } catch (error: any) {\r\n        return { error: error.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Get detailed info for a single student with stats\r\n */\r\nexport async function getStudentDetails(userId: string) {\r\n    try {\r\n        const supabase = createAdminClient();\r\n\r\n        // Get student profile\r\n        const { data: student, error: studentError } = await supabase\r\n            .from('profiles')\r\n            .select('*')\r\n            .eq('id', userId)\r\n            .single();\r\n\r\n        if (studentError) {\r\n            console.error('Student fetch error:', studentError);\r\n            throw new Error(`Failed to fetch student profile: ${studentError.message}`);\r\n        }\r\n\r\n        if (!student) {\r\n            return { error: 'Student not found' };\r\n        }\r\n\r\n        // Get active sessions count\r\n        // Note: Accessing auth schema may require special permissions\r\n        let activeSessions = 0;\r\n        try {\r\n            const { count, error: sessionsError } = await supabase\r\n                .schema('auth')\r\n                .from('sessions')\r\n                .select('*', { count: 'exact', head: true })\r\n                .eq('user_id', userId);\r\n\r\n            if (sessionsError) {\r\n                console.error('Session count error:', sessionsError);\r\n            } else {\r\n                activeSessions = count || 0;\r\n            }\r\n        } catch (err) {\r\n            console.error('Failed to fetch session count:', err);\r\n            // Fallback: activeSessions remains 0\r\n        }\r\n\r\n        // Get enrollments\r\n        const { data: enrollments, error: enrollmentsError } = await supabase\r\n            .from('enrollments')\r\n            .select(`\r\n                *,\r\n                courses (\r\n                    id,\r\n                    title,\r\n                    thumbnail_url,\r\n                    price,\r\n                    course_type\r\n                ),\r\n                granted_by_profile:profiles!enrollments_granted_by_fkey (\r\n                    id,\r\n                    full_name\r\n                )\r\n            `)\r\n            .eq('user_id', userId);\r\n\r\n        if (enrollmentsError) {\r\n            console.error('Enrollments fetch error:', enrollmentsError);\r\n            // Don't throw, just log and continue with empty array\r\n        }\r\n\r\n\r\n\r\n        const { data: rawAttempts, error: attemptsError } = await supabase\r\n            .from('exam_attempts')\r\n            .select(`\r\n                *,\r\n                exams (id, title, total_marks),\r\n                results (percentage, obtained_marks)\r\n            `)\r\n            .eq('student_id', userId)\r\n            .order('created_at', { ascending: false });\r\n\r\n        if (attemptsError) {\r\n            console.error('Exam attempts fetch error:', attemptsError);\r\n            // Don't throw, just log and continue with empty array\r\n        }\r\n\r\n        // Transform attempts to handle singular results object\r\n        const attempts = rawAttempts?.map(att => ({\r\n            ...att,\r\n            results: Array.isArray(att.results) ? att.results[0] : att.results\r\n        })) || [];\r\n\r\n        // Get enrollment logs\r\n        const enrollmentIds = enrollments?.map(e => e.id) || [];\r\n\r\n        let logs: any[] = [];\r\n        if (enrollmentIds.length > 0) {\r\n            const { data: logData, error: logsError } = await supabase\r\n                .from('enrollment_logs')\r\n                .select(`\r\n                    *,\r\n                    performed_by_profile:profiles!enrollment_logs_performed_by_fkey (\r\n                        id,\r\n                        full_name\r\n                    )\r\n                `)\r\n                .in('enrollment_id', enrollmentIds)\r\n                .order('created_at', { ascending: false })\r\n                .limit(50);\r\n\r\n            if (logsError) {\r\n                console.error('Enrollment logs fetch error:', logsError);\r\n                // Don't throw, just log and continue with empty array\r\n            } else {\r\n                logs = logData || [];\r\n            }\r\n        }\r\n\r\n        // Calculate Stats\r\n        const submittedAttempts = attempts.filter(a => a.status === 'submitted');\r\n        const avgPercentage = submittedAttempts.length > 0\r\n            ? submittedAttempts.reduce((acc, curr) => acc + (curr.results?.percentage || 0), 0) / submittedAttempts.length\r\n            : 0;\r\n\r\n        return {\r\n            success: true,\r\n            data: {\r\n                student,\r\n                enrollments: enrollments || [],\r\n                attempts: attempts || [],\r\n                logs,\r\n                activeSessions,\r\n                stats: {\r\n                    totalEnrollments: enrollments?.length || 0,\r\n                    totalAttempts: attempts?.length || 0,\r\n                    avgPercentage: Math.round(avgPercentage * 10) / 10\r\n                }\r\n            }\r\n        };\r\n    } catch (error: any) {\r\n        console.error('getStudentDetails error:', error);\r\n        return { error: error?.message || 'An unexpected error occurred while fetching student details' };\r\n    }\r\n}\r\n\r\n/**\r\n * Reset all active sessions for a student (admin only)\r\n */\r\nexport async function resetStudentSessions(userId: string) {\r\n    const supabase = createAdminClient();\r\n\r\n    try {\r\n        // Delete all sessions for this user\r\n        const { error: sessionError } = await supabase\r\n            .schema('auth')\r\n            .from('sessions')\r\n            .delete()\r\n            .eq('user_id', userId);\r\n\r\n        if (sessionError) throw sessionError;\r\n\r\n        // Also delete refresh tokens to ensure they can't get a new session\r\n        const { error: tokenError } = await supabase\r\n            .schema('auth')\r\n            .from('refresh_tokens')\r\n            .delete()\r\n            .eq('user_id', userId);\r\n\r\n        // Note: tokenError might happen if they have no tokens, we can be lenient or log it\r\n\r\n        revalidatePath(`/admin/students/${userId}`);\r\n        return { success: true, message: 'All active sessions have been reset' };\r\n    } catch (error: any) {\r\n        console.error('Reset sessions error:', error);\r\n        return { error: error.message };\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;IAgHsB,iBAAA,WAAA,GAAA,IAAA,kOAAA,EAAA,8CAAA,4LAAA,EAAA,KAAA,GAAA,gNAAA,EAAA"}},
    {"offset": {"line": 608, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/actions/admin/grantAccess.ts"],"sourcesContent":["'use server';\r\n\r\nimport { createClient } from '@/lib/supabase/server';\r\nimport { revalidatePath } from 'next/cache';\r\n\r\n/**\r\n * Grant course access to a student with optional expiry\r\n */\r\nexport async function grantCourseAccess(data: {\r\n    userId: string;\r\n    courseId: string;\r\n    expiresAt?: Date | null;\r\n    notes?: string;\r\n}) {\r\n    const supabase = await createClient();\r\n\r\n    // Get admin user\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) return { error: 'Unauthorized' };\r\n\r\n    const { data: profile } = await supabase\r\n        .from('profiles')\r\n        .select('role')\r\n        .eq('id', user.id)\r\n        .single();\r\n\r\n    if (profile?.role !== 'admin') {\r\n        return { error: 'Admin access required' };\r\n    }\r\n\r\n    try {\r\n        // Check if enrollment already exists\r\n        const { data: existing } = await supabase\r\n            .from('enrollments')\r\n            .select('id, status, expires_at')\r\n            .eq('user_id', data.userId)\r\n            .eq('course_id', data.courseId)\r\n            .single();\r\n\r\n        let enrollment;\r\n\r\n        if (existing) {\r\n            // Update existing enrollment\r\n            const { data: updated, error } = await supabase\r\n                .from('enrollments')\r\n                .update({\r\n                    status: 'active',\r\n                    expires_at: data.expiresAt || null,\r\n                    granted_by: user.id,\r\n                    granted_at: new Date().toISOString(),\r\n                    grant_type: 'manual'\r\n                })\r\n                .eq('id', existing.id)\r\n                .select()\r\n                .single();\r\n\r\n            if (error) throw error;\r\n            enrollment = updated;\r\n\r\n            // Log the modification\r\n            await supabase.rpc('log_enrollment_action', {\r\n                p_action: 'modified',\r\n                p_performed_by: user.id,\r\n                p_enrollment_id: existing.id,\r\n                p_previous_expiry: existing.expires_at,\r\n                p_new_expiry: data.expiresAt || null,\r\n                p_notes: data.notes || 'Access modified by admin'\r\n            });\r\n        } else {\r\n            // Create new enrollment\r\n            const { data: newEnrollment, error } = await supabase\r\n                .from('enrollments')\r\n                .insert({\r\n                    user_id: data.userId,\r\n                    course_id: data.courseId,\r\n                    status: 'active',\r\n                    expires_at: data.expiresAt || null,\r\n                    granted_by: user.id,\r\n                    granted_at: new Date().toISOString(),\r\n                    grant_type: 'manual'\r\n                })\r\n                .select()\r\n                .single();\r\n\r\n            if (error) throw error;\r\n            enrollment = newEnrollment;\r\n\r\n            // Log the grant\r\n            await supabase.rpc('log_enrollment_action', {\r\n                p_action: 'granted',\r\n                p_performed_by: user.id,\r\n                p_enrollment_id: newEnrollment.id,\r\n                p_new_expiry: data.expiresAt || null,\r\n                p_notes: data.notes || 'Access granted by admin'\r\n            });\r\n        }\r\n\r\n        revalidatePath('/admin/students');\r\n        return { success: true, data: enrollment };\r\n    } catch (error: any) {\r\n        return { error: error.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Grant test series access to a student\r\n */\r\nexport async function grantTestSeriesAccess(data: {\r\n    userId: string;\r\n    testSeriesId: string;\r\n    expiresAt?: Date | null;\r\n    notes?: string;\r\n}) {\r\n    const supabase = await createClient();\r\n\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) return { error: 'Unauthorized' };\r\n\r\n    const { data: profile } = await supabase\r\n        .from('profiles')\r\n        .select('role')\r\n        .eq('id', user.id)\r\n        .single();\r\n\r\n    if (profile?.role !== 'admin') {\r\n        return { error: 'Admin access required' };\r\n    }\r\n\r\n    try {\r\n        // Check if enrollment already exists\r\n        const { data: existing } = await supabase\r\n            .from('enrollments')\r\n            .select('id, expires_at')\r\n            .eq('user_id', data.userId)\r\n            .eq('course_id', data.testSeriesId)\r\n            .single();\r\n\r\n        let enrollment;\r\n\r\n        if (existing) {\r\n            // Update existing\r\n            const { data: updated, error } = await supabase\r\n                .from('enrollments')\r\n                .update({\r\n                    expires_at: data.expiresAt || null,\r\n                    granted_by: user.id,\r\n                    granted_at: new Date().toISOString(),\r\n                    grant_type: 'manual'\r\n                })\r\n                .eq('id', existing.id)\r\n                .select()\r\n                .single();\r\n\r\n            if (error) throw error;\r\n            enrollment = updated;\r\n\r\n            // Log\r\n            await supabase.rpc('log_enrollment_action', {\r\n                p_action: 'modified',\r\n                p_performed_by: user.id,\r\n                p_enrollment_id: existing.id,\r\n                p_previous_expiry: existing.expires_at,\r\n                p_new_expiry: data.expiresAt || null,\r\n                p_notes: data.notes || 'Test series access modified'\r\n            });\r\n        } else {\r\n            // Create new\r\n            const { data: newEnrollment, error } = await supabase\r\n                .from('enrollments')\r\n                .insert({\r\n                    user_id: data.userId,\r\n                    course_id: data.testSeriesId,\r\n                    expires_at: data.expiresAt || null,\r\n                    granted_by: user.id,\r\n                    granted_at: new Date().toISOString(),\r\n                    grant_type: 'manual',\r\n                    status: 'active'\r\n                })\r\n                .select()\r\n                .single();\r\n\r\n            if (error) throw error;\r\n            enrollment = newEnrollment;\r\n\r\n            // Log\r\n            await supabase.rpc('log_enrollment_action', {\r\n                p_action: 'granted',\r\n                p_performed_by: user.id,\r\n                p_enrollment_id: newEnrollment.id,\r\n                p_new_expiry: data.expiresAt || null,\r\n                p_notes: data.notes || 'Test series access granted'\r\n            });\r\n        }\r\n\r\n        revalidatePath('/admin/students');\r\n        return { success: true, data: enrollment };\r\n    } catch (error: any) {\r\n        return { error: error.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Revoke course or test series access\r\n */\r\nexport async function revokeAccess(data: {\r\n    enrollmentId: string;\r\n    type: 'course';\r\n    reason: string;\r\n}) {\r\n    const supabase = await createClient();\r\n\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) return { error: 'Unauthorized' };\r\n\r\n    try {\r\n        if (data.type === 'course') {\r\n            const { error } = await supabase\r\n                .from('enrollments')\r\n                .update({ status: 'refunded' }) // Using 'refunded' to indicate revoked\r\n                .eq('id', data.enrollmentId);\r\n\r\n            if (error) throw error;\r\n\r\n            // Log\r\n            await supabase.rpc('log_enrollment_action', {\r\n                p_action: 'revoked',\r\n                p_performed_by: user.id,\r\n                p_enrollment_id: data.enrollmentId,\r\n                p_notes: data.reason\r\n            });\r\n        } else {\r\n            const { error } = await supabase\r\n                .from('enrollments')\r\n                .update({ status: 'refunded' })\r\n                .eq('id', data.enrollmentId);\r\n\r\n            if (error) throw error;\r\n\r\n            // Log\r\n            await supabase.rpc('log_enrollment_action', {\r\n                p_action: 'revoked',\r\n                p_performed_by: user.id,\r\n                p_enrollment_id: data.enrollmentId,\r\n                p_notes: data.reason\r\n            });\r\n        }\r\n\r\n        revalidatePath('/admin/students');\r\n        return { success: true };\r\n    } catch (error: any) {\r\n        return { error: error.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Extend access expiry date\r\n */\r\nexport async function extendAccess(data: {\r\n    enrollmentId: string;\r\n    type: 'course';\r\n    newExpiryDate: Date;\r\n    notes?: string;\r\n}) {\r\n    const supabase = await createClient();\r\n\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) return { error: 'Unauthorized' };\r\n\r\n    console.log('[extendAccess] Starting update:', {\r\n        enrollmentId: data.enrollmentId,\r\n        type: data.type,\r\n        newExpiryDate: data.newExpiryDate,\r\n        isoDate: data.newExpiryDate.toISOString()\r\n    });\r\n\r\n    try {\r\n        let previousExpiry;\r\n        let updateError;\r\n\r\n        if (data.type === 'course') {\r\n            // Get current enrollment\r\n            const { data: existing, error: fetchError } = await supabase\r\n                .from('enrollments')\r\n                .select('expires_at, user_id')\r\n                .eq('id', data.enrollmentId)\r\n                .single();\r\n\r\n            if (fetchError) {\r\n                console.error('[extendAccess] Error fetching enrollment:', fetchError);\r\n                throw new Error(`Failed to find enrollment: ${fetchError.message}`);\r\n            }\r\n\r\n            console.log('[extendAccess] Current enrollment:', existing);\r\n            previousExpiry = existing?.expires_at;\r\n\r\n            // Update the expiry date\r\n            const { data: updated, error } = await supabase\r\n                .from('enrollments')\r\n                .update({\r\n                    expires_at: data.newExpiryDate.toISOString(),\r\n                    updated_at: new Date().toISOString()\r\n                })\r\n                .eq('id', data.enrollmentId)\r\n                .select();\r\n\r\n            updateError = error;\r\n            console.log('[extendAccess] Update result:', { updated, error });\r\n\r\n            if (error) throw error;\r\n\r\n            if (!updated || updated.length === 0) {\r\n                throw new Error('No rows were updated. Enrollment may not exist.');\r\n            }\r\n\r\n            // Verify the update\r\n            const { data: verified } = await supabase\r\n                .from('enrollments')\r\n                .select('expires_at')\r\n                .eq('id', data.enrollmentId)\r\n                .single();\r\n\r\n            console.log('[extendAccess] Verified expiry after update:', verified);\r\n\r\n            if (!verified?.expires_at) {\r\n                throw new Error('Update succeeded but expires_at is still null');\r\n            }\r\n\r\n            // Log the action\r\n            await supabase.rpc('log_enrollment_action', {\r\n                p_action: 'extended',\r\n                p_performed_by: user.id,\r\n                p_enrollment_id: data.enrollmentId,\r\n                p_previous_expiry: previousExpiry,\r\n                p_new_expiry: data.newExpiryDate.toISOString(),\r\n                p_notes: data.notes || 'Access period extended'\r\n            });\r\n        } else {\r\n            // Test series enrollment\r\n            const { data: existing, error: fetchError } = await supabase\r\n                .from('enrollments')\r\n                .select('expires_at, user_id')\r\n                .eq('id', data.enrollmentId)\r\n                .single();\r\n\r\n            if (fetchError) {\r\n                console.error('[extendAccess] Error fetching test series enrollment:', fetchError);\r\n                throw new Error(`Failed to find test series enrollment: ${fetchError.message}`);\r\n            }\r\n\r\n            console.log('[extendAccess] Current test series enrollment:', existing);\r\n            previousExpiry = existing?.expires_at;\r\n\r\n            const { data: updated, error } = await supabase\r\n                .from('enrollments')\r\n                .update({\r\n                    expires_at: data.newExpiryDate.toISOString(),\r\n                    updated_at: new Date().toISOString()\r\n                })\r\n                .eq('id', data.enrollmentId)\r\n                .select();\r\n\r\n            updateError = error;\r\n            console.log('[extendAccess] Test series update result:', { updated, error });\r\n\r\n            if (error) throw error;\r\n\r\n            if (!updated || updated.length === 0) {\r\n                throw new Error('No rows were updated. Test series enrollment may not exist.');\r\n            }\r\n\r\n            // Verify the update\r\n            const { data: verified } = await supabase\r\n                .from('enrollments')\r\n                .select('expires_at')\r\n                .eq('id', data.enrollmentId)\r\n                .single();\r\n\r\n            console.log('[extendAccess] Verified test series expiry after update:', verified);\r\n\r\n            if (!verified?.expires_at) {\r\n                throw new Error('Update succeeded but expires_at is still null');\r\n            }\r\n\r\n            // Log the action\r\n            await supabase.rpc('log_enrollment_action', {\r\n                p_action: 'extended',\r\n                p_performed_by: user.id,\r\n                p_enrollment_id: data.enrollmentId,\r\n                p_previous_expiry: previousExpiry,\r\n                p_new_expiry: data.newExpiryDate.toISOString(),\r\n                p_notes: data.notes || 'Access period extended'\r\n            });\r\n        }\r\n\r\n        console.log('[extendAccess] Update completed successfully');\r\n        revalidatePath('/admin/students');\r\n        return { success: true };\r\n    } catch (error: any) {\r\n        console.error('[extendAccess] Error:', error);\r\n        return { error: error.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Get expiring subscriptions (within specified days)\r\n */\r\nexport async function getExpiringSubscriptions(daysAhead: number = 7) {\r\n    const supabase = await createClient();\r\n\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) return { error: 'Unauthorized' };\r\n\r\n    try {\r\n        const { data, error } = await supabase\r\n            .from('expiring_enrollments_view')\r\n            .select('*')\r\n            .lte('days_until_expiry', daysAhead)\r\n            .order('days_until_expiry', { ascending: true });\r\n\r\n        if (error) throw error;\r\n\r\n        return { success: true, data };\r\n    } catch (error: any) {\r\n        return { error: error.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Get recent enrollment logs\r\n */\r\nexport async function getRecentAccessLogs(limit: number = 50) {\r\n    const supabase = await createClient();\r\n\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) return { error: 'Unauthorized' };\r\n\r\n    try {\r\n        const { data, error } = await supabase\r\n            .from('enrollment_logs')\r\n            .select(`\r\n        *,\r\n        performed_by_profile:profiles!enrollment_logs_performed_by_fkey (\r\n          id,\r\n          full_name,\r\n          email\r\n        )\r\n      `)\r\n            .order('created_at', { ascending: false })\r\n            .limit(limit);\r\n\r\n        if (error) throw error;\r\n\r\n        return { success: true, data };\r\n    } catch (error: any) {\r\n        return { error: error.message };\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;IAQsB,oBAAA,WAAA,GAAA,IAAA,kOAAA,EAAA,8CAAA,4LAAA,EAAA,KAAA,GAAA,gNAAA,EAAA"}},
    {"offset": {"line": 623, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/actions/admin/grantAccess.ts"],"sourcesContent":["'use server';\r\n\r\nimport { createClient } from '@/lib/supabase/server';\r\nimport { revalidatePath } from 'next/cache';\r\n\r\n/**\r\n * Grant course access to a student with optional expiry\r\n */\r\nexport async function grantCourseAccess(data: {\r\n    userId: string;\r\n    courseId: string;\r\n    expiresAt?: Date | null;\r\n    notes?: string;\r\n}) {\r\n    const supabase = await createClient();\r\n\r\n    // Get admin user\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) return { error: 'Unauthorized' };\r\n\r\n    const { data: profile } = await supabase\r\n        .from('profiles')\r\n        .select('role')\r\n        .eq('id', user.id)\r\n        .single();\r\n\r\n    if (profile?.role !== 'admin') {\r\n        return { error: 'Admin access required' };\r\n    }\r\n\r\n    try {\r\n        // Check if enrollment already exists\r\n        const { data: existing } = await supabase\r\n            .from('enrollments')\r\n            .select('id, status, expires_at')\r\n            .eq('user_id', data.userId)\r\n            .eq('course_id', data.courseId)\r\n            .single();\r\n\r\n        let enrollment;\r\n\r\n        if (existing) {\r\n            // Update existing enrollment\r\n            const { data: updated, error } = await supabase\r\n                .from('enrollments')\r\n                .update({\r\n                    status: 'active',\r\n                    expires_at: data.expiresAt || null,\r\n                    granted_by: user.id,\r\n                    granted_at: new Date().toISOString(),\r\n                    grant_type: 'manual'\r\n                })\r\n                .eq('id', existing.id)\r\n                .select()\r\n                .single();\r\n\r\n            if (error) throw error;\r\n            enrollment = updated;\r\n\r\n            // Log the modification\r\n            await supabase.rpc('log_enrollment_action', {\r\n                p_action: 'modified',\r\n                p_performed_by: user.id,\r\n                p_enrollment_id: existing.id,\r\n                p_previous_expiry: existing.expires_at,\r\n                p_new_expiry: data.expiresAt || null,\r\n                p_notes: data.notes || 'Access modified by admin'\r\n            });\r\n        } else {\r\n            // Create new enrollment\r\n            const { data: newEnrollment, error } = await supabase\r\n                .from('enrollments')\r\n                .insert({\r\n                    user_id: data.userId,\r\n                    course_id: data.courseId,\r\n                    status: 'active',\r\n                    expires_at: data.expiresAt || null,\r\n                    granted_by: user.id,\r\n                    granted_at: new Date().toISOString(),\r\n                    grant_type: 'manual'\r\n                })\r\n                .select()\r\n                .single();\r\n\r\n            if (error) throw error;\r\n            enrollment = newEnrollment;\r\n\r\n            // Log the grant\r\n            await supabase.rpc('log_enrollment_action', {\r\n                p_action: 'granted',\r\n                p_performed_by: user.id,\r\n                p_enrollment_id: newEnrollment.id,\r\n                p_new_expiry: data.expiresAt || null,\r\n                p_notes: data.notes || 'Access granted by admin'\r\n            });\r\n        }\r\n\r\n        revalidatePath('/admin/students');\r\n        return { success: true, data: enrollment };\r\n    } catch (error: any) {\r\n        return { error: error.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Grant test series access to a student\r\n */\r\nexport async function grantTestSeriesAccess(data: {\r\n    userId: string;\r\n    testSeriesId: string;\r\n    expiresAt?: Date | null;\r\n    notes?: string;\r\n}) {\r\n    const supabase = await createClient();\r\n\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) return { error: 'Unauthorized' };\r\n\r\n    const { data: profile } = await supabase\r\n        .from('profiles')\r\n        .select('role')\r\n        .eq('id', user.id)\r\n        .single();\r\n\r\n    if (profile?.role !== 'admin') {\r\n        return { error: 'Admin access required' };\r\n    }\r\n\r\n    try {\r\n        // Check if enrollment already exists\r\n        const { data: existing } = await supabase\r\n            .from('enrollments')\r\n            .select('id, expires_at')\r\n            .eq('user_id', data.userId)\r\n            .eq('course_id', data.testSeriesId)\r\n            .single();\r\n\r\n        let enrollment;\r\n\r\n        if (existing) {\r\n            // Update existing\r\n            const { data: updated, error } = await supabase\r\n                .from('enrollments')\r\n                .update({\r\n                    expires_at: data.expiresAt || null,\r\n                    granted_by: user.id,\r\n                    granted_at: new Date().toISOString(),\r\n                    grant_type: 'manual'\r\n                })\r\n                .eq('id', existing.id)\r\n                .select()\r\n                .single();\r\n\r\n            if (error) throw error;\r\n            enrollment = updated;\r\n\r\n            // Log\r\n            await supabase.rpc('log_enrollment_action', {\r\n                p_action: 'modified',\r\n                p_performed_by: user.id,\r\n                p_enrollment_id: existing.id,\r\n                p_previous_expiry: existing.expires_at,\r\n                p_new_expiry: data.expiresAt || null,\r\n                p_notes: data.notes || 'Test series access modified'\r\n            });\r\n        } else {\r\n            // Create new\r\n            const { data: newEnrollment, error } = await supabase\r\n                .from('enrollments')\r\n                .insert({\r\n                    user_id: data.userId,\r\n                    course_id: data.testSeriesId,\r\n                    expires_at: data.expiresAt || null,\r\n                    granted_by: user.id,\r\n                    granted_at: new Date().toISOString(),\r\n                    grant_type: 'manual',\r\n                    status: 'active'\r\n                })\r\n                .select()\r\n                .single();\r\n\r\n            if (error) throw error;\r\n            enrollment = newEnrollment;\r\n\r\n            // Log\r\n            await supabase.rpc('log_enrollment_action', {\r\n                p_action: 'granted',\r\n                p_performed_by: user.id,\r\n                p_enrollment_id: newEnrollment.id,\r\n                p_new_expiry: data.expiresAt || null,\r\n                p_notes: data.notes || 'Test series access granted'\r\n            });\r\n        }\r\n\r\n        revalidatePath('/admin/students');\r\n        return { success: true, data: enrollment };\r\n    } catch (error: any) {\r\n        return { error: error.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Revoke course or test series access\r\n */\r\nexport async function revokeAccess(data: {\r\n    enrollmentId: string;\r\n    type: 'course';\r\n    reason: string;\r\n}) {\r\n    const supabase = await createClient();\r\n\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) return { error: 'Unauthorized' };\r\n\r\n    try {\r\n        if (data.type === 'course') {\r\n            const { error } = await supabase\r\n                .from('enrollments')\r\n                .update({ status: 'refunded' }) // Using 'refunded' to indicate revoked\r\n                .eq('id', data.enrollmentId);\r\n\r\n            if (error) throw error;\r\n\r\n            // Log\r\n            await supabase.rpc('log_enrollment_action', {\r\n                p_action: 'revoked',\r\n                p_performed_by: user.id,\r\n                p_enrollment_id: data.enrollmentId,\r\n                p_notes: data.reason\r\n            });\r\n        } else {\r\n            const { error } = await supabase\r\n                .from('enrollments')\r\n                .update({ status: 'refunded' })\r\n                .eq('id', data.enrollmentId);\r\n\r\n            if (error) throw error;\r\n\r\n            // Log\r\n            await supabase.rpc('log_enrollment_action', {\r\n                p_action: 'revoked',\r\n                p_performed_by: user.id,\r\n                p_enrollment_id: data.enrollmentId,\r\n                p_notes: data.reason\r\n            });\r\n        }\r\n\r\n        revalidatePath('/admin/students');\r\n        return { success: true };\r\n    } catch (error: any) {\r\n        return { error: error.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Extend access expiry date\r\n */\r\nexport async function extendAccess(data: {\r\n    enrollmentId: string;\r\n    type: 'course';\r\n    newExpiryDate: Date;\r\n    notes?: string;\r\n}) {\r\n    const supabase = await createClient();\r\n\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) return { error: 'Unauthorized' };\r\n\r\n    console.log('[extendAccess] Starting update:', {\r\n        enrollmentId: data.enrollmentId,\r\n        type: data.type,\r\n        newExpiryDate: data.newExpiryDate,\r\n        isoDate: data.newExpiryDate.toISOString()\r\n    });\r\n\r\n    try {\r\n        let previousExpiry;\r\n        let updateError;\r\n\r\n        if (data.type === 'course') {\r\n            // Get current enrollment\r\n            const { data: existing, error: fetchError } = await supabase\r\n                .from('enrollments')\r\n                .select('expires_at, user_id')\r\n                .eq('id', data.enrollmentId)\r\n                .single();\r\n\r\n            if (fetchError) {\r\n                console.error('[extendAccess] Error fetching enrollment:', fetchError);\r\n                throw new Error(`Failed to find enrollment: ${fetchError.message}`);\r\n            }\r\n\r\n            console.log('[extendAccess] Current enrollment:', existing);\r\n            previousExpiry = existing?.expires_at;\r\n\r\n            // Update the expiry date\r\n            const { data: updated, error } = await supabase\r\n                .from('enrollments')\r\n                .update({\r\n                    expires_at: data.newExpiryDate.toISOString(),\r\n                    updated_at: new Date().toISOString()\r\n                })\r\n                .eq('id', data.enrollmentId)\r\n                .select();\r\n\r\n            updateError = error;\r\n            console.log('[extendAccess] Update result:', { updated, error });\r\n\r\n            if (error) throw error;\r\n\r\n            if (!updated || updated.length === 0) {\r\n                throw new Error('No rows were updated. Enrollment may not exist.');\r\n            }\r\n\r\n            // Verify the update\r\n            const { data: verified } = await supabase\r\n                .from('enrollments')\r\n                .select('expires_at')\r\n                .eq('id', data.enrollmentId)\r\n                .single();\r\n\r\n            console.log('[extendAccess] Verified expiry after update:', verified);\r\n\r\n            if (!verified?.expires_at) {\r\n                throw new Error('Update succeeded but expires_at is still null');\r\n            }\r\n\r\n            // Log the action\r\n            await supabase.rpc('log_enrollment_action', {\r\n                p_action: 'extended',\r\n                p_performed_by: user.id,\r\n                p_enrollment_id: data.enrollmentId,\r\n                p_previous_expiry: previousExpiry,\r\n                p_new_expiry: data.newExpiryDate.toISOString(),\r\n                p_notes: data.notes || 'Access period extended'\r\n            });\r\n        } else {\r\n            // Test series enrollment\r\n            const { data: existing, error: fetchError } = await supabase\r\n                .from('enrollments')\r\n                .select('expires_at, user_id')\r\n                .eq('id', data.enrollmentId)\r\n                .single();\r\n\r\n            if (fetchError) {\r\n                console.error('[extendAccess] Error fetching test series enrollment:', fetchError);\r\n                throw new Error(`Failed to find test series enrollment: ${fetchError.message}`);\r\n            }\r\n\r\n            console.log('[extendAccess] Current test series enrollment:', existing);\r\n            previousExpiry = existing?.expires_at;\r\n\r\n            const { data: updated, error } = await supabase\r\n                .from('enrollments')\r\n                .update({\r\n                    expires_at: data.newExpiryDate.toISOString(),\r\n                    updated_at: new Date().toISOString()\r\n                })\r\n                .eq('id', data.enrollmentId)\r\n                .select();\r\n\r\n            updateError = error;\r\n            console.log('[extendAccess] Test series update result:', { updated, error });\r\n\r\n            if (error) throw error;\r\n\r\n            if (!updated || updated.length === 0) {\r\n                throw new Error('No rows were updated. Test series enrollment may not exist.');\r\n            }\r\n\r\n            // Verify the update\r\n            const { data: verified } = await supabase\r\n                .from('enrollments')\r\n                .select('expires_at')\r\n                .eq('id', data.enrollmentId)\r\n                .single();\r\n\r\n            console.log('[extendAccess] Verified test series expiry after update:', verified);\r\n\r\n            if (!verified?.expires_at) {\r\n                throw new Error('Update succeeded but expires_at is still null');\r\n            }\r\n\r\n            // Log the action\r\n            await supabase.rpc('log_enrollment_action', {\r\n                p_action: 'extended',\r\n                p_performed_by: user.id,\r\n                p_enrollment_id: data.enrollmentId,\r\n                p_previous_expiry: previousExpiry,\r\n                p_new_expiry: data.newExpiryDate.toISOString(),\r\n                p_notes: data.notes || 'Access period extended'\r\n            });\r\n        }\r\n\r\n        console.log('[extendAccess] Update completed successfully');\r\n        revalidatePath('/admin/students');\r\n        return { success: true };\r\n    } catch (error: any) {\r\n        console.error('[extendAccess] Error:', error);\r\n        return { error: error.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Get expiring subscriptions (within specified days)\r\n */\r\nexport async function getExpiringSubscriptions(daysAhead: number = 7) {\r\n    const supabase = await createClient();\r\n\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) return { error: 'Unauthorized' };\r\n\r\n    try {\r\n        const { data, error } = await supabase\r\n            .from('expiring_enrollments_view')\r\n            .select('*')\r\n            .lte('days_until_expiry', daysAhead)\r\n            .order('days_until_expiry', { ascending: true });\r\n\r\n        if (error) throw error;\r\n\r\n        return { success: true, data };\r\n    } catch (error: any) {\r\n        return { error: error.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Get recent enrollment logs\r\n */\r\nexport async function getRecentAccessLogs(limit: number = 50) {\r\n    const supabase = await createClient();\r\n\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) return { error: 'Unauthorized' };\r\n\r\n    try {\r\n        const { data, error } = await supabase\r\n            .from('enrollment_logs')\r\n            .select(`\r\n        *,\r\n        performed_by_profile:profiles!enrollment_logs_performed_by_fkey (\r\n          id,\r\n          full_name,\r\n          email\r\n        )\r\n      `)\r\n            .order('created_at', { ascending: false })\r\n            .limit(limit);\r\n\r\n        if (error) throw error;\r\n\r\n        return { success: true, data };\r\n    } catch (error: any) {\r\n        return { error: error.message };\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;IA2GsB,wBAAA,WAAA,GAAA,IAAA,kOAAA,EAAA,8CAAA,4LAAA,EAAA,KAAA,GAAA,gNAAA,EAAA"}},
    {"offset": {"line": 638, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/components/admin/GrantAccessDialog.tsx"],"sourcesContent":["'use client';\r\n\r\nimport { useState, useEffect } from 'react';\r\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from '@/components/ui/dialog';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Label } from '@/components/ui/label';\r\nimport { Textarea } from '@/components/ui/textarea';\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\r\nimport { searchStudents } from '@/actions/admin/students';\r\nimport { grantCourseAccess, grantTestSeriesAccess } from '@/actions/admin/grantAccess';\r\nimport { toast } from 'sonner';\r\nimport { Loader2, Gift, Search, Calendar, BookOpen, Trophy, Sparkles } from 'lucide-react';\r\nimport { cn } from '@/lib/utils';\r\n\r\ninterface GrantAccessDialogProps {\r\n    open: boolean;\r\n    onOpenChange: (open: boolean) => void;\r\n    onSuccess?: () => void;\r\n    courses?: Array<{ id: string; title: string; thumbnail_url?: string }>;\r\n    testSeries?: Array<{ id: string; title: string }>;\r\n}\r\n\r\nexport function GrantAccessDialog({ open, onOpenChange, onSuccess, courses = [], testSeries = [] }: GrantAccessDialogProps) {\r\n    const [loading, setLoading] = useState(false);\r\n    const [searchQuery, setSearchQuery] = useState('');\r\n    const [searchResults, setSearchResults] = useState<any[]>([]);\r\n    const [searching, setSearching] = useState(false);\r\n\r\n    const [formData, setFormData] = useState({\r\n        selectedStudent: null as any,\r\n        accessType: 'course' as 'course' | 'test_series',\r\n        selectedCourse: '',\r\n        selectedTestSeries: '',\r\n        expiryDate: '',\r\n        notes: ''\r\n    });\r\n\r\n    // Search students as user types\r\n    useEffect(() => {\r\n        const searchDebounce = setTimeout(async () => {\r\n            if (searchQuery.length >= 2) {\r\n                setSearching(true);\r\n                const result = await searchStudents(searchQuery);\r\n                if (result.success) {\r\n                    setSearchResults(result.data || []);\r\n                }\r\n                setSearching(false);\r\n            } else {\r\n                setSearchResults([]);\r\n            }\r\n        }, 300);\r\n\r\n        return () => clearTimeout(searchDebounce);\r\n    }, [searchQuery]);\r\n\r\n    const handleSubmit = async (e: React.FormEvent) => {\r\n        e.preventDefault();\r\n\r\n        if (!formData.selectedStudent) {\r\n            toast.error('Please select a student');\r\n            return;\r\n        }\r\n\r\n        if (formData.accessType === 'course' && !formData.selectedCourse) {\r\n            toast.error('Please select a course');\r\n            return;\r\n        }\r\n\r\n        if (formData.accessType === 'test_series' && !formData.selectedTestSeries) {\r\n            toast.error('Please select a test series');\r\n            return;\r\n        }\r\n\r\n        setLoading(true);\r\n\r\n        try {\r\n            const expiryDate = formData.expiryDate ? new Date(formData.expiryDate) : null;\r\n\r\n            let result;\r\n            if (formData.accessType === 'course') {\r\n                result = await grantCourseAccess({\r\n                    userId: formData.selectedStudent.id,\r\n                    courseId: formData.selectedCourse,\r\n                    expiresAt: expiryDate,\r\n                    notes: formData.notes\r\n                });\r\n            } else {\r\n                result = await grantTestSeriesAccess({\r\n                    userId: formData.selectedStudent.id,\r\n                    testSeriesId: formData.selectedTestSeries,\r\n                    expiresAt: expiryDate,\r\n                    notes: formData.notes\r\n                });\r\n            }\r\n\r\n            if (result.error) {\r\n                toast.error(result.error);\r\n            } else {\r\n                toast.success('Access granted successfully! 🎉');\r\n                onOpenChange(false);\r\n                resetForm();\r\n                onSuccess?.();\r\n            }\r\n        } catch (error: any) {\r\n            toast.error(error.message || 'Failed to grant access');\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const resetForm = () => {\r\n        setFormData({\r\n            selectedStudent: null,\r\n            accessType: 'course',\r\n            selectedCourse: '',\r\n            selectedTestSeries: '',\r\n            expiryDate: '',\r\n            notes: ''\r\n        });\r\n        setSearchQuery('');\r\n        setSearchResults([]);\r\n    };\r\n\r\n    return (\r\n        <Dialog open={open} onOpenChange={(open) => { onOpenChange(open); if (!open) resetForm(); }}>\r\n            <DialogContent className=\"sm:max-w-[600px] max-h-[85vh] flex flex-col bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-800 p-0 gap-0\">\r\n                {/* Decorative gradient header */}\r\n                <div className=\"absolute top-0 left-0 right-0 h-1 bg-linear-to-r from-emerald-500 via-teal-500 to-cyan-500 rounded-t-lg\" />\r\n\r\n                {/* Fixed Header */}\r\n                <DialogHeader className=\"space-y-3 pt-6 px-6 pb-4 shrink-0\">\r\n                    <div className=\"flex items-center gap-3\">\r\n                        <div className=\"p-2.5 rounded-xl bg-linear-to-br from-emerald-500 to-teal-600 shadow-lg shadow-emerald-200 dark:shadow-none\">\r\n                            <Gift className=\"w-5 h-5 text-white\" />\r\n                        </div>\r\n                        <div>\r\n                            <DialogTitle className=\"text-2xl font-bold tracking-tight text-slate-900 dark:text-white\">\r\n                                Grant Access\r\n                            </DialogTitle>\r\n                            <DialogDescription className=\"text-sm text-slate-500 dark:text-slate-400\">\r\n                                Assign a course or test series to a student\r\n                            </DialogDescription>\r\n                        </div>\r\n                    </div>\r\n                </DialogHeader>\r\n\r\n                {/* Scrollable Form Content */}\r\n                <div className=\"flex-1 overflow-y-auto px-6 min-h-0\">\r\n                    <form id=\"grantAccessForm\" onSubmit={handleSubmit} className=\"space-y-4 pb-4\">\r\n                        {/* Student Search */}\r\n                        <div className=\"space-y-2\">\r\n                            <Label htmlFor=\"studentSearch\" className=\"text-sm font-semibold text-slate-700 dark:text-slate-300 flex items-center gap-2\">\r\n                                <Search className=\"w-4 h-4 text-emerald-500\" />\r\n                                Search Student\r\n                            </Label>\r\n                            <div className=\"relative\">\r\n                                <Input\r\n                                    id=\"studentSearch\"\r\n                                    type=\"text\"\r\n                                    placeholder=\"Type name or email...\"\r\n                                    value={searchQuery}\r\n                                    onChange={(e) => setSearchQuery(e.target.value)}\r\n                                    className=\"h-11 bg-slate-50 dark:bg-slate-800/50 border-slate-200 dark:border-slate-700 pr-10\"\r\n                                />\r\n                                {searching && (\r\n                                    <Loader2 className=\"absolute right-3 top-3 w-5 h-5 animate-spin text-slate-400\" />\r\n                                )}\r\n                            </div>\r\n\r\n                            {/* Search Results */}\r\n                            {searchResults.length > 0 && (\r\n                                <div className=\"border border-slate-200 dark:border-slate-700 rounded-lg overflow-hidden bg-white dark:bg-slate-800 shadow-lg max-h-48 overflow-y-auto\">\r\n                                    {searchResults.map((student) => (\r\n                                        <button\r\n                                            key={student.id}\r\n                                            type=\"button\"\r\n                                            onClick={() => {\r\n                                                setFormData({ ...formData, selectedStudent: student });\r\n                                                setSearchQuery(student.full_name || student.email);\r\n                                                setSearchResults([]);\r\n                                            }}\r\n                                            className={cn(\r\n                                                \"w-full text-left px-4 py-3 hover:bg-emerald-50 dark:hover:bg-emerald-500/10 transition-colors border-b border-slate-100 dark:border-slate-700 last:border-0\",\r\n                                                formData.selectedStudent?.id === student.id && \"bg-emerald-50 dark:bg-emerald-500/10\"\r\n                                            )}\r\n                                        >\r\n                                            <div className=\"font-medium text-slate-900 dark:text-white\">{student.full_name || 'No name'}</div>\r\n                                            <div className=\"text-sm text-slate-500 dark:text-slate-400\">{student.email}</div>\r\n                                        </button>\r\n                                    ))}\r\n                                </div>\r\n                            )}\r\n\r\n                            {/* Selected Student Display */}\r\n                            {formData.selectedStudent && searchResults.length === 0 && (\r\n                                <div className=\"p-3 rounded-lg bg-emerald-50 dark:bg-emerald-500/10 border border-emerald-200 dark:border-emerald-500/20\">\r\n                                    <div className=\"flex items-center gap-2\">\r\n                                        <Sparkles className=\"w-4 h-4 text-emerald-600 dark:text-emerald-400\" />\r\n                                        <div className=\"flex-1\">\r\n                                            <div className=\"font-semibold text-emerald-900 dark:text-emerald-100\">{formData.selectedStudent.full_name}</div>\r\n                                            <div className=\"text-xs text-emerald-600 dark:text-emerald-400\">{formData.selectedStudent.email}</div>\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n\r\n                        {/* Access Type */}\r\n                        <div className=\"space-y-2\">\r\n                            <Label className=\"text-sm font-semibold text-slate-700 dark:text-slate-300\">Access Type</Label>\r\n                            <div className=\"grid grid-cols-2 gap-3\">\r\n                                <button\r\n                                    type=\"button\"\r\n                                    onClick={() => setFormData({ ...formData, accessType: 'course', selectedTestSeries: '' })}\r\n                                    className={cn(\r\n                                        \"p-4 rounded-xl border-2 transition-all text-left\",\r\n                                        formData.accessType === 'course'\r\n                                            ? \"border-blue-500 bg-blue-50 dark:bg-blue-500/10\"\r\n                                            : \"border-slate-200 dark:border-slate-700 hover:border-blue-300\"\r\n                                    )}\r\n                                >\r\n                                    <BookOpen className={cn(\"w-5 h-5 mb-2\", formData.accessType === 'course' ? \"text-blue-500\" : \"text-slate-400\")} />\r\n                                    <div className=\"font-semibold text-sm text-slate-900 dark:text-white\">Course</div>\r\n                                    <div className=\"text-xs text-slate-500 dark:text-slate-400\">Grant course enrollment</div>\r\n                                </button>\r\n\r\n                                <button\r\n                                    type=\"button\"\r\n                                    onClick={() => setFormData({ ...formData, accessType: 'test_series', selectedCourse: '' })}\r\n                                    className={cn(\r\n                                        \"p-4 rounded-xl border-2 transition-all text-left\",\r\n                                        formData.accessType === 'test_series'\r\n                                            ? \"border-purple-500 bg-purple-50 dark:bg-purple-500/10\"\r\n                                            : \"border-slate-200 dark:border-slate-700 hover:border-purple-300\"\r\n                                    )}\r\n                                >\r\n                                    <Trophy className={cn(\"w-5 h-5 mb-2\", formData.accessType === 'test_series' ? \"text-purple-500\" : \"text-slate-400\")} />\r\n                                    <div className=\"font-semibold text-sm text-slate-900 dark:text-white\">Test Series</div>\r\n                                    <div className=\"text-xs text-slate-500 dark:text-slate-400\">Grant test series access</div>\r\n                                </button>\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Course/Test Series Selection */}\r\n                        {formData.accessType === 'course' ? (\r\n                            <div className=\"space-y-2\">\r\n                                <Label className=\"text-sm font-semibold text-slate-700 dark:text-slate-300\">Select Course</Label>\r\n                                <Select value={formData.selectedCourse} onValueChange={(value) => setFormData({ ...formData, selectedCourse: value })}>\r\n                                    <SelectTrigger className=\"h-11 bg-slate-50 dark:bg-slate-800/50\">\r\n                                        <SelectValue placeholder=\"Choose a course...\" />\r\n                                    </SelectTrigger>\r\n                                    <SelectContent>\r\n                                        {courses.map((course) => (\r\n                                            <SelectItem key={course.id} value={course.id}>\r\n                                                {course.title}\r\n                                            </SelectItem>\r\n                                        ))}\r\n                                    </SelectContent>\r\n                                </Select>\r\n                            </div>\r\n                        ) : (\r\n                            <div className=\"space-y-2\">\r\n                                <Label className=\"text-sm font-semibold text-slate-700 dark:text-slate-300\">Select Test Series</Label>\r\n                                <Select value={formData.selectedTestSeries} onValueChange={(value) => setFormData({ ...formData, selectedTestSeries: value })}>\r\n                                    <SelectTrigger className=\"h-11 bg-slate-50 dark:bg-slate-800/50\">\r\n                                        <SelectValue placeholder=\"Choose a test series...\" />\r\n                                    </SelectTrigger>\r\n                                    <SelectContent>\r\n                                        {testSeries.map((series) => (\r\n                                            <SelectItem key={series.id} value={series.id}>\r\n                                                {series.title}\r\n                                            </SelectItem>\r\n                                        ))}\r\n                                    </SelectContent>\r\n                                </Select>\r\n                            </div>\r\n                        )}\r\n\r\n                        {/* Expiry Date */}\r\n                        <div className=\"space-y-2\">\r\n                            <Label htmlFor=\"expiryDate\" className=\"text-sm font-semibold text-slate-700 dark:text-slate-300 flex items-center gap-2\">\r\n                                <Calendar className=\"w-4 h-4 text-amber-500\" />\r\n                                Expiry Date (Optional)\r\n                            </Label>\r\n                            <Input\r\n                                id=\"expiryDate\"\r\n                                type=\"date\"\r\n                                value={formData.expiryDate}\r\n                                onChange={(e) => setFormData({ ...formData, expiryDate: e.target.value })}\r\n                                min={new Date().toISOString().split('T')[0]}\r\n                                className=\"h-11 bg-slate-50 dark:bg-slate-800/50 border-slate-200 dark:border-slate-700\"\r\n                            />\r\n                            <p className=\"text-xs text-slate-500 dark:text-slate-400\">Leave empty for lifetime access</p>\r\n                        </div>\r\n\r\n                        {/* Notes */}\r\n                        <div className=\"space-y-2\">\r\n                            <Label htmlFor=\"notes\" className=\"text-sm font-semibold text-slate-700 dark:text-slate-300\">Notes (Optional)</Label>\r\n                            <Textarea\r\n                                id=\"notes\"\r\n                                value={formData.notes}\r\n                                onChange={(e) => setFormData({ ...formData, notes: e.target.value })}\r\n                                placeholder=\"Reason for granting access...\"\r\n                                className=\"min-h-[80px] bg-slate-50 dark:bg-slate-800/50 border-slate-200 dark:border-slate-700\"\r\n                            />\r\n                        </div>\r\n                    </form>\r\n                </div>\r\n\r\n                {/* Sticky Footer with Buttons */}\r\n                <div className=\"border-t border-slate-200 dark:border-slate-800 px-6 py-4 bg-slate-50 dark:bg-slate-900/50 shrink-0\">\r\n                    <div className=\"flex gap-3\">\r\n                        <Button\r\n                            type=\"button\"\r\n                            variant=\"outline\"\r\n                            onClick={() => onOpenChange(false)}\r\n                            className=\"flex-1 h-11 border-slate-200 dark:border-slate-700\"\r\n                            disabled={loading}\r\n                        >\r\n                            Cancel\r\n                        </Button>\r\n                        <Button\r\n                            type=\"submit\"\r\n                            form=\"grantAccessForm\"\r\n                            disabled={loading || !formData.selectedStudent}\r\n                            className=\"flex-1 h-11 bg-linear-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700 text-white shadow-lg shadow-emerald-200 dark:shadow-none transition-all\"\r\n                        >\r\n                            {loading ? (\r\n                                <>\r\n                                    <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\r\n                                    Granting...\r\n                                </>\r\n                            ) : (\r\n                                <>\r\n                                    <Gift className=\"w-4 h-4 mr-2\" />\r\n                                    Grant Access\r\n                                </>\r\n                            )}\r\n                        </Button>\r\n                    </div>\r\n                </div>\r\n            </DialogContent>\r\n        </Dialog>\r\n    );\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1374, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/actions/admin/grantAccess.ts"],"sourcesContent":["'use server';\r\n\r\nimport { createClient } from '@/lib/supabase/server';\r\nimport { revalidatePath } from 'next/cache';\r\n\r\n/**\r\n * Grant course access to a student with optional expiry\r\n */\r\nexport async function grantCourseAccess(data: {\r\n    userId: string;\r\n    courseId: string;\r\n    expiresAt?: Date | null;\r\n    notes?: string;\r\n}) {\r\n    const supabase = await createClient();\r\n\r\n    // Get admin user\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) return { error: 'Unauthorized' };\r\n\r\n    const { data: profile } = await supabase\r\n        .from('profiles')\r\n        .select('role')\r\n        .eq('id', user.id)\r\n        .single();\r\n\r\n    if (profile?.role !== 'admin') {\r\n        return { error: 'Admin access required' };\r\n    }\r\n\r\n    try {\r\n        // Check if enrollment already exists\r\n        const { data: existing } = await supabase\r\n            .from('enrollments')\r\n            .select('id, status, expires_at')\r\n            .eq('user_id', data.userId)\r\n            .eq('course_id', data.courseId)\r\n            .single();\r\n\r\n        let enrollment;\r\n\r\n        if (existing) {\r\n            // Update existing enrollment\r\n            const { data: updated, error } = await supabase\r\n                .from('enrollments')\r\n                .update({\r\n                    status: 'active',\r\n                    expires_at: data.expiresAt || null,\r\n                    granted_by: user.id,\r\n                    granted_at: new Date().toISOString(),\r\n                    grant_type: 'manual'\r\n                })\r\n                .eq('id', existing.id)\r\n                .select()\r\n                .single();\r\n\r\n            if (error) throw error;\r\n            enrollment = updated;\r\n\r\n            // Log the modification\r\n            await supabase.rpc('log_enrollment_action', {\r\n                p_action: 'modified',\r\n                p_performed_by: user.id,\r\n                p_enrollment_id: existing.id,\r\n                p_previous_expiry: existing.expires_at,\r\n                p_new_expiry: data.expiresAt || null,\r\n                p_notes: data.notes || 'Access modified by admin'\r\n            });\r\n        } else {\r\n            // Create new enrollment\r\n            const { data: newEnrollment, error } = await supabase\r\n                .from('enrollments')\r\n                .insert({\r\n                    user_id: data.userId,\r\n                    course_id: data.courseId,\r\n                    status: 'active',\r\n                    expires_at: data.expiresAt || null,\r\n                    granted_by: user.id,\r\n                    granted_at: new Date().toISOString(),\r\n                    grant_type: 'manual'\r\n                })\r\n                .select()\r\n                .single();\r\n\r\n            if (error) throw error;\r\n            enrollment = newEnrollment;\r\n\r\n            // Log the grant\r\n            await supabase.rpc('log_enrollment_action', {\r\n                p_action: 'granted',\r\n                p_performed_by: user.id,\r\n                p_enrollment_id: newEnrollment.id,\r\n                p_new_expiry: data.expiresAt || null,\r\n                p_notes: data.notes || 'Access granted by admin'\r\n            });\r\n        }\r\n\r\n        revalidatePath('/admin/students');\r\n        return { success: true, data: enrollment };\r\n    } catch (error: any) {\r\n        return { error: error.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Grant test series access to a student\r\n */\r\nexport async function grantTestSeriesAccess(data: {\r\n    userId: string;\r\n    testSeriesId: string;\r\n    expiresAt?: Date | null;\r\n    notes?: string;\r\n}) {\r\n    const supabase = await createClient();\r\n\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) return { error: 'Unauthorized' };\r\n\r\n    const { data: profile } = await supabase\r\n        .from('profiles')\r\n        .select('role')\r\n        .eq('id', user.id)\r\n        .single();\r\n\r\n    if (profile?.role !== 'admin') {\r\n        return { error: 'Admin access required' };\r\n    }\r\n\r\n    try {\r\n        // Check if enrollment already exists\r\n        const { data: existing } = await supabase\r\n            .from('enrollments')\r\n            .select('id, expires_at')\r\n            .eq('user_id', data.userId)\r\n            .eq('course_id', data.testSeriesId)\r\n            .single();\r\n\r\n        let enrollment;\r\n\r\n        if (existing) {\r\n            // Update existing\r\n            const { data: updated, error } = await supabase\r\n                .from('enrollments')\r\n                .update({\r\n                    expires_at: data.expiresAt || null,\r\n                    granted_by: user.id,\r\n                    granted_at: new Date().toISOString(),\r\n                    grant_type: 'manual'\r\n                })\r\n                .eq('id', existing.id)\r\n                .select()\r\n                .single();\r\n\r\n            if (error) throw error;\r\n            enrollment = updated;\r\n\r\n            // Log\r\n            await supabase.rpc('log_enrollment_action', {\r\n                p_action: 'modified',\r\n                p_performed_by: user.id,\r\n                p_enrollment_id: existing.id,\r\n                p_previous_expiry: existing.expires_at,\r\n                p_new_expiry: data.expiresAt || null,\r\n                p_notes: data.notes || 'Test series access modified'\r\n            });\r\n        } else {\r\n            // Create new\r\n            const { data: newEnrollment, error } = await supabase\r\n                .from('enrollments')\r\n                .insert({\r\n                    user_id: data.userId,\r\n                    course_id: data.testSeriesId,\r\n                    expires_at: data.expiresAt || null,\r\n                    granted_by: user.id,\r\n                    granted_at: new Date().toISOString(),\r\n                    grant_type: 'manual',\r\n                    status: 'active'\r\n                })\r\n                .select()\r\n                .single();\r\n\r\n            if (error) throw error;\r\n            enrollment = newEnrollment;\r\n\r\n            // Log\r\n            await supabase.rpc('log_enrollment_action', {\r\n                p_action: 'granted',\r\n                p_performed_by: user.id,\r\n                p_enrollment_id: newEnrollment.id,\r\n                p_new_expiry: data.expiresAt || null,\r\n                p_notes: data.notes || 'Test series access granted'\r\n            });\r\n        }\r\n\r\n        revalidatePath('/admin/students');\r\n        return { success: true, data: enrollment };\r\n    } catch (error: any) {\r\n        return { error: error.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Revoke course or test series access\r\n */\r\nexport async function revokeAccess(data: {\r\n    enrollmentId: string;\r\n    type: 'course';\r\n    reason: string;\r\n}) {\r\n    const supabase = await createClient();\r\n\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) return { error: 'Unauthorized' };\r\n\r\n    try {\r\n        if (data.type === 'course') {\r\n            const { error } = await supabase\r\n                .from('enrollments')\r\n                .update({ status: 'refunded' }) // Using 'refunded' to indicate revoked\r\n                .eq('id', data.enrollmentId);\r\n\r\n            if (error) throw error;\r\n\r\n            // Log\r\n            await supabase.rpc('log_enrollment_action', {\r\n                p_action: 'revoked',\r\n                p_performed_by: user.id,\r\n                p_enrollment_id: data.enrollmentId,\r\n                p_notes: data.reason\r\n            });\r\n        } else {\r\n            const { error } = await supabase\r\n                .from('enrollments')\r\n                .update({ status: 'refunded' })\r\n                .eq('id', data.enrollmentId);\r\n\r\n            if (error) throw error;\r\n\r\n            // Log\r\n            await supabase.rpc('log_enrollment_action', {\r\n                p_action: 'revoked',\r\n                p_performed_by: user.id,\r\n                p_enrollment_id: data.enrollmentId,\r\n                p_notes: data.reason\r\n            });\r\n        }\r\n\r\n        revalidatePath('/admin/students');\r\n        return { success: true };\r\n    } catch (error: any) {\r\n        return { error: error.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Extend access expiry date\r\n */\r\nexport async function extendAccess(data: {\r\n    enrollmentId: string;\r\n    type: 'course';\r\n    newExpiryDate: Date;\r\n    notes?: string;\r\n}) {\r\n    const supabase = await createClient();\r\n\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) return { error: 'Unauthorized' };\r\n\r\n    console.log('[extendAccess] Starting update:', {\r\n        enrollmentId: data.enrollmentId,\r\n        type: data.type,\r\n        newExpiryDate: data.newExpiryDate,\r\n        isoDate: data.newExpiryDate.toISOString()\r\n    });\r\n\r\n    try {\r\n        let previousExpiry;\r\n        let updateError;\r\n\r\n        if (data.type === 'course') {\r\n            // Get current enrollment\r\n            const { data: existing, error: fetchError } = await supabase\r\n                .from('enrollments')\r\n                .select('expires_at, user_id')\r\n                .eq('id', data.enrollmentId)\r\n                .single();\r\n\r\n            if (fetchError) {\r\n                console.error('[extendAccess] Error fetching enrollment:', fetchError);\r\n                throw new Error(`Failed to find enrollment: ${fetchError.message}`);\r\n            }\r\n\r\n            console.log('[extendAccess] Current enrollment:', existing);\r\n            previousExpiry = existing?.expires_at;\r\n\r\n            // Update the expiry date\r\n            const { data: updated, error } = await supabase\r\n                .from('enrollments')\r\n                .update({\r\n                    expires_at: data.newExpiryDate.toISOString(),\r\n                    updated_at: new Date().toISOString()\r\n                })\r\n                .eq('id', data.enrollmentId)\r\n                .select();\r\n\r\n            updateError = error;\r\n            console.log('[extendAccess] Update result:', { updated, error });\r\n\r\n            if (error) throw error;\r\n\r\n            if (!updated || updated.length === 0) {\r\n                throw new Error('No rows were updated. Enrollment may not exist.');\r\n            }\r\n\r\n            // Verify the update\r\n            const { data: verified } = await supabase\r\n                .from('enrollments')\r\n                .select('expires_at')\r\n                .eq('id', data.enrollmentId)\r\n                .single();\r\n\r\n            console.log('[extendAccess] Verified expiry after update:', verified);\r\n\r\n            if (!verified?.expires_at) {\r\n                throw new Error('Update succeeded but expires_at is still null');\r\n            }\r\n\r\n            // Log the action\r\n            await supabase.rpc('log_enrollment_action', {\r\n                p_action: 'extended',\r\n                p_performed_by: user.id,\r\n                p_enrollment_id: data.enrollmentId,\r\n                p_previous_expiry: previousExpiry,\r\n                p_new_expiry: data.newExpiryDate.toISOString(),\r\n                p_notes: data.notes || 'Access period extended'\r\n            });\r\n        } else {\r\n            // Test series enrollment\r\n            const { data: existing, error: fetchError } = await supabase\r\n                .from('enrollments')\r\n                .select('expires_at, user_id')\r\n                .eq('id', data.enrollmentId)\r\n                .single();\r\n\r\n            if (fetchError) {\r\n                console.error('[extendAccess] Error fetching test series enrollment:', fetchError);\r\n                throw new Error(`Failed to find test series enrollment: ${fetchError.message}`);\r\n            }\r\n\r\n            console.log('[extendAccess] Current test series enrollment:', existing);\r\n            previousExpiry = existing?.expires_at;\r\n\r\n            const { data: updated, error } = await supabase\r\n                .from('enrollments')\r\n                .update({\r\n                    expires_at: data.newExpiryDate.toISOString(),\r\n                    updated_at: new Date().toISOString()\r\n                })\r\n                .eq('id', data.enrollmentId)\r\n                .select();\r\n\r\n            updateError = error;\r\n            console.log('[extendAccess] Test series update result:', { updated, error });\r\n\r\n            if (error) throw error;\r\n\r\n            if (!updated || updated.length === 0) {\r\n                throw new Error('No rows were updated. Test series enrollment may not exist.');\r\n            }\r\n\r\n            // Verify the update\r\n            const { data: verified } = await supabase\r\n                .from('enrollments')\r\n                .select('expires_at')\r\n                .eq('id', data.enrollmentId)\r\n                .single();\r\n\r\n            console.log('[extendAccess] Verified test series expiry after update:', verified);\r\n\r\n            if (!verified?.expires_at) {\r\n                throw new Error('Update succeeded but expires_at is still null');\r\n            }\r\n\r\n            // Log the action\r\n            await supabase.rpc('log_enrollment_action', {\r\n                p_action: 'extended',\r\n                p_performed_by: user.id,\r\n                p_enrollment_id: data.enrollmentId,\r\n                p_previous_expiry: previousExpiry,\r\n                p_new_expiry: data.newExpiryDate.toISOString(),\r\n                p_notes: data.notes || 'Access period extended'\r\n            });\r\n        }\r\n\r\n        console.log('[extendAccess] Update completed successfully');\r\n        revalidatePath('/admin/students');\r\n        return { success: true };\r\n    } catch (error: any) {\r\n        console.error('[extendAccess] Error:', error);\r\n        return { error: error.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Get expiring subscriptions (within specified days)\r\n */\r\nexport async function getExpiringSubscriptions(daysAhead: number = 7) {\r\n    const supabase = await createClient();\r\n\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) return { error: 'Unauthorized' };\r\n\r\n    try {\r\n        const { data, error } = await supabase\r\n            .from('expiring_enrollments_view')\r\n            .select('*')\r\n            .lte('days_until_expiry', daysAhead)\r\n            .order('days_until_expiry', { ascending: true });\r\n\r\n        if (error) throw error;\r\n\r\n        return { success: true, data };\r\n    } catch (error: any) {\r\n        return { error: error.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Get recent enrollment logs\r\n */\r\nexport async function getRecentAccessLogs(limit: number = 50) {\r\n    const supabase = await createClient();\r\n\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) return { error: 'Unauthorized' };\r\n\r\n    try {\r\n        const { data, error } = await supabase\r\n            .from('enrollment_logs')\r\n            .select(`\r\n        *,\r\n        performed_by_profile:profiles!enrollment_logs_performed_by_fkey (\r\n          id,\r\n          full_name,\r\n          email\r\n        )\r\n      `)\r\n            .order('created_at', { ascending: false })\r\n            .limit(limit);\r\n\r\n        if (error) throw error;\r\n\r\n        return { success: true, data };\r\n    } catch (error: any) {\r\n        return { error: error.message };\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;IAiQsB,eAAA,WAAA,GAAA,IAAA,kOAAA,EAAA,8CAAA,4LAAA,EAAA,KAAA,GAAA,gNAAA,EAAA"}},
    {"offset": {"line": 1389, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/components/admin/EditExpiryDialog.tsx"],"sourcesContent":["'use client';\r\n\r\nimport { useState } from 'react';\r\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from '@/components/ui/dialog';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Label } from '@/components/ui/label';\r\nimport { Textarea } from '@/components/ui/textarea';\r\nimport { extendAccess } from '@/actions/admin/grantAccess';\r\nimport { toast } from 'sonner';\r\nimport { Loader2, Calendar, AlertCircle } from 'lucide-react';\r\n\r\ninterface EditExpiryDialogProps {\r\n    open: boolean;\r\n    onOpenChange: (open: boolean) => void;\r\n    onSuccess?: () => void;\r\n    enrollment: {\r\n        id: string;\r\n        type: 'course';\r\n        studentName: string;\r\n        courseName: string;\r\n        currentExpiry: string | null;\r\n    } | null;\r\n}\r\n\r\nexport function EditExpiryDialog({ open, onOpenChange, onSuccess, enrollment }: EditExpiryDialogProps) {\r\n    const [loading, setLoading] = useState(false);\r\n    const [formData, setFormData] = useState({\r\n        newExpiryDate: '',\r\n        notes: ''\r\n    });\r\n\r\n    const handleSubmit = async (e: React.FormEvent) => {\r\n        e.preventDefault();\r\n\r\n        if (!enrollment || !formData.newExpiryDate) {\r\n            toast.error('Please select an expiry date');\r\n            return;\r\n        }\r\n\r\n        setLoading(true);\r\n\r\n        try {\r\n            const result = await extendAccess({\r\n                enrollmentId: enrollment.id,\r\n                type: enrollment.type,\r\n                newExpiryDate: new Date(formData.newExpiryDate),\r\n                notes: formData.notes || 'Expiry date updated by admin'\r\n            });\r\n\r\n            if (result.error) {\r\n                toast.error(result.error);\r\n            } else {\r\n                toast.success('Expiry date updated successfully! 🎉');\r\n                onOpenChange(false);\r\n                setFormData({ newExpiryDate: '', notes: '' });\r\n\r\n                // Reload student data for instant UI update\r\n                onSuccess?.();\r\n            }\r\n        } catch (error: any) {\r\n            toast.error(error.message || 'Failed to update expiry date');\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <Dialog open={open} onOpenChange={onOpenChange}>\r\n            <DialogContent className=\"sm:max-w-[500px] bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-800\">\r\n                {/* Decorative gradient header */}\r\n                <div className=\"absolute top-0 left-0 right-0 h-1 bg-linear-to-r from-amber-500 via-orange-500 to-red-500\" />\r\n\r\n                <DialogHeader className=\"space-y-3 pt-2\">\r\n                    <div className=\"flex items-center gap-3\">\r\n                        <div className=\"p-2.5 rounded-xl bg-linear-to-br from-amber-500 to-orange-600 shadow-lg shadow-amber-200 dark:shadow-none\">\r\n                            <Calendar className=\"w-5 h-5 text-white\" />\r\n                        </div>\r\n                        <div>\r\n                            <DialogTitle className=\"text-2xl font-bold tracking-tight text-slate-900 dark:text-white\">\r\n                                Edit Expiry Date\r\n                            </DialogTitle>\r\n                            <DialogDescription className=\"text-sm text-slate-500 dark:text-slate-400\">\r\n                                Update subscription expiry for enrolled student\r\n                            </DialogDescription>\r\n                        </div>\r\n                    </div>\r\n                </DialogHeader>\r\n\r\n                {enrollment && (\r\n                    <form onSubmit={handleSubmit} className=\"space-y-5 mt-4\">\r\n                        {/* Student Info */}\r\n                        <div className=\"p-4 rounded-lg bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700\">\r\n                            <div className=\"space-y-1\">\r\n                                <p className=\"text-sm font-semibold text-slate-900 dark:text-white\">\r\n                                    {enrollment.studentName}\r\n                                </p>\r\n                                <p className=\"text-xs text-slate-500 dark:text-slate-400\">\r\n                                    {enrollment.courseName}\r\n                                </p>\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Current Expiry */}\r\n                        {enrollment.currentExpiry && (\r\n                            <div className=\"flex items-center gap-2 p-3 rounded-lg bg-amber-50 dark:bg-amber-500/10 border border-amber-200 dark:border-amber-500/20\">\r\n                                <AlertCircle className=\"w-4 h-4 text-amber-600 dark:text-amber-400\" />\r\n                                <div className=\"flex-1\">\r\n                                    <p className=\"text-xs font-semibold text-amber-900 dark:text-amber-100\">Current Expiry</p>\r\n                                    <p className=\"text-xs text-amber-600 dark:text-amber-400\">\r\n                                        {new Date(enrollment.currentExpiry).toLocaleDateString('en-US', {\r\n                                            year: 'numeric',\r\n                                            month: 'long',\r\n                                            day: 'numeric'\r\n                                        })}\r\n                                    </p>\r\n                                </div>\r\n                            </div>\r\n                        )}\r\n\r\n                        {/* New Expiry Date */}\r\n                        <div className=\"space-y-2\">\r\n                            <Label htmlFor=\"newExpiryDate\" className=\"text-sm font-semibold text-slate-700 dark:text-slate-300 flex items-center gap-2\">\r\n                                <Calendar className=\"w-4 h-4 text-amber-500\" />\r\n                                New Expiry Date\r\n                            </Label>\r\n                            <Input\r\n                                id=\"newExpiryDate\"\r\n                                type=\"date\"\r\n                                value={formData.newExpiryDate}\r\n                                onChange={(e) => setFormData({ ...formData, newExpiryDate: e.target.value })}\r\n                                min={new Date().toISOString().split('T')[0]}\r\n                                required\r\n                                className=\"h-11 bg-slate-50 dark:bg-slate-800/50 border-slate-200 dark:border-slate-700\"\r\n                            />\r\n                            <p className=\"text-xs text-slate-500 dark:text-slate-400\">\r\n                                Select a future date or clear for lifetime access\r\n                            </p>\r\n                        </div>\r\n\r\n                        {/* Notes */}\r\n                        <div className=\"space-y-2\">\r\n                            <Label htmlFor=\"notes\" className=\"text-sm font-semibold text-slate-700 dark:text-slate-300\">\r\n                                Notes (Optional)\r\n                            </Label>\r\n                            <Textarea\r\n                                id=\"notes\"\r\n                                value={formData.notes}\r\n                                onChange={(e) => setFormData({ ...formData, notes: e.target.value })}\r\n                                placeholder=\"Reason for updating expiry date...\"\r\n                                className=\"min-h-[80px] bg-slate-50 dark:bg-slate-800/50 border-slate-200 dark:border-slate-700\"\r\n                            />\r\n                        </div>\r\n\r\n                        {/* Action Buttons */}\r\n                        <div className=\"flex gap-3 pt-2\">\r\n                            <Button\r\n                                type=\"button\"\r\n                                variant=\"outline\"\r\n                                onClick={() => onOpenChange(false)}\r\n                                className=\"flex-1 h-11 border-slate-200 dark:border-slate-700\"\r\n                                disabled={loading}\r\n                            >\r\n                                Cancel\r\n                            </Button>\r\n                            <Button\r\n                                type=\"submit\"\r\n                                disabled={loading}\r\n                                className=\"flex-1 h-11 bg-linear-to-r from-amber-600 to-orange-600 hover:from-amber-700 hover:to-orange-700 text-white shadow-lg shadow-amber-200 dark:shadow-none transition-all\"\r\n                            >\r\n                                {loading ? (\r\n                                    <>\r\n                                        <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\r\n                                        Updating...\r\n                                    </>\r\n                                ) : (\r\n                                    <>\r\n                                        <Calendar className=\"w-4 h-4 mr-2\" />\r\n                                        Update Expiry\r\n                                    </>\r\n                                )}\r\n                            </Button>\r\n                        </div>\r\n                    </form>\r\n                )}\r\n            </DialogContent>\r\n        </Dialog>\r\n    );\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1760, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/components/admin/StatusBadges.tsx"],"sourcesContent":["'use client';\r\n\r\nimport { cn } from \"@/lib/utils\";\r\n\r\ninterface StatusBadgeProps {\r\n    status: 'active' | 'expired' | 'draft' | 'published' | 'archived' | 'pending' | 'completed' | 'refunded';\r\n    className?: string;\r\n    size?: 'sm' | 'md' | 'lg';\r\n}\r\n\r\nconst statusConfig = {\r\n    active: {\r\n        label: 'Active',\r\n        bg: 'bg-emerald-50 dark:bg-emerald-500/10',\r\n        border: 'border-emerald-200 dark:border-emerald-500/20',\r\n        text: 'text-emerald-700 dark:text-emerald-400',\r\n        dot: 'bg-emerald-500'\r\n    },\r\n    expired: {\r\n        label: 'Expired',\r\n        bg: 'bg-red-50 dark:bg-red-500/10',\r\n        border: 'border-red-200 dark:border-red-500/20',\r\n        text: 'text-red-700 dark:text-red-400',\r\n        dot: 'bg-red-500'\r\n    },\r\n    draft: {\r\n        label: 'Draft',\r\n        bg: 'bg-slate-50 dark:bg-slate-500/10',\r\n        border: 'border-slate-200 dark:border-slate-500/20',\r\n        text: 'text-slate-700 dark:text-slate-400',\r\n        dot: 'bg-slate-500'\r\n    },\r\n    published: {\r\n        label: 'Published',\r\n        bg: 'bg-blue-50 dark:bg-blue-500/10',\r\n        border: 'border-blue-200 dark:border-blue-500/20',\r\n        text: 'text-blue-700 dark:text-blue-400',\r\n        dot: 'bg-blue-500'\r\n    },\r\n    archived: {\r\n        label: 'Archived',\r\n        bg: 'bg-amber-50 dark:bg-amber-500/10',\r\n        border: 'border-amber-200 dark:border-amber-500/20',\r\n        text: 'text-amber-700 dark:text-amber-400',\r\n        dot: 'bg-amber-500'\r\n    },\r\n    pending: {\r\n        label: 'Pending',\r\n        bg: 'bg-yellow-50 dark:bg-yellow-500/10',\r\n        border: 'border-yellow-200 dark:border-yellow-500/20',\r\n        text: 'text-yellow-700 dark:text-yellow-400',\r\n        dot: 'bg-yellow-500'\r\n    },\r\n    completed: {\r\n        label: 'Completed',\r\n        bg: 'bg-purple-50 dark:bg-purple-500/10',\r\n        border: 'border-purple-200 dark:border-purple-500/20',\r\n        text: 'text-purple-700 dark:text-purple-400',\r\n        dot: 'bg-purple-500'\r\n    },\r\n    refunded: {\r\n        label: 'Revoked',\r\n        bg: 'bg-orange-50 dark:bg-orange-500/10',\r\n        border: 'border-orange-200 dark:border-orange-500/20',\r\n        text: 'text-orange-700 dark:text-orange-400',\r\n        dot: 'bg-orange-500'\r\n    }\r\n};\r\n\r\nconst sizeConfig = {\r\n    sm: 'text-[10px] px-2 py-0.5 gap-1',\r\n    md: 'text-xs px-3 py-1 gap-1.5',\r\n    lg: 'text-sm px-4 py-1.5 gap-2'\r\n};\r\n\r\nexport function StatusBadge({ status, className, size = 'md' }: StatusBadgeProps) {\r\n    const config = statusConfig[status];\r\n\r\n    return (\r\n        <div className={cn(\r\n            \"inline-flex items-center font-bold uppercase tracking-wider rounded-full border transition-colors\",\r\n            config.bg,\r\n            config.border,\r\n            config.text,\r\n            sizeConfig[size],\r\n            className\r\n        )}>\r\n            <div className={cn(\"w-1.5 h-1.5 rounded-full animate-pulse\", config.dot)} />\r\n            {config.label}\r\n        </div>\r\n    );\r\n}\r\n\r\ninterface ExpiryBadgeProps {\r\n    expiresAt: string | Date | null;\r\n    className?: string;\r\n}\r\n\r\nexport function ExpiryBadge({ expiresAt, className }: ExpiryBadgeProps) {\r\n    if (!expiresAt) {\r\n        return (\r\n            <div className={cn(\r\n                \"inline-flex items-center text-[10px] font-black uppercase tracking-widest px-2.5 py-1 rounded-full\",\r\n                \"bg-indigo-50 dark:bg-indigo-500/10 border border-indigo-200 dark:border-indigo-500/20\",\r\n                \"text-indigo-700 dark:text-indigo-400\",\r\n                className\r\n            )}>\r\n                ∞ Lifetime\r\n            </div>\r\n        );\r\n    }\r\n\r\n    const expiryDate = new Date(expiresAt);\r\n    const now = new Date();\r\n    const daysUntilExpiry = Math.ceil((expiryDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));\r\n\r\n    if (daysUntilExpiry < 0) {\r\n        return <StatusBadge status=\"expired\" size=\"sm\" className={className} />;\r\n    }\r\n\r\n    if (daysUntilExpiry <= 3) {\r\n        return (\r\n            <div className={cn(\r\n                \"inline-flex items-center text-[10px] font-black uppercase tracking-widest px-2.5 py-1 rounded-full gap-1\",\r\n                \"bg-red-50 dark:bg-red-500/10 border border-red-200 dark:border-red-500/20\",\r\n                \"text-red-700 dark:text-red-400 animate-pulse\",\r\n                className\r\n            )}>\r\n                <span className=\"relative flex h-2 w-2\">\r\n                    <span className=\"animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75\"></span>\r\n                    <span className=\"relative inline-flex rounded-full h-2 w-2 bg-red-500\"></span>\r\n                </span>\r\n                {daysUntilExpiry}d left\r\n            </div>\r\n        );\r\n    }\r\n\r\n    if (daysUntilExpiry <= 7) {\r\n        return (\r\n            <div className={cn(\r\n                \"inline-flex items-center text-[10px] font-black uppercase tracking-widest px-2.5 py-1 rounded-full gap-1\",\r\n                \"bg-amber-50 dark:bg-amber-500/10 border border-amber-200 dark:border-amber-500/20\",\r\n                \"text-amber-700 dark:text-amber-400\",\r\n                className\r\n            )}>\r\n                <div className=\"w-1.5 h-1.5 rounded-full bg-amber-500\" />\r\n                {daysUntilExpiry}d left\r\n            </div>\r\n        );\r\n    }\r\n\r\n    if (daysUntilExpiry <= 30) {\r\n        return (\r\n            <div className={cn(\r\n                \"inline-flex items-center text-[10px] font-bold uppercase tracking-wider px-2.5 py-1 rounded-full\",\r\n                \"bg-green-50 dark:bg-green-500/10 border border-green-200 dark:border-green-500/20\",\r\n                \"text-green-700 dark:text-green-400\",\r\n                className\r\n            )}>\r\n                {daysUntilExpiry}d\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className={cn(\r\n            \"inline-flex items-center text-[10px] font-bold uppercase tracking-wider px-2.5 py-1 rounded-full\",\r\n            \"bg-slate-50 dark:bg-slate-500/10 border border-slate-200 dark:border-slate-500/20\",\r\n            \"text-slate-600 dark:text-slate-400\",\r\n            className\r\n        )}>\r\n            {expiryDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}\r\n        </div>\r\n    );\r\n}\r\n\r\ninterface GrantTypeBadgeProps {\r\n    grantType: 'manual' | 'payment' | 'free';\r\n    className?: string;\r\n}\r\n\r\nexport function GrantTypeBadge({ grantType, className }: GrantTypeBadgeProps) {\r\n    const config = {\r\n        manual: {\r\n            label: '👤 Admin',\r\n            bg: 'bg-violet-50 dark:bg-violet-500/10',\r\n            border: 'border-violet-200 dark:border-violet-500/20',\r\n            text: 'text-violet-700 dark:text-violet-400'\r\n        },\r\n        payment: {\r\n            label: '💳 Paid',\r\n            bg: 'bg-emerald-50 dark:bg-emerald-500/10',\r\n            border: 'border-emerald-200 dark:border-emerald-500/20',\r\n            text: 'text-emerald-700 dark:text-emerald-400'\r\n        },\r\n        free: {\r\n            label: '🎁 Free',\r\n            bg: 'bg-sky-50 dark:bg-sky-500/10',\r\n            border: 'border-sky-200 dark:border-sky-500/20',\r\n            text: 'text-sky-700 dark:text-sky-400'\r\n        }\r\n    };\r\n\r\n    const c = config[grantType];\r\n\r\n    return (\r\n        <div className={cn(\r\n            \"inline-flex items-center text-[10px] font-bold uppercase tracking-wider px-2 py-0.5 rounded-md border\",\r\n            c.bg,\r\n            c.border,\r\n            c.text,\r\n            className\r\n        )}>\r\n            {c.label}\r\n        </div>\r\n    );\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1997, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/components/admin/StudentManagementClient.tsx"],"sourcesContent":["'use client';\r\n\r\nimport { useEffect, useState, useMemo } from 'react';\r\nimport { useAdminStudents } from '@/hooks/admin/useAdminStudents';\r\nimport { AddStudentDialog } from '@/components/admin/AddStudentDialog';\r\nimport { GrantAccessDialog } from '@/components/admin/GrantAccessDialog';\r\nimport { EditExpiryDialog } from '@/components/admin/EditExpiryDialog';\r\nimport { StatusBadge, ExpiryBadge, GrantTypeBadge } from '@/components/admin/StatusBadges';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\r\nimport { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';\r\nimport { Card } from '@/components/ui/card';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport {\r\n    UserPlus,\r\n    Gift,\r\n    Search,\r\n    Users,\r\n    TrendingUp,\r\n    AlertCircle,\r\n    BookOpen,\r\n    Trophy,\r\n    Loader2,\r\n    MoreVertical,\r\n    Edit,\r\n    Eye,\r\n    Calendar\r\n} from 'lucide-react';\r\nimport { cn } from '@/lib/utils';\r\nimport { SmartLink } from '@/components/SmartLink';\r\nimport Link from 'next/link';\r\n\r\ninterface Student {\r\n    id: string;\r\n    email: string;\r\n    full_name: string;\r\n    avatar_url?: string;\r\n    created_at: string;\r\n    enrollments: any[];\r\n    totalEnrollments: number;\r\n    expiringSoonCount: number;\r\n}\r\n\r\nexport default function StudentManagementClient({ courses, testSeries }: any) {\r\n    const [searchQuery, setSearchQuery] = useState('');\r\n    const [statusFilter, setStatusFilter] = useState<'all' | 'active' | 'expired'>('all');\r\n\r\n    const [addStudentOpen, setAddStudentOpen] = useState(false);\r\n    const [grantAccessOpen, setGrantAccessOpen] = useState(false);\r\n    const [editExpiryOpen, setEditExpiryOpen] = useState(false);\r\n    const [selectedEnrollment, setSelectedEnrollment] = useState<any>(null);\r\n\r\n    // ⚡ REACT QUERY: Managed fetching and caching\r\n    const { data: students = [], isLoading: loading, refetch } = useAdminStudents({\r\n        status: statusFilter\r\n    });\r\n\r\n    // Client-side filtering\r\n    const filteredStudents = useMemo(() => {\r\n        if (!searchQuery) return students;\r\n        return students.filter(s =>\r\n            s.full_name?.toLowerCase().includes(searchQuery.toLowerCase()) ||\r\n            s.email?.toLowerCase().includes(searchQuery.toLowerCase())\r\n        );\r\n    }, [searchQuery, students]);\r\n\r\n    // Stats\r\n    const totalStudents = students.length;\r\n    const activeStudents = students.filter(s => s.totalEnrollments > 0).length;\r\n    const expiringSoon = students.reduce((acc, s) => acc + s.expiringSoonCount, 0);\r\n\r\n    return (\r\n        <div className=\"min-h-screen bg-slate-50 dark:bg-slate-950 p-6\">\r\n            <div className=\"max-w-7xl mx-auto space-y-6\">\r\n                {/* Header */}\r\n                <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\r\n                    <div>\r\n                        <h1 className=\"text-3xl font-black tracking-tight text-slate-900 dark:text-white flex items-center gap-3\">\r\n                            <div className=\"p-2 rounded-xl bg-linear-to-br from-blue-500 to-indigo-600 shadow-lg shadow-blue-200 dark:shadow-none\">\r\n                                <Users className=\"w-6 h-6 text-white\" />\r\n                            </div>\r\n                            Student Management\r\n                        </h1>\r\n                        <p className=\"text-slate-600 dark:text-slate-400 mt-1\">Manage enrollments and grant access</p>\r\n                    </div>\r\n\r\n                    <div className=\"flex gap-3\">\r\n                        <Button\r\n                            onClick={() => setAddStudentOpen(true)}\r\n                            className=\"bg-linear-to-r from-violet-600 to-purple-600 hover:from-violet-700 hover:to-purple-700 shadow-lg shadow-violet-200 dark:shadow-none\"\r\n                        >\r\n                            <UserPlus className=\"w-4 h-4 mr-2\" />\r\n                            Add Student\r\n                        </Button>\r\n                        <Button\r\n                            onClick={() => setGrantAccessOpen(true)}\r\n                            className=\"bg-linear-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700 shadow-lg shadow-emerald-200 dark:shadow-none\"\r\n                        >\r\n                            <Gift className=\"w-4 h-4 mr-2\" />\r\n                            Grant Access\r\n                        </Button>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Stats Cards */}\r\n                <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n                    <Card className=\"p-5 bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-800 shadow-lg\">\r\n                        <div className=\"flex items-center gap-4\">\r\n                            <div className=\"p-3 rounded-xl bg-blue-50 dark:bg-blue-500/10 border border-blue-100 dark:border-blue-500/20\">\r\n                                <Users className=\"w-6 h-6 text-blue-600 dark:text-blue-400\" />\r\n                            </div>\r\n                            <div>\r\n                                <p className=\"text-sm font-semibold text-slate-500 dark:text-slate-400\">Total Students</p>\r\n                                <p className=\"text-2xl font-black text-slate-900 dark:text-white\">{totalStudents}</p>\r\n                            </div>\r\n                        </div>\r\n                    </Card>\r\n\r\n                    <Card className=\"p-5 bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-800 shadow-lg\">\r\n                        <div className=\"flex items-center gap-4\">\r\n                            <div className=\"p-3 rounded-xl bg-emerald-50 dark:bg-emerald-500/10 border border-emerald-100 dark:border-emerald-500/20\">\r\n                                <TrendingUp className=\"w-6 h-6 text-emerald-600 dark:text-emerald-400\" />\r\n                            </div>\r\n                            <div>\r\n                                <p className=\"text-sm font-semibold text-slate-500 dark:text-slate-400\">Active Enrollments</p>\r\n                                <p className=\"text-2xl font-black text-slate-900 dark:text-white\">{activeStudents}</p>\r\n                            </div>\r\n                        </div>\r\n                    </Card>\r\n\r\n                    <Card className=\"p-5 bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-800 shadow-lg\">\r\n                        <div className=\"flex items-center gap-4\">\r\n                            <div className=\"p-3 rounded-xl bg-amber-50 dark:bg-amber-500/10 border border-amber-100 dark:border-amber-500/20\">\r\n                                <AlertCircle className=\"w-6 h-6 text-amber-600 dark:text-amber-400\" />\r\n                            </div>\r\n                            <div>\r\n                                <p className=\"text-sm font-semibold text-slate-500 dark:text-slate-400\">Expiring Soon</p>\r\n                                <p className=\"text-2xl font-black text-slate-900 dark:text-white\">{expiringSoon}</p>\r\n                            </div>\r\n                        </div>\r\n                    </Card>\r\n                </div>\r\n\r\n                {/* Filters */}\r\n                <Card className=\"p-4 bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-800\">\r\n                    <div className=\"flex flex-col sm:flex-row gap-4\">\r\n                        <div className=\"flex-1 relative\">\r\n                            <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400\" />\r\n                            <Input\r\n                                placeholder=\"Search by name or email...\"\r\n                                value={searchQuery}\r\n                                onChange={(e) => setSearchQuery(e.target.value)}\r\n                                className=\"pl-10 h-11 bg-slate-50 dark:bg-slate-800/50\"\r\n                            />\r\n                        </div>\r\n                        <Select value={statusFilter} onValueChange={(v: any) => setStatusFilter(v)}>\r\n                            <SelectTrigger className=\"w-full sm:w-48 h-11\">\r\n                                <SelectValue />\r\n                            </SelectTrigger>\r\n                            <SelectContent>\r\n                                <SelectItem value=\"all\">All Students</SelectItem>\r\n                                <SelectItem value=\"active\">Active Only</SelectItem>\r\n                                <SelectItem value=\"expired\">Expired Only</SelectItem>\r\n                            </SelectContent>\r\n                        </Select>\r\n                    </div>\r\n                </Card>\r\n\r\n                {/* Students Table */}\r\n                <Card className=\"bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-800 overflow-hidden shadow-xl\">\r\n                    {loading ? (\r\n                        <div className=\"flex items-center justify-center py-20\">\r\n                            <Loader2 className=\"w-8 h-8 animate-spin text-slate-400\" />\r\n                        </div>\r\n                    ) : filteredStudents.length === 0 ? (\r\n                        <div className=\"flex flex-col items-center justify-center py-20 px-4\">\r\n                            <div className=\"p-4 rounded-full bg-slate-100 dark:bg-slate-800 mb-4\">\r\n                                <Users className=\"w-8 h-8 text-slate-400\" />\r\n                            </div>\r\n                            <p className=\"text-lg font-semibold text-slate-900 dark:text-white\">No students found</p>\r\n                            <p className=\"text-sm text-slate-500 dark:text-slate-400\">Try adjusting your filters or add a new student</p>\r\n                        </div>\r\n                    ) : (\r\n                        <div className=\"overflow-x-auto\">\r\n                            <table className=\"w-full\">\r\n                                <thead className=\"bg-slate-50 dark:bg-slate-800/50 border-b border-slate-200 dark:border-slate-800\">\r\n                                    <tr>\r\n                                        <th className=\"px-6 py-4 text-left text-xs font-black uppercase tracking-wider text-slate-600 dark:text-slate-400\">\r\n                                            Student\r\n                                        </th>\r\n                                        <th className=\"px-6 py-4 text-left text-xs font-black uppercase tracking-wider text-slate-600 dark:text-slate-400\">\r\n                                            Enrollments\r\n                                        </th>\r\n                                        <th className=\"px-6 py-4 text-left text-xs font-black uppercase tracking-wider text-slate-600 dark:text-slate-400\">\r\n                                            Status\r\n                                        </th>\r\n                                        <th className=\"px-6 py-4 text-right text-xs font-black uppercase tracking-wider text-slate-600 dark:text-slate-400\">\r\n                                            Actions\r\n                                        </th>\r\n                                    </tr>\r\n                                </thead>\r\n                                <tbody className=\"divide-y divide-slate-100 dark:divide-slate-800\">\r\n                                    {filteredStudents.map((student) => (\r\n                                        <tr key={student.id} className=\"hover:bg-slate-50 dark:hover:bg-slate-800/30 transition-colors\">\r\n                                            <td className=\"px-6 py-4\">\r\n                                                <div className=\"flex items-center gap-3\">\r\n                                                    <Avatar className=\"w-10 h-10 border-2 border-slate-200 dark:border-slate-700\">\r\n                                                        <AvatarImage src={student.avatar_url} />\r\n                                                        <AvatarFallback className=\"bg-linear-to-br from-violet-500 to-purple-600 text-white font-bold\">\r\n                                                            {student.full_name?.charAt(0) || student.email.charAt(0).toUpperCase()}\r\n                                                        </AvatarFallback>\r\n                                                    </Avatar>\r\n                                                    <div>\r\n                                                        <p className=\"font-semibold text-slate-900 dark:text-white\">\r\n                                                            {student.full_name || 'No Name'}\r\n                                                        </p>\r\n                                                        <p className=\"text-sm text-slate-500 dark:text-slate-400\">{student.email}</p>\r\n                                                    </div>\r\n                                                </div>\r\n                                            </td>\r\n                                            <td className=\"px-6 py-4\">\r\n                                                <div className=\"flex flex-wrap gap-2\">\r\n                                                    {student.enrollments.slice(0, 2).map((enrollment: any) => (\r\n                                                        <div key={enrollment.id} className=\"flex items-center gap-2\">\r\n                                                            <Badge variant=\"outline\" className=\"text-xs\">\r\n                                                                <BookOpen className=\"w-3 h-3 mr-1\" />\r\n                                                                {enrollment.courses?.title}\r\n                                                            </Badge>\r\n                                                            <ExpiryBadge expiresAt={enrollment.expires_at} />\r\n                                                            <Button\r\n                                                                variant=\"ghost\"\r\n                                                                size=\"sm\"\r\n                                                                className=\"h-6 w-6 p-0\"\r\n                                                                onClick={() => {\r\n                                                                    console.log('Edit button clicked!', {\r\n                                                                        enrollmentId: enrollment.id,\r\n                                                                        studentName: student.full_name || student.email,\r\n                                                                        courseName: enrollment.courses?.title,\r\n                                                                        currentExpiry: enrollment.expires_at\r\n                                                                    });\r\n                                                                    setSelectedEnrollment({\r\n                                                                        id: enrollment.id,\r\n                                                                        type: 'course',\r\n                                                                        studentName: student.full_name || student.email,\r\n                                                                        courseName: enrollment.courses?.title,\r\n                                                                        currentExpiry: enrollment.expires_at\r\n                                                                    });\r\n                                                                    setEditExpiryOpen(true);\r\n                                                                    console.log('Dialog should open now');\r\n                                                                }}\r\n                                                            >\r\n                                                                <Edit className=\"w-3 h-3\" />\r\n                                                            </Button>\r\n                                                        </div>\r\n                                                    ))}\r\n                                                    {student.totalEnrollments > 2 && (\r\n                                                        <Badge variant=\"secondary\" className=\"text-xs\">\r\n                                                            +{student.totalEnrollments - 2} more\r\n                                                        </Badge>\r\n                                                    )}\r\n                                                    {student.totalEnrollments === 0 && (\r\n                                                        <span className=\"text-sm text-slate-400\">No enrollments</span>\r\n                                                    )}\r\n                                                </div>\r\n                                            </td>\r\n                                            <td className=\"px-6 py-4\">\r\n                                                {student.expiringSoonCount > 0 && (\r\n                                                    <div className=\"flex items-center gap-2\">\r\n                                                        <AlertCircle className=\"w-4 h-4 text-amber-500\" />\r\n                                                        <span className=\"text-sm font-semibold text-amber-600 dark:text-amber-400\">\r\n                                                            {student.expiringSoonCount} expiring soon\r\n                                                        </span>\r\n                                                    </div>\r\n                                                )}\r\n                                                {student.totalEnrollments > 0 && student.expiringSoonCount === 0 && (\r\n                                                    <StatusBadge status=\"active\" size=\"sm\" />\r\n                                                )}\r\n                                            </td>\r\n                                            <td className=\"px-6 py-4 text-right\">\r\n                                                <SmartLink href={`/admin/students/${student.id}`}>\r\n                                                    <Button variant=\"ghost\" size=\"sm\" className=\"gap-2\">\r\n                                                        <Eye className=\"w-4 h-4\" />\r\n                                                        View\r\n                                                    </Button>\r\n                                                </SmartLink>\r\n                                            </td>\r\n                                        </tr>\r\n                                    ))}\r\n                                </tbody>\r\n                            </table>\r\n                        </div>\r\n                    )}\r\n                </Card>\r\n            </div>\r\n\r\n            {/* Modals */}\r\n            <AddStudentDialog\r\n                open={addStudentOpen}\r\n                onOpenChange={setAddStudentOpen}\r\n                onSuccess={() => refetch()}\r\n            />\r\n            <GrantAccessDialog\r\n                open={grantAccessOpen}\r\n                onOpenChange={setGrantAccessOpen}\r\n                onSuccess={() => refetch()}\r\n                courses={courses}\r\n                testSeries={testSeries}\r\n            />\r\n            <EditExpiryDialog\r\n                open={editExpiryOpen}\r\n                onOpenChange={setEditExpiryOpen}\r\n                onSuccess={() => refetch()}\r\n                enrollment={selectedEnrollment}\r\n            />\r\n        </div>\r\n    );\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2860, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/components/ui/skeleton.tsx"],"sourcesContent":["import { cn } from '@/lib/utils'\r\n\r\nfunction Skeleton({ className, ...props }: React.ComponentProps<'div'>) {\r\n  return (\r\n    <div\r\n      data-slot=\"skeleton\"\r\n      className={cn('bg-accent animate-pulse rounded-md', className)}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nexport { Skeleton }\r\n"],"names":[],"mappings":";;;;;AAAA;;;AAEA,SAAS,SAAS,EAAE,SAAS,EAAE,GAAG,OAAoC;IACpE,qBACE,kMAAC;QACC,aAAU;QACV,WAAW,IAAA,0HAAE,EAAC,sCAAsC;QACnD,GAAG,KAAK;;;;;;AAGf"}},
    {"offset": {"line": 2884, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/app/admin/dashboard/components/Loading.tsx"],"sourcesContent":["import { Skeleton } from \"@/components/ui/skeleton\"\r\n\r\nexport default function Loading() {\r\n  return (\r\n    <div className=\"p-6 space-y-6\">\r\n      {/* Header */}\r\n      <div className=\"flex items-center justify-between\">\r\n        <Skeleton className=\"h-8 w-48\" />\r\n        <div className=\"flex space-x-3\">\r\n          <Skeleton className=\"h-8 w-24\" />\r\n          <Skeleton className=\"h-8 w-24\" />\r\n        </div>\r\n      </div>\r\n\r\n      {/* Stats Cards */}\r\n      <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4\">\r\n        {[...Array(4)].map((_, i) => (\r\n          <div key={i} className=\"p-4 border rounded-lg space-y-3 shadow-sm\">\r\n            <Skeleton className=\"h-5 w-32\" />\r\n            <Skeleton className=\"h-8 w-20\" />\r\n            <Skeleton className=\"h-4 w-16\" />\r\n          </div>\r\n        ))}\r\n      </div>\r\n\r\n      {/* Charts */}\r\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6 mt-4\">\r\n        <div className=\"p-4 border rounded-lg shadow-sm\">\r\n          <Skeleton className=\"h-6 w-40 mb-3\" />\r\n          <Skeleton className=\"h-72 w-full\" />\r\n        </div>\r\n        <div className=\"p-4 border rounded-lg shadow-sm\">\r\n          <Skeleton className=\"h-6 w-40 mb-3\" />\r\n          <Skeleton className=\"h-72 w-full\" />\r\n        </div>\r\n      </div>\r\n\r\n      {/* Table Section */}\r\n      <div className=\"mt-6 border rounded-lg shadow-sm p-4 space-y-4\">\r\n        <Skeleton className=\"h-6 w-48\" />\r\n        {[...Array(5)].map((_, i) => (\r\n          <div key={i} className=\"flex justify-between items-center\">\r\n            <Skeleton className=\"h-5 w-1/4\" />\r\n            <Skeleton className=\"h-5 w-1/6\" />\r\n            <Skeleton className=\"h-5 w-1/6\" />\r\n            <Skeleton className=\"h-5 w-1/6\" />\r\n          </div>\r\n        ))}\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n"],"names":[],"mappings":";;;;;AAAA;;;AAEe,SAAS;IACtB,qBACE,kMAAC;QAAI,WAAU;;0BAEb,kMAAC;gBAAI,WAAU;;kCACb,kMAAC,iJAAQ;wBAAC,WAAU;;;;;;kCACpB,kMAAC;wBAAI,WAAU;;0CACb,kMAAC,iJAAQ;gCAAC,WAAU;;;;;;0CACpB,kMAAC,iJAAQ;gCAAC,WAAU;;;;;;;;;;;;;;;;;;0BAKxB,kMAAC;gBAAI,WAAU;0BACZ;uBAAI,MAAM;iBAAG,CAAC,GAAG,CAAC,CAAC,GAAG,kBACrB,kMAAC;wBAAY,WAAU;;0CACrB,kMAAC,iJAAQ;gCAAC,WAAU;;;;;;0CACpB,kMAAC,iJAAQ;gCAAC,WAAU;;;;;;0CACpB,kMAAC,iJAAQ;gCAAC,WAAU;;;;;;;uBAHZ;;;;;;;;;;0BASd,kMAAC;gBAAI,WAAU;;kCACb,kMAAC;wBAAI,WAAU;;0CACb,kMAAC,iJAAQ;gCAAC,WAAU;;;;;;0CACpB,kMAAC,iJAAQ;gCAAC,WAAU;;;;;;;;;;;;kCAEtB,kMAAC;wBAAI,WAAU;;0CACb,kMAAC,iJAAQ;gCAAC,WAAU;;;;;;0CACpB,kMAAC,iJAAQ;gCAAC,WAAU;;;;;;;;;;;;;;;;;;0BAKxB,kMAAC;gBAAI,WAAU;;kCACb,kMAAC,iJAAQ;wBAAC,WAAU;;;;;;oBACnB;2BAAI,MAAM;qBAAG,CAAC,GAAG,CAAC,CAAC,GAAG,kBACrB,kMAAC;4BAAY,WAAU;;8CACrB,kMAAC,iJAAQ;oCAAC,WAAU;;;;;;8CACpB,kMAAC,iJAAQ;oCAAC,WAAU;;;;;;8CACpB,kMAAC,iJAAQ;oCAAC,WAAU;;;;;;8CACpB,kMAAC,iJAAQ;oCAAC,WAAU;;;;;;;2BAJZ;;;;;;;;;;;;;;;;;AAUpB"}},
    {"offset": {"line": 3095, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/app/admin/students/page.tsx"],"sourcesContent":["\"use client\";\r\n\r\nimport { useEffect, useState } from \"react\";\r\nimport { createClient } from \"@/lib/supabase/client\";\r\nimport StudentManagementClient from \"@/components/admin/StudentManagementClient\";\r\nimport { useQuery } from \"@tanstack/react-query\";\r\nimport Loading from \"../dashboard/components/Loading\";\r\n\r\nconst supabase = createClient();\r\n\r\nexport default function StudentsPage() {\r\n  const [userId, setUserId] = useState<string | null>(null);\r\n\r\n  useEffect(() => {\r\n    supabase.auth.getUser().then(({ data }) => setUserId(data.user?.id || null));\r\n  }, []);\r\n\r\n  const { data: initialData, isLoading } = useQuery({\r\n    queryKey: [\"admin-students-init\", userId],\r\n    queryFn: async () => {\r\n      // Fetch courses (course_type = 'course')\r\n      const { data: courses } = await supabase\r\n        .from('courses')\r\n        .select('id, title, thumbnail_url, course_type')\r\n        .eq('course_type', 'course')\r\n        .eq('is_published', true)\r\n        .order('title', { ascending: true });\r\n\r\n      // Fetch test series (course_type = 'test_series')\r\n      const { data: testSeries } = await supabase\r\n        .from('courses')\r\n        .select('id, title, thumbnail_url, course_type')\r\n        .eq('course_type', 'test_series')\r\n        .eq('is_published', true)\r\n        .order('title', { ascending: true });\r\n\r\n      return { courses, testSeries };\r\n    },\r\n    enabled: !!userId,\r\n    staleTime: 1000 * 60 * 60, // 1 hour (courses/test series titles don't change often)\r\n  });\r\n\r\n  if (isLoading) return <Loading />;\r\n\r\n  return (\r\n    <StudentManagementClient\r\n      courses={initialData?.courses || []}\r\n      testSeries={initialData?.testSeries || []}\r\n    />\r\n  );\r\n}\r\n"],"names":[],"mappings":";;;;;AAEA;AACA;AACA;AACA;AACA;AANA;;;;;;;AAQA,MAAM,WAAW,IAAA,iJAAY;AAEd,SAAS;IACtB,MAAM,CAAC,QAAQ,UAAU,GAAG,IAAA,8KAAQ,EAAgB;IAEpD,IAAA,+KAAS,EAAC;QACR,SAAS,IAAI,CAAC,OAAO,GAAG,IAAI,CAAC,CAAC,EAAE,IAAI,EAAE,GAAK,UAAU,KAAK,IAAI,EAAE,MAAM;IACxE,GAAG,EAAE;IAEL,MAAM,EAAE,MAAM,WAAW,EAAE,SAAS,EAAE,GAAG,IAAA,+LAAQ,EAAC;QAChD,UAAU;YAAC;YAAuB;SAAO;QACzC,SAAS;YACP,yCAAyC;YACzC,MAAM,EAAE,MAAM,OAAO,EAAE,GAAG,MAAM,SAC7B,IAAI,CAAC,WACL,MAAM,CAAC,yCACP,EAAE,CAAC,eAAe,UAClB,EAAE,CAAC,gBAAgB,MACnB,KAAK,CAAC,SAAS;gBAAE,WAAW;YAAK;YAEpC,kDAAkD;YAClD,MAAM,EAAE,MAAM,UAAU,EAAE,GAAG,MAAM,SAChC,IAAI,CAAC,WACL,MAAM,CAAC,yCACP,EAAE,CAAC,eAAe,eAClB,EAAE,CAAC,gBAAgB,MACnB,KAAK,CAAC,SAAS;gBAAE,WAAW;YAAK;YAEpC,OAAO;gBAAE;gBAAS;YAAW;QAC/B;QACA,SAAS,CAAC,CAAC;QACX,WAAW,OAAO,KAAK;IACzB;IAEA,IAAI,WAAW,qBAAO,kMAAC,sKAAO;;;;;IAE9B,qBACE,kMAAC,kKAAuB;QACtB,SAAS,aAAa,WAAW,EAAE;QACnC,YAAY,aAAa,cAAc,EAAE;;;;;;AAG/C"}}]
}